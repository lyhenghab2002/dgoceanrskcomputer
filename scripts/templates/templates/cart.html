<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple E-commerce Cart</title>
    <link rel="stylesheet" href="/static/css/cart.css">
    <link rel="stylesheet" href="/static/css/payment_modal.css">
    <link rel="stylesheet" href="/static/css/sweet-alert.css">
    <script src="/static/js/sweet-alert.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .cart {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .product {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .product:last-child {
            border-bottom: none;
        }
        .product button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .product button:hover {
            background: #218838;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }
        .cart-item:hover {
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 0 -10px;
            padding: 20px 10px;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .cart-item-image {
            margin-right: 15px;
            flex-shrink: 0;
        }

        /* Product Type Badges */
        .product-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
            vertical-align: middle;
        }

        .badge-preorder {
            background: linear-gradient(135deg, #ff9500, #ff6b00);
            color: white;
            box-shadow: 0 2px 4px rgba(255, 149, 0, 0.3);
        }

        .badge-regular {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }

        .product-name-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
        }

        .product-name {
            font-weight: 500;
            color: #333;
            font-size: 16px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .quantity-controls button {
            background: #007bff;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .quantity-controls button:hover:not(:disabled) {
            background: #0056b3;
        }

        .quantity-controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .quantity-controls span {
            font-weight: 500;
            min-width: 60px;
            text-align: center;
        }

        .quantity-display {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
            height: fit-content;
        }

        .delete-btn:hover {
            background: #c82333;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .quantity-controls button:hover {
            background: #0056b3;
        }
        .quantity-controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        h2 {
            margin-top: 0;
        }
        #cart-count {
            font-weight: bold;
        }
        #buy-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px;
            width: 48%;
            border-radius: 4px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        #buy-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #buy-button:hover:not(:disabled) {
            background: #0056b3;
        }
        #back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px;
            width: 48%;
            border-radius: 4px;
            margin-top: 10px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-size: 14px;
        }
        #back-button:hover {
            background: #5a6268;
        }
        #cart-total {
            font-weight: bold;
            margin-top: 10px;
            text-align: right;
            display: none; /* Hide by default, show only when cart has items */
        }
        .cart-buttons {
            display: flex;
            justify-content: space-between;
        }

        /* Modal Styles - Modern Glassmorphism */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(0,0,0,0.4));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(10px);
            }
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            margin: 5% auto; 
            padding: 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 90%;
            max-width: 600px;
            border-radius: 20px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.25),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            transform: translateY(20px);
            animation: modalSlideIn 0.4s ease-out forwards;
        }
        
        @keyframes modalSlideIn {
            to {
                transform: translateY(0);
            }
        }
        .close-button {
            color: rgba(0, 0, 0, 0.6);
            float: right;
            font-size: 32px;
            font-weight: 300;
            position: absolute;
            top: 20px;
            right: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .close-button:hover,
        .close-button:focus {
            color: rgba(0, 0, 0, 0.8);
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        #customer-form label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        #customer-form input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        #customer-form button {
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            font-size: 16px;
        }
        #customer-form button:hover {
            background: #218838;
        }

        /* Address Section Styles */
        .address-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .address-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group.half-width {
            flex: 1;
        }

        .address-section h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        .address-section label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
            display: block;
        }

        .address-section input,
        .address-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .address-section input:focus,
        .address-section textarea:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .address-section textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* Collapsible Address Details */
        .address-essential {
            margin-bottom: 15px;
        }

        .address-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }

        .btn-outline-secondary {
            background: transparent;
            border: 1px solid #6c757d;
            color: #6c757d;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
        }

        .btn-outline-secondary i {
            margin-right: 4px;
        }

        /* Custom Save Address Button Styling */
        .btn-outline-success {
            background: transparent;
            border: 2px solid #007bff;
            color: #007bff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-outline-success:hover {
            background: #007bff;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn-outline-success i {
            margin-right: 4px;
        }

        /* Checkout Container Styles */
        .checkout-modal-content {
            max-width: 800px;
            width: 95%;
            padding: 40px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.85));
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
        }

        .checkout-step {
            display: none;
            animation: stepFadeIn 0.5s ease-out;
        }

        .checkout-step.active {
            display: block;
        }

        .checkout-step h2 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 20px 0;
            padding: 15px 0;
            border-radius: 12px;
            transition: all 0.3s ease;
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid transparent;
        }



        @keyframes stepFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .checkout-progress {
            display: flex;
            justify-content: space-between;
            margin: 30px 0 40px;
            padding: 0;
            position: relative;
        }

        .checkout-progress::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #e9ecef 0%, #e9ecef 100%);
            z-index: 1;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            margin: 0 8px;
            font-size: 14px;
            color: #6c757d;
            position: relative;
            z-index: 2;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .progress-step.completed {
            color: white !important;
        }

        .progress-step.active {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB) !important;
            color: #2196F3 !important;
            border-color: #2196F3 !important;
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
            transform: translateY(-2px);
        }
        
        .checkout-progress .progress-step.active {
            color: #2196F3 !important;
        }

        .progress-step.completed {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
            border-color: #28a745 !important;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin: 10px 0 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #2196F3 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }



        .checkout-form {
            margin: 30px 0;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid rgba(233, 236, 239, 0.8);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #2c3e50;
        }

        .form-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        .form-group input::placeholder {
            color: #95a5a6;
            opacity: 0.8;
        }

        .payment-options {
            margin: 30px 0;
        }

        /* Payment method selection styles removed - cart proceeds directly with KHQR */

        .payment-option {
            display: flex;
            align-items: center;
            padding: 25px;
            border: 2px solid rgba(233, 236, 239, 0.6);
            border-radius: 16px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
        }

        .payment-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .payment-option:hover:not(.selected) {
            border-color: #007bff;
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 123, 255, 0.15);
        }

        .payment-option:hover:not(.selected)::before {
            left: 100%;
        }

        .payment-option.selected {
            border-color: #007bff;
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.1), rgba(0, 86, 179, 0.05));
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
            transform: translateY(-2px);
        }

        .payment-option.selected:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
        }

        .payment-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .payment-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .payment-details {
            flex: 1;
        }

        .payment-details h3 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .payment-details p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .payment-radio input[type="radio"] {
            margin: 0;
        }

        .checkout-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 2px solid rgba(233, 236, 239, 0.3);
            gap: 20px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
            min-width: 140px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #c82333, #a71e2a);
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(220, 53, 69, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.4);
        }

        .order-summary {
            background: linear-gradient(135deg, rgba(248, 249, 250, 0.9), rgba(255, 255, 255, 0.8));
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .order-summary h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            letter-spacing: 1px;
        }

        .order-total {
            text-align: right;
            font-size: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(222, 226, 230, 0.5);
            font-weight: 700;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .checkout-progress {
                flex-direction: column;
                gap: 10px;
            }
            
            .progress-step {
                margin: 0 0 5px 0;
            }
        }

        /* Pre-fill notification styles */
        .prefill-notification {
            background: linear-gradient(135deg, rgba(212, 237, 218, 0.9), rgba(195, 230, 203, 0.8));
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(195, 230, 203, 0.6);
            border-radius: 16px;
            padding: 18px 22px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.15);
            border-left: 4px solid #28a745;
            animation: notificationSlideIn 0.5s ease-out;
        }

        @keyframes notificationSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .prefill-message {
            display: flex;
            align-items: center;
            color: #155724;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .prefill-message i {
            font-size: 18px;
            margin-right: 12px;
            background: rgba(40, 167, 69, 0.2);
            padding: 8px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Custom Notification Styles */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            animation: notificationSlideInRight 0.5s ease-out;
        }

        @keyframes notificationSlideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .custom-notification-content {
            display: flex;
            align-items: center;
            padding: 18px 22px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }



        .custom-notification-error .custom-notification-content {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.95), rgba(200, 35, 51, 0.9));
            border-color: rgba(220, 53, 69, 0.3);
        }

        .custom-notification-success .custom-notification-content {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.95), rgba(32, 201, 151, 0.9));
            border-color: rgba(40, 167, 69, 0.3);
        }

        .custom-notification-info .custom-notification-content {
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.95), rgba(0, 86, 179, 0.9));
            border-color: rgba(0, 123, 255, 0.3);
        }

        .custom-notification-icon {
            font-size: 20px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .custom-notification-message {
            color: white;
            font-size: 15px;
            font-weight: 600;
            flex: 1;
            letter-spacing: 0.3px;
        }

        .custom-notification-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            margin-left: 15px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .custom-notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .btn-outline-primary {
            background: transparent;
            color: #007bff;
            border: 1px solid #007bff;
            transition: all 0.2s ease;
        }

        .btn-outline-primary:hover {
            background: #007bff;
            color: white;
        }

        /* Custom Select Styling */
        .custom-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background-color: #ffffff;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .custom-select:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
        }

        .custom-select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .custom-select option {
            padding: 8px 12px;
            font-size: 14px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="cart">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Shopping Cart (<span id="cart-count">0</span> items)</h2>
                <button type="button" id="verify-payment-btn" class="verify-payment-btn" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                    <i class="fas fa-question-circle"></i> Need Help?
                </button>
            </div>
            <div id="cart-items"></div>
            <div id="cart-total">Total: $0.00</div>
            <div class="cart-buttons">
                <a href="{{ url_for('show_dashboard') }}" id="back-button">Browse Products</a>
                <button type="button" id="buy-button" disabled>Proceed to Checkout</button>
            </div>
        </div>
    </div>

    <!-- Login Required Modal -->
    <div id="login-required-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; margin: 10% auto; padding: 30px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <i class="fas fa-lock" style="font-size: 48px; color: #dc3545; margin-bottom: 15px;"></i>
                <h2 style="color: #333; margin-bottom: 10px;">Login Required</h2>
                <p style="color: #666; font-size: 16px; margin-bottom: 25px;">
                    Please log in to proceed with checkout and continue shopping.
                </p>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px;">
                <button onclick="closeLoginModal()" style="
                    background: #6c757d; 
                    color: white; 
                    border: none; 
                    padding: 12px 24px; 
                    border-radius: 6px; 
                    cursor: pointer; 
                    font-size: 14px;
                    transition: background-color 0.3s;
                " onmouseover="this.style.backgroundColor='#5a6268'" onmouseout="this.style.backgroundColor='#6c757d'">
                    Continue Shopping
                </button>
                <button onclick="redirectToLogin()" style="
                    background: #007bff; 
                    color: white; 
                    border: none; 
                    padding: 12px 24px; 
                    border-radius: 6px; 
                    cursor: pointer; 
                    font-size: 14px;
                    transition: background-color 0.3s;
                " onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">
                    <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>
                    Login Now
                </button>
            </div>
            
            <div style="border-top: 1px solid #eee; padding-top: 15px;">
                <p style="color: #999; font-size: 14px; margin: 0;">
                    Don't have an account? 
                    <a href="/register" style="color: #007bff; text-decoration: none; font-weight: 500;">
                        Create one here
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- Checkout Container Modal -->
    <div id="checkout-container" class="modal">
        <div class="modal-content checkout-modal-content">
            <span class="close-button" onclick="closeCheckoutContainer()" style="z-index: 9999; position: relative;">&times;</span>
            
            <!-- Step 1: Customer Information -->
            <div id="checkout-step-1" class="checkout-step active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üõí Checkout</h2>
                </div>
                <div class="checkout-progress">
                    <div class="progress-step active">1. Customer Info</div>
                    <div class="progress-step">2. Confirmation</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%;"></div>
                </div>
                
                <div id="prefill-notification" class="prefill-notification" style="display: none;">
                    <div class="prefill-message">
                        <i class="fas fa-user-check" style="color: #28a745; margin-right: 8px;"></i>
                        Your information has been pre-filled from your account
                    </div>
                </div>
                
                <form id="customer-form" class="checkout-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">Full Name *</label>
                            <input type="text" id="name" name="name" required placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" required placeholder="Enter your email">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phone">Phone *</label>
                            <input type="tel" id="phone" name="phone" required placeholder="Enter your phone number">
                        </div>
                    </div>
                    
                    
                    <div class="checkout-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCheckoutContainer()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="nextCheckoutStep()">Continue to Confirmation</button>
                    </div>
                </form>
            </div>
            
            
            <!-- Step 2: Delivery Address -->
            <div id="checkout-step-2" class="checkout-step">
                <h2>üìç Delivery Address</h2>
                <div class="checkout-progress">
                    <div class="progress-step completed">1. Customer Info</div>
                    <div class="progress-step active">2. Address</div>
                    <div class="progress-step">3. Confirmation</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 50%;"></div>
                </div>
                
                    <!-- Address Selection Section -->
                <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #333; font-weight: 600; font-size: 16px;">üìç Delivery Address</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div id="prefill-button-container" style="display: none;">
                                    <select id="address-selector" class="form-control" style="font-size: 13px; padding: 8px 12px; width: 300px; display: inline-block; border-radius: 4px; border: 1px solid #ddd;">
                                        <option value="">Select address...</option>
                                    </select>
                                </div>
                        <!-- <button type="button" id="add-address-btn" class="btn btn-outline-primary" onclick="openAddAddressModal()" style="font-size: 13px; padding: 8px 12px; border-radius: 4px;">
                            <i class="fas fa-plus" style="margin-right: 4px;"></i> Add Address
                        </button> -->
                        <!-- <button type="button" onclick="editSelectedAddress()" style="font-size: 13px; padding: 8px 12px; border-radius: 4px; background: #28a745; color: #fff; border: none; margin-left: 5px;">
                            Edit Address
                        </button> -->
                        </div>
                    </div>
                    
                        
                    <!-- Editable Atomic Address Fields -->
                    <div id="atomic-address-fields" style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
                        <h5 style="margin: 0 0 15px 0; color: #333;">Address Details (You can type manually or select from dropdown):</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                            <div class="form-group">
                                <label for="house_number" style="font-weight: bold; margin-bottom: 5px; display: block;">House Number:</label>
                                <input type="text" id="house_number" name="house_number" class="form-control" placeholder="Enter house number" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="street_name" style="font-weight: bold; margin-bottom: 5px; display: block;">Street Name:</label>
                                <input type="text" id="street_name" name="street_name" class="form-control" placeholder="Enter street name" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="village" style="font-weight: bold; margin-bottom: 5px; display: block;">Village:</label>
                                <input type="text" id="village" name="village" class="form-control" placeholder="Enter village" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="sangkat" style="font-weight: bold; margin-bottom: 5px; display: block;">Sangkat:</label>
                                <input type="text" id="sangkat" name="sangkat" class="form-control" placeholder="Enter sangkat" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="commune" style="font-weight: bold; margin-bottom: 5px; display: block;">Commune:</label>
                                <input type="text" id="commune" name="commune" class="form-control" placeholder="Enter commune" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="khan" style="font-weight: bold; margin-bottom: 5px; display: block;">Khan:</label>
                                <input type="text" id="khan" name="khan" class="form-control" placeholder="Enter khan" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="province" style="font-weight: bold; margin-bottom: 5px; display: block;">Province:</label>
                                <input type="text" id="province" name="province" class="form-control" placeholder="Enter province" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="postal_code" style="font-weight: bold; margin-bottom: 5px; display: block;">Postal Code:</label>
                                <input type="text" id="postal_code" name="postal_code" class="form-control" placeholder="Enter postal code" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="building_name" style="font-weight: bold; margin-bottom: 5px; display: block;">Building Name:</label>
                                <input type="text" id="building_name" name="building_name" class="form-control" placeholder="Enter building name" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="landmark" style="font-weight: bold; margin-bottom: 5px; display: block;">Landmark:</label>
                                <input type="text" id="landmark" name="landmark" class="form-control" placeholder="Enter landmark" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="floor_number" style="font-weight: bold; margin-bottom: 5px; display: block;">Floor Number:</label>
                                <input type="text" id="floor_number" name="floor_number" class="form-control" placeholder="Enter floor number" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="unit_number" style="font-weight: bold; margin-bottom: 5px; display: block;">Unit Number:</label>
                                <input type="text" id="unit_number" name="unit_number" class="form-control" placeholder="Enter unit number" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="form-group">
                                <label for="delivery_notes" style="font-weight: bold; margin-bottom: 5px; display: block;">Delivery Notes:</label>
                                <textarea id="delivery_notes" name="delivery_notes" class="form-control" placeholder="Enter delivery notes" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 60px; resize: vertical;"></textarea>
                            </div>
                            
                        </div>
                    </div>
                    </div>
                
                    
                    <div class="checkout-actions">
                    <button type="button" class="btn btn-secondary" onclick="previousCheckoutStep()">Back</button>
                        <button type="button" class="btn btn-primary" onclick="nextCheckoutStep()">Continue to Confirmation</button>
                    </div>
            </div>
            
            <!-- Step 3: Order Confirmation -->
            <div id="checkout-step-3" class="checkout-step">
                <h2>‚úÖ Order Confirmation</h2>
                <div class="checkout-progress">
                    <div class="progress-step completed">1. Customer Info</div>
                    <div class="progress-step completed">2. Address</div>
                    <div class="progress-step active">3. Confirmation</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%;"></div>
                </div>
                
                <!-- Address Summary Display -->
                <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                    <h4 style="margin: 0 0 15px 0; color: #333; font-weight: 600;">üìç Delivery Address Summary</h4>
                    <div id="address-summary-display" style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
                        <!-- Address summary will be populated here -->
                    </div>
                </div>
                
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div id="checkout-order-items"></div>
                    <div class="order-total">
                        <strong>Total: $<span id="checkout-total">0.00</span></strong>
                    </div>
                </div>
                
                <div class="checkout-actions">
                    <button type="button" class="btn btn-secondary" onclick="previousCheckoutStep()">Back</button>
                    <button type="button" class="btn btn-success" onclick="confirmOrder()">Confirm Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Verification Modal -->
    <div id="payment-verification-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; margin: 50px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center;">
                <h2 style="margin: 0; font-size: 1.8rem;">
                    <i class="fas fa-credit-card" style="margin-right: 10px;"></i>
                    Payment Verification
                </h2>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Upload your payment screenshot to verify your order instantly!</p>
            </div>
            
            <div class="modal-body" style="padding: 30px;">
                <form id="payment-verification-form" enctype="multipart/form-data">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-magic"></i> Auto-Detection
                        </label>
                        <div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-info-circle" style="color: #28a745; margin-right: 8px;"></i>
                                <strong style="color: #28a745;">Smart Detection Enabled</strong>
                            </div>
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                We'll automatically extract Order ID from QR codes and both Order ID + Transaction ID from invoices!
                            </p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="order-id" name="order_id" class="form-control" 
                                   placeholder="Auto-detected or enter manually" 
                                   style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                            <button type="button" id="find-order-btn" style="background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-search"></i> Find My Order
                            </button>
                        </div>
                        <small style="color: #666; font-size: 14px; margin-top: 5px; display: block;">
                            Order ID will be auto-detected from QR codes or invoices. You can also search by email/phone.
                        </small>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="transaction-id" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-hashtag"></i> Transaction ID (Optional)
                        </label>
                        <input type="text" id="transaction-id" name="transaction_id" class="form-control" 
                               placeholder="Auto-detected from payment invoice only"
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                        <small style="color: #666; font-size: 14px;">
                            <strong>QR codes don't contain Transaction ID.</strong> Only available from payment invoices/receipts from your bank.
                        </small>
                    </div>

                    <div class="form-group" style="margin-bottom: 25px;">
                        <label for="payment-screenshot" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-camera"></i> Payment Proof (Any Type)
                        </label>
                        <div class="file-upload-area" id="file-upload-area" 
                             style="border: 2px dashed #17a2b8; border-radius: 10px; padding: 40px; text-align: center; background: #f8f9fa; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #17a2b8; margin-bottom: 15px;"></i>
                            <p style="margin: 0; font-size: 18px; color: #333;">
                                <strong>Upload any payment proof</strong> - QR code, bank receipt, invoice, screenshot, etc.
                            </p>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">
                                Supports: JPG, PNG, PDF, DOC, DOCX (Max 10MB)
                            </p>
                        </div>
                        <input type="file" id="payment-screenshot" name="payment_screenshot" accept="image/*,.pdf,.doc,.docx" 
                               style="display: none;" required>
                        <div id="file-preview" style="margin-top: 15px; display: none;">
                            <div style="background: #e8f5e8; border: 1px solid #17a2b8; border-radius: 5px; padding: 15px;">
                                <i class="fas fa-check-circle" style="color: #17a2b8; margin-right: 8px;"></i>
                                <span id="file-name" style="font-weight: bold;"></span>
                                <button type="button" id="remove-file" style="float: right; background: none; border: none; color: #dc3545; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Upload Help Section -->
                        <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #17a2b8;">
                            <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">
                                <i class="fas fa-info-circle" style="color: #17a2b8; margin-right: 8px;"></i>
                                What can you upload?
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px;">
                                    <i class="fas fa-qrcode" style="color: #28a745; margin-right: 10px; font-size: 18px;"></i>
                                    <span>QR code screenshots</span>
                                </div>
                                <div style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px;">
                                    <i class="fas fa-university" style="color: #007bff; margin-right: 10px; font-size: 18px;"></i>
                                    <span>Bank transfer receipts</span>
                                </div>
                                <div style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px;">
                                    <i class="fas fa-file-invoice" style="color: #ffc107; margin-right: 10px; font-size: 18px;"></i>
                                    <span>Payment invoices</span>
                                </div>
                                <div style="display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px;">
                                    <i class="fas fa-camera" style="color: #6f42c1; margin-right: 10px; font-size: 18px;"></i>
                                    <span>Any payment confirmation</span>
                                </div>
                            </div>
                            <div style="background: #d1ecf1; padding: 12px; border-radius: 5px; border-left: 3px solid #17a2b8;">
                                <p style="margin: 0; color: #0c5460; font-size: 14px;">
                                    <i class="fas fa-lightbulb" style="margin-right: 8px;"></i>
                                    <strong>Don't worry if auto-detection fails!</strong> Our staff will review everything you upload and help resolve any issues.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 25px;">
                        <label for="payment-notes" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-comment"></i> Additional Notes (Optional)
                        </label>
                        <textarea id="payment-notes" name="payment_notes" class="form-control" rows="3" 
                                  placeholder="Any additional information about your payment..."
                                  style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; resize: vertical;"></textarea>
                    </div>

                    <div class="form-actions" style="text-align: center;">
                        <button type="submit" id="submit-btn" class="btn btn-success" 
                                style="background: #17a2b8; color: white; border: none; padding: 15px 40px; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-upload"></i> Verify Payment
                        </button>
                        <button type="button" id="close-verification-modal" class="btn btn-secondary" 
                                style="background: #6c757d; color: white; border: none; padding: 15px 40px; border-radius: 5px; font-size: 18px; margin-left: 15px; cursor: pointer;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>

                <div id="verification-result" style="margin-top: 25px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Find Order Modal -->
    <div id="find-order-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; margin: 100px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center;">
                <h2 style="margin: 0; font-size: 1.5rem;">
                    <i class="fas fa-search" style="margin-right: 10px;"></i>
                    Find My Order
                </h2>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">Search for your order using your email or phone number</p>
            </div>
            
            <div class="modal-body" style="padding: 30px;">
                <form id="find-order-form">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="search-email" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-envelope"></i> Email Address
                        </label>
                        <input type="email" id="search-email" name="email" class="form-control" 
                               placeholder="Enter your email address"
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                    </div>

                    <div class="form-group" style="margin-bottom: 25px;">
                        <label for="search-phone" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">
                            <i class="fas fa-phone"></i> Phone Number (Optional)
                        </label>
                        <input type="tel" id="search-phone" name="phone" class="form-control" 
                               placeholder="Enter your phone number"
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                        <small style="color: #666; font-size: 14px;">
                            Provide either email or phone number to search for your orders.
                        </small>
                    </div>

                    <div class="form-actions" style="text-align: center;">
                        <button type="submit" id="search-orders-btn" class="btn btn-success" 
                                style="background: #28a745; color: white; border: none; padding: 15px 40px; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-search"></i> Search Orders
                        </button>
                        <button type="button" id="close-find-order-modal" class="btn btn-secondary" 
                                style="background: #6c757d; color: white; border: none; padding: 15px 40px; border-radius: 5px; font-size: 18px; margin-left: 15px; cursor: pointer;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>

                <div id="search-results" style="margin-top: 25px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Original Customer Modal (kept for backward compatibility) -->
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Customer Details</h2>
            <form id="customer-form">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>

                <label for="phone">Phone:</label>
                <input type="tel" id="phone" name="phone" required>

                <label for="address">Address:</label>
                <input type="text" id="address" name="address" required>

                <button type="submit">Submit Order</button>
            </form>
        </div>
    </div>

    <!-- Include QRCode.js library for QR code generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>


    <!-- Include KHQR Payment JavaScript -->
    <script src="{{ url_for('static', filename='js/khqr_payment.js') }}"></script>
    <script>
        // Initialize cart items array
        let cartItems = [];

        // Global variable to store logged-in user info
        let loggedInUserInfo = null;

        // Fetch logged-in user info on page load
        async function fetchUserInfo() {
            try {
                const response = await fetch('/api/user/info');
                const data = await response.json();
                if (data.success && data.user) {
                    loggedInUserInfo = data.user;
                    console.log('Logged-in user info:', loggedInUserInfo);
                } else {
                    console.warn('User info not available or not logged in');
                    loggedInUserInfo = null; // Ensure it's null for non-logged-in users
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
                loggedInUserInfo = null; // Ensure it's null on error
            }
        }

        // Call fetchUserInfo on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchUserInfo();
            loadCartItems();
            

        });

        // Get modal elements
        const modal = document.getElementById('customer-modal');
        const customerForm = document.getElementById('customer-form');
        const closeButton = document.querySelector('.close-button');

        async function deleteFromCart(id, isPreOrder = false) {
            try {
                const endpoint = isPreOrder ? '/api/cart/remove-preorder' : '/api/cart/remove';
                const bodyKey = isPreOrder ? 'preorder_id' : 'product_id';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        [bodyKey]: id
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Remove item from local cartItems array
                    if (isPreOrder) {
                        cartItems = cartItems.filter(item => item.preorder_id !== id);
                    } else {
                        cartItems = cartItems.filter(item => item.id !== id);
                    }
                    updateCart();
                } else {
                    alert('Error removing item from cart: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while removing the item from cart.');
            }
        }

        async function updateCartQuantity(id, quantity, isPreOrder = false) {
            try {
                const endpoint = isPreOrder ? '/api/cart/update-preorder' : '/api/cart/update';
                const bodyKey = isPreOrder ? 'preorder_id' : 'product_id';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        [bodyKey]: id,
                        quantity: quantity
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update local cartItems array
                    const item = isPreOrder
                        ? cartItems.find(item => item.preorder_id === id)
                        : cartItems.find(item => item.id === id);
                    if (item) {
                        item.quantity = quantity;
                        updateCart();
                    }
                } else {
                    alert('Error updating cart: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the cart.');
            }
        }

        function updateCart() {
            console.log('üîÑ updateCart() called with cartItems:', cartItems);
            console.log('üîÑ cartItems.length:', cartItems.length);

            const cartItemsDiv = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-count');
            const cartTotal = document.getElementById('cart-total');
            const buyButton = document.getElementById('buy-button');

            cartItemsDiv.innerHTML = '';

            // Render cart items with delete buttons and quantity controls
            let totalItems = 0;
            let totalPrice = 0;
            cartItems.forEach(item => {
                totalItems += item.quantity;
                totalPrice += item.price * item.quantity;

                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = 'cart-item';

                // Check if this is a pre-order item
                const isPreOrder = item.type === 'preorder';
                const itemId = isPreOrder ? item.preorder_id : item.id;

                let itemDisplay, priceDisplay, subtotalDisplay;

                if (isPreOrder) {
                    // For pre-orders, show deposit information with enhanced badge
                    const preOrderBadge = '<span class="product-badge badge-preorder">üì¶ Pre-Order</span>';
                    itemDisplay = `
                        <div class="product-name-container">
                            <span class="product-name">${item.name}</span>
                            ${preOrderBadge}
                        </div>
                    `;
                    priceDisplay = `$${item.price.toFixed(2)} (Deposit)`;
                    subtotalDisplay = `Deposit Total: $${(item.price * item.quantity).toFixed(2)}`;
                } else {
                    // For regular items, show normal pricing with regular badge
                    const regularBadge = '<span class="product-badge badge-regular">üõí Order</span>';
                    itemDisplay = `
                        <div class="product-name-container">
                            <span class="product-name">${item.name}</span>
                            ${regularBadge}
                        </div>
                    `;
                    priceDisplay = `$${item.price.toFixed(2)}`;
                    subtotalDisplay = `Subtotal: $${(item.price * item.quantity).toFixed(2)}`;
                }

                // Quantity controls for both pre-orders and regular items
                const quantityControlsHTML = `
                    <div class="quantity-controls">
                        <button onclick="changeQuantity(${itemId}, ${item.quantity - 1}, ${isPreOrder})" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                        <span>Qty: ${item.quantity}</span>
                        <button onclick="changeQuantity(${itemId}, ${item.quantity + 1}, ${isPreOrder})">+</button>
                    </div>
                `;

                // Get product image URL with fallback
                const productImageUrl = item.photo ? `/static/uploads/products/${item.photo}` : '/static/icons/product/laptop.jpg';
                const fallbackImage = '/static/icons/product/laptop.jpg';
                
                cartItemDiv.innerHTML = `
                    <div class="cart-item-image">
                        <img src="${productImageUrl}" alt="${item.name}" 
                             onerror="this.src='${fallbackImage}'"
                             style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #eee;">
                    </div>
                    <div class="cart-item-info">
                        <div style="margin-bottom: 8px;">
                            ${itemDisplay}
                            <div style="margin-top: 4px; color: #666; font-size: 14px;">${priceDisplay}</div>
                        </div>
                        ${quantityControlsHTML}
                        <span style="font-weight: 500; color: #333;">${subtotalDisplay}</span>
                    </div>
                    <button onclick="deleteFromCart(${itemId}, ${isPreOrder})" class="delete-btn">Remove</button>
                `;
                cartItemsDiv.appendChild(cartItemDiv);
            });

            cartCount.textContent = totalItems;

            // Update localStorage to notify navigation bar cart badge (use unique products count)
            const uniqueProducts = cartItems.length;
            localStorage.setItem('cart_count', uniqueProducts.toString());
            localStorage.setItem('cart_updated', Date.now().toString());

            // Show/hide cart total based on whether there are items
            if (totalItems > 0) {
                cartTotal.style.display = 'block';
                // Calculate and display volume discount
                calculateAndDisplayVolumeDiscount(totalPrice);
            } else {
                cartTotal.style.display = 'none';
            }

            buyButton.disabled = totalItems === 0;
        }

        // Global variable to store the final total after discounts
        let currentFinalTotal = 0;

        // Function to calculate and display volume discount
        async function calculateAndDisplayVolumeDiscount(totalPrice) {
            const cartTotalElement = document.getElementById('cart-total');

            try {
                const response = await fetch('/api/calculate-volume-discount', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ cart_total: totalPrice })
                });

                const data = await response.json();

                if (data.success && data.volume_discount) {
                    const discount = data.volume_discount;

                    if (discount.applicable) {
                        // Store the discounted total globally
                        currentFinalTotal = discount.final_total;
                        
                        // Show volume discount applied
                        cartTotalElement.innerHTML = `
                            <div style="text-align: right;">
                                <div style="color: #666; font-size: 14px;">Subtotal: $${totalPrice.toFixed(2)}</div>
                                <div style="color: #28a745; font-size: 14px; margin: 5px 0;">
                                    <i class="fas fa-gift"></i> ${discount.rule_name}: ${discount.discount_percentage}% off (-$${discount.savings.toFixed(2)})
                                </div>
                                <div style="font-weight: bold; font-size: 18px; color: #333;">
                                    Total: $${discount.final_total.toFixed(2)}
                                </div>
                            </div>
                        `;
                    } else {
                        // No volume discount applicable - use original total
                        currentFinalTotal = totalPrice;
                        
                        // No volume discount applicable
                        cartTotalElement.innerHTML = `
                            <div style="text-align: right;">
                                <div style="font-weight: bold; font-size: 18px; color: #333;">
                                    Total: $${totalPrice.toFixed(2)}
                                </div>
                                <div style="color: #666; font-size: 12px; margin-top: 5px;">
                                    üí° Spend $500+ to get volume discounts!
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Fallback to simple total
                    currentFinalTotal = totalPrice;
                    cartTotalElement.textContent = `Total: $${totalPrice.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error calculating volume discount:', error);
                // Fallback to simple total
                currentFinalTotal = totalPrice;
                cartTotalElement.textContent = `Total: $${totalPrice.toFixed(2)}`;
            }
        }

        function changeQuantity(id, newQuantity, isPreOrder = false) {
            if (newQuantity <= 0) {
                deleteFromCart(id, isPreOrder);
            } else {
                updateCartQuantity(id, newQuantity, isPreOrder);
            }
        }

        // Function to clear cart via API
        async function clearCartAPI() {
            try {
                const response = await fetch('/api/cart/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                if (data.success) {
                    cartItems = [];
                    updateCart();
                } else {
                    console.error('Error clearing cart:', data.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }









        // Expose functions to global scope for inline onclick handlers
        window.deleteFromCart = deleteFromCart;
        window.changeQuantity = changeQuantity;
        window.updateCartQuantity = updateCartQuantity;
        window.clearCartAPI = clearCartAPI;

        // Load cart items from server
        async function loadCartItems() {
            try {
                console.log('üõí Loading cart items from server...');
                // Add cache-busting parameter to prevent browser caching
                const response = await fetch('/api/cart/items?t=' + Date.now());
                const data = await response.json();

                console.log('üõí Cart API response:', data);
                console.log('üõí Cart items received:', data.cart_items);
                console.log('üõí Cart items length:', data.cart_items ? data.cart_items.length : 0);

                if (data.success) {
                    cartItems = data.cart_items || [];
                    console.log('üõí Setting cartItems to:', cartItems);
                    updateCart();
                } else {
                    console.error('Error loading cart items:', data.error);
                    cartItems = [];
                    updateCart();
                }
            } catch (error) {
                console.error('Error:', error);
                cartItems = [];
                updateCart();
            }
        }

        // Initialize cart display when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCartItems();
        });

        // Refresh cart when user returns to the page (e.g., after payment)
        window.addEventListener('focus', function() {
            console.log('üîÑ Window focused - refreshing cart...');
            loadCartItems();
        });

        // Also refresh when page becomes visible (for mobile/tab switching)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üîÑ Page visible - refreshing cart...');
                loadCartItems();
            }
        });



        // --- Modal and Form Submission Logic ---

        // Handle checkout when "Proceed to Checkout" is clicked
        let storedCustomerInfo = null; // Global variable to store customer info

        document.getElementById('buy-button').onclick = async () => {
            if (cartItems.length > 0) {
                // Use the final total after discounts, or calculate if not available
                let finalTotal = currentFinalTotal;
                if (finalTotal === 0) {
                    finalTotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                }

                // Use stored customer info if available, else fallback to logged-in user info
                const customerInfo = storedCustomerInfo || loggedInUserInfo || {};

                // Proceed directly to invoice for payment method selection
                await processCheckout('PENDING');
            }
        };

        // Handle form submission - now using Bakong payment



        // Function to process checkout with selected payment method
        async function processCheckout(paymentMethod) {
            try {
                // Disable button during processing
                const buyButton = document.getElementById('buy-button');
                buyButton.disabled = true;
                buyButton.textContent = 'Processing...';

                console.log('Starting checkout process with payment method:', paymentMethod);
                console.log('Checkout customer info being sent:', checkoutCustomerInfo);

                // Call the checkout API with payment method and customer info
                const response = await fetch('/api/cart/checkout', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        payment_method: paymentMethod,
                        customer_info: checkoutCustomerInfo
                    })
                });

                console.log('Checkout response status:', response.status);
                console.log('Checkout response ok:', response.ok);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Checkout result:', result);

                    if (result.success) {
                        console.log('Checkout successful, order ID:', result.order_id);

                        // Clear cart from server and local display
                        await clearCartAPI();
                        cartItems = [];
                        updateCart();

                        // Show success message with safe number formatting
                        const subtotal = parseFloat(result.subtotal || 0).toFixed(2);
                        const discount = parseFloat(result.volume_discount_amount || 0).toFixed(2);
                        const total = parseFloat(result.final_total || 0).toFixed(2);

                        // Redirect directly to old invoice page
                        console.log('Order placed successfully, redirecting to old invoice:', `/oldinvoice/${result.order_id}`);
                        window.location.href = `/oldinvoice/${result.order_id}`;
                    } else {
                        // Check if verification is required
                        if (result.requires_verification || result.requires_otp) {
                            // Show verification prompt
                            Swal.fire({
                                title: 'Account Verification Required',
                                html: `
                                    <div style="text-align: center; margin: 20px 0;">
                                        <div style="font-size: 48px; margin-bottom: 20px;">üìß</div>
                                        <p style="font-size: 16px; margin-bottom: 20px;">
                                            Please verify your email address to continue purchasing.
                                        </p>
                                        <p style="font-size: 14px; color: #666;">
                                            You can verify your account from the notifications panel.
                                        </p>
                                    </div>
                                `,
                                icon: 'info',
                                confirmButtonText: 'Verify Now',
                                confirmButtonColor: '#007bff',
                                showCancelButton: true,
                                cancelButtonText: 'Cancel',
                                cancelButtonColor: '#6c757d'
                            }).then((result_modal) => {
                                if (result_modal.isConfirmed) {
                                    // Redirect to dashboard where notifications modal is available
                                    window.location.href = '/dashboard';
                                }
                            });
                        } else {
                            // Use SweetAlert for other error notifications
                            Swal.fire({
                                title: 'Checkout Failed',
                                text: result.error,
                                icon: 'error',
                                confirmButtonText: 'Try Again',
                                confirmButtonColor: '#dc3545'
                            });
                        }

                        // Re-enable button
                        buyButton.disabled = false;
                        buyButton.textContent = 'Proceed to Checkout';
                    }
                } catch (error) {
                    console.error('Error during checkout:', error);
                    console.error('Error details:', error.message, error.stack);
                    // Use SweetAlert for error notification
                    Swal.fire({
                        title: 'Checkout Error',
                        text: `An error occurred during checkout: ${error.message}. Please try again.`,
                        icon: 'error',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#dc3545'
                    });
                    // Re-enable button
                    const buyButton = document.getElementById('buy-button');
                    buyButton.disabled = false;
                    buyButton.textContent = 'Proceed to Checkout';
                }
        }

        // Close the modal when the 'x' is clicked
        closeButton.onclick = () => {
            modal.style.display = 'none';
        };

        // Close the modal if the user clicks outside of the modal content
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // Handle form submission - now using Bakong payment
        customerForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent page reload

            // Get customer data from the form
            const customerInfo = {
                first_name: document.getElementById('name').value.split(' ')[0] || '',
                last_name: document.getElementById('name').value.split(' ').slice(1).join(' ') || '',
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };

            // Validate required fields
            if (!customerInfo.first_name || !customerInfo.email) {
                alert('Please fill in all required fields.');
                return;
            }

            // Use the final total after discounts, or calculate if not available
            let finalTotal = currentFinalTotal;
            if (finalTotal === 0) {
                finalTotal = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
            }

            // Close customer form modal
            modal.style.display = 'none';

            // Proceed directly to invoice for payment method selection
            await processCheckout('PENDING');
        });

        // Handle successful payment completion
        window.handlePaymentSuccess = async function(paymentData) {
            try {
                // The backend does not have /api/payment/confirm-khqr endpoint
                // Instead, the order is created immediately on checkout
                // So just reset the form and redirect to invoice if order_id is available

                if (paymentData && paymentData.order_id) {
                    // Reset customer form
                    customerForm.reset();

                    // Redirect to invoice page
                    window.location.href = `/invoice/${paymentData.order_id}`;
                } else {
                    alert('Payment succeeded but order ID not found.');
                }
            } catch (error) {
                console.error('Error handling payment success:', error);
                alert('An error occurred while processing your order.');
            }
        };

        // Global variables to store payment data
        let currentPaymentData = {
            cartItems: [],
            customerInfo: {},
            totalPrice: 0
        };

        // Payment method selection removed - cart now proceeds directly with KHQR payment

        // Payment method modal functions removed - no longer needed

        // Individual payment method functions removed - cart proceeds directly with KHQR

        // Function to start KHQR Bakong payment with auto-generation
        async function startKHQRBakongPayment() {
            try {
                console.log('üî• startKHQRBakongPayment called');
                console.log('üî• currentPaymentData:', currentPaymentData);
                
                const totalPrice = currentPaymentData.totalPrice;
                const customerInfo = currentPaymentData.customerInfo;

                console.log('üîÑ Starting KHQR Bakong auto-payment generation...');
                console.log('üîÑ Total Price:', totalPrice);
                console.log('üîÑ Customer Info:', customerInfo);
                
                // Create order first using the existing checkout API
                const checkoutResponse = await fetch('/api/cart/checkout', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        payment_method: 'KHQR_BAKONG',
                        customer_info: customerInfo
                    })
                });

                // Check if response is JSON
                const contentType = checkoutResponse.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await checkoutResponse.text();
                    console.error('‚ùå Invalid response format:', text);
                    throw new Error('Server returned HTML instead of JSON. Please check the API endpoint.');
                }

                        const checkoutResult = await checkoutResponse.json();
                        console.log('üõí CHECKOUT RESULT:', checkoutResult);
                        console.log('üî• CHECKOUT SUCCESS:', checkoutResult.success);
                        console.log('üî• CHECKOUT ORDER ID:', checkoutResult.order_id);
                
                if (!checkoutResult.success) {
                    console.error('‚ùå CHECKOUT FAILED:', checkoutResult.error);
                    throw new Error(checkoutResult.error || 'Failed to create order');
                }
                
                console.log('‚úÖ CHECKOUT SUCCESS - Order ID:', checkoutResult.order_id);

                // Start KHQR payment with auto-generation
                // Suppress internal modal since we want to show our own
                console.log('üî• window.khqrPayment exists:', !!window.khqrPayment);
                console.log('üî• window.khqrPayment:', window.khqrPayment);
                
                if (!window.khqrPayment) {
                    throw new Error('KHQR Payment system not loaded');
                }
                
                window.khqrPayment.setSuppressOwnModal(true);
                
                window.khqrPayment.setSuccessCallback((paymentResult) => {
                    console.log('‚úÖ KHQR payment completed:', paymentResult);
                    console.log('‚úÖ CHECKOUT RESULT in callback:', checkoutResult);
                    console.log('‚úÖ ORDER ID in callback:', checkoutResult.order_id);
                    
                    // Show success message and redirect to invoice
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            title: 'Payment Successful!',
                            text: `Your order #${checkoutResult.order_id} has been processed successfully!`,
                            icon: 'success',
                            confirmButtonText: 'View Invoice',
                            showCancelButton: false
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = `/invoice/${checkoutResult.order_id}`;
                            } else {
                                // Auto-redirect after 3 seconds if user doesn't click
                                setTimeout(() => {
                                    window.location.href = `/invoice/${checkoutResult.order_id}`;
                                }, 3000);
                            }
                        });
                    } else {
                        // Fallback if SweetAlert not available
                        alert(`Payment successful! Order #${checkoutResult.order_id} has been processed.`);
                        window.location.href = `/invoice/${checkoutResult.order_id}`;
                    }
                });

                window.khqrPayment.setErrorCallback((errorMessage) => {
                    console.error('‚ùå KHQR payment failed:', errorMessage);
                    Swal.fire({
                        title: 'Payment Failed',
                        text: errorMessage,
                        icon: 'error',
                        confirmButtonText: 'Try Again'
                    });
                });

                // Start the payment
                await window.khqrPayment.startPayment(
                    totalPrice,
                    'USD',
                    `ORDER_${checkoutResult.order_id}`,
                    checkoutResult.order_id
                );

            } catch (error) {
                console.error('‚ùå Error starting KHQR Bakong payment:', error);
                console.error('‚ùå Error stack:', error.stack);
                Swal.fire({
                    title: 'Payment Error',
                    text: error.message || 'An error occurred while starting payment',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        // Cash payment function removed - cart proceeds directly with KHQR

        // Pay on delivery function removed - cart proceeds directly with KHQR



        // Function to process checkout with selected payment method
        async function processCheckout(paymentMethod) {
            try {
                // Disable button during processing
                const buyButton = document.getElementById('buy-button');
                buyButton.disabled = true;
                buyButton.textContent = 'Processing...';

                console.log('Starting checkout process with payment method:', paymentMethod);
                console.log('Checkout customer info being sent:', checkoutCustomerInfo);

                // Call the checkout API with payment method and customer info
                const response = await fetch('/api/cart/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        payment_method: paymentMethod,
                        customer_info: checkoutCustomerInfo
                    })
                });

                console.log('Checkout response status:', response.status);
                console.log('Checkout response ok:', response.ok);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Checkout result:', result);

                if (result.success) {
                    console.log('Checkout successful, order ID:', result.order_id);

                    // Clear cart from server and local display
                    await clearCartAPI();
                    cartItems = [];
                    updateCart();

                    // Show success message with safe number formatting
                    const subtotal = parseFloat(result.subtotal || 0).toFixed(2);
                    const discount = parseFloat(result.volume_discount_amount || 0).toFixed(2);
                    const total = parseFloat(result.final_total || 0).toFixed(2);

                    // Redirect directly to old invoice page
                    console.log('Order placed successfully, redirecting to old invoice:', `/oldinvoice/${result.order_id}`);
                    window.location.href = `/oldinvoice/${result.order_id}`;
                } else {
                    // Use styled error notification
                    Swal.fire({
                        title: 'Checkout Failed',
                        text: result.error,
                        icon: 'error',
                        confirmButtonText: 'Try Again',
                        confirmButtonColor: '#dc3545'
                    });

                    // Re-enable button
                    buyButton.disabled = false;
                    buyButton.textContent = 'Proceed to Checkout';
                }
            } catch (error) {
                console.error('Error during checkout:', error);
                console.error('Error details:', error.message, error.stack);

                // Use styled error notification
                Swal.fire({
                    title: 'Checkout Error',
                    text: `An error occurred during checkout: ${error.message}. Please try again.`,
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#dc3545'
                });

                // Re-enable button
                const buyButton = document.getElementById('buy-button');
                buyButton.disabled = false;
                buyButton.textContent = 'Proceed to Checkout';
            }
        }

        // Store cash payment data globally to avoid JSON parsing issues
        let cashPaymentData = null;

        async function processCashPayment(cartItems, customerInfo, totalPrice) {
            try {
                // Store data globally for confirmCashPayment function
                cashPaymentData = { cartItems, customerInfo, totalPrice };

                // Show cash payment confirmation modal
                const confirmModal = document.createElement('div');
                confirmModal.id = 'cash-payment-modal';
                confirmModal.className = 'modal';
                confirmModal.style.cssText = `
                    display: block;
                    position: fixed;
                    z-index: 1002;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.5);
                `;

                confirmModal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px; margin: 10% auto;">
                        <h2 style="margin-bottom: 20px; color: #333; text-align: center;">üíµ Cash Payment</h2>

                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 15px 0; color: #333;">Payment Details</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                                <div><strong>Customer:</strong></div>
                                <div>${customerInfo.first_name} ${customerInfo.last_name}</div>
                                <div><strong>Total Amount:</strong></div>
                                <div style="font-size: 18px; font-weight: bold; color: #28a745;">$${totalPrice.toFixed(2)}</div>
                                <div><strong>Payment Method:</strong></div>
                                <div>Cash</div>
                            </div>
                        </div>

                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                ‚ö†Ô∏è <strong>Staff Confirmation Required:</strong><br>
                                Please confirm that you have received the cash payment of <strong>$${totalPrice.toFixed(2)}</strong> from the customer before completing this order.
                            </p>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="cancelCashPayment()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="confirmCashPayment()"
                                    style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                ‚úÖ Confirm Cash Received
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(confirmModal);

            } catch (error) {
                console.error('Error processing cash payment:', error);
                alert('An error occurred while processing the cash payment.');
            }
        }

        async function cancelCashPayment() {
            const modal = document.getElementById('cash-payment-modal');
            if (modal) {
                modal.remove();
            }
            
            // If we have pending order data, we need to restore cart items and cancel the pending order
            if (cashPaymentData && cashPaymentData.cartItems) {
                console.log('üîÑ Restoring cart items after cash payment cancellation...');
                
                // Restore cart items to session
                const restoredCart = cashPaymentData.cartItems.map(item => ({
                    product_id: item.product_id,
                    quantity: item.quantity,
                    price: item.price,
                    product_name: item.product_name
                }));
                
                // Update the cart display
                if (typeof updateCartDisplay === 'function') {
                    updateCartDisplay(restoredCart);
                }
                
                // If we have a pending order ID, cancel it to prevent it from being counted as completed
                if (cashPaymentData.pendingOrderId) {
                    try {
                        console.log('üîÑ Cancelling pending order after cash payment cancellation...');
                        const response = await fetch(`/api/orders/${cashPaymentData.pendingOrderId}/cancel`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                reason: 'Payment cancelled by customer',
                                notes: 'Cash payment was cancelled during scanning'
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            console.log('‚úÖ Pending order cancelled successfully');
                        } else {
                            console.warn('‚ö†Ô∏è Failed to cancel pending order:', data.error);
                        }
                    } catch (error) {
                        console.error('‚ùå Error cancelling pending order:', error);
                    }
                }
                
                // Show success message
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Payment Cancelled',
                        text: 'Your cash payment has been cancelled and items have been restored to your cart.',
                        icon: 'info',
                        confirmButtonText: 'OK'
                    });
                } else {
                    alert('Payment cancelled. Items have been restored to your cart.');
                }
            }
            
            // Clear global payment data
            cashPaymentData = null;
        }

        async function confirmCashPayment() {
            if (!cashPaymentData) {
                alert('Payment data not found. Please try again.');
                return;
            }

            const { cartItems, customerInfo, totalPrice } = cashPaymentData;

            try {
                // First, create the order via checkout API
                console.log('=== CONFIRM CASH PAYMENT DEBUG ===');
                console.log('üîÑ Creating order for cash payment...');
                console.log('üîÑ Customer info for cash payment:', customerInfo);
                console.log('üîÑ Address ID in customer info:', customerInfo.address_id);
                console.log('üîÑ Customer info keys:', Object.keys(customerInfo));
                console.log('üîÑ Full customerInfo object:', JSON.stringify(customerInfo, null, 2));
                console.log('üîÑ Global checkoutCustomerInfo:', checkoutCustomerInfo);
                console.log('üîÑ Global selectedAddressId:', window.selectedAddressId);
                console.log('=== END CONFIRM CASH PAYMENT DEBUG ===');
                const checkoutResponse = await fetch('/api/cart/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        payment_method: 'Cash',
                        customer_info: customerInfo
                    })
                });

                const checkoutResult = await checkoutResponse.json();
                
                if (!checkoutResult.success) {
                    throw new Error(checkoutResult.error || 'Failed to create order');
                }

                // Store the order ID so it can be cancelled if needed
                cashPaymentData.pendingOrderId = checkoutResult.order_id;
                console.log('‚úÖ Order created with ID:', checkoutResult.order_id);

                                                // Now process the cash payment
                                const response = await fetch('/api/payment/cash', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        order_id: checkoutResult.order_id,  // Send the order ID we just created
                                        cart_items: cartItems,
                                        customer_info: customerInfo,
                                        total_amount: totalPrice
                                    })
                                });

                const data = await response.json();

                if (data.success) {
                    // Close cash payment modal
                    const modal = document.getElementById('cash-payment-modal');
                    if (modal) {
                        modal.remove();
                    }

                    // Clear global payment data
                    cashPaymentData = null;

                    // Clear cart
                    await clearCartAPI();

                    // Reset customer form if it exists
                    if (customerForm) {
                        customerForm.reset();
                    }

                    // Show success modal with options
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            title: 'Payment Successful!',
                            text: 'Your cash payment has been processed successfully.',
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonText: 'View Invoice',
                            cancelButtonText: 'Continue Shopping',
                            reverseButtons: true
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // User chose to view invoice
                                if (data.payment_type === 'mixed_cart' && data.order_id && data.preorder_id) {
                                    // Mixed cart payment - redirect to mixed cart summary
                                    window.location.href = `/mixed-cart/summary/${data.order_id}/${data.preorder_id}`;
                                } else if (data.order_id) {
                                    // Regular order - redirect to invoice
                                    window.location.href = `/invoice/${data.order_id}`;
                                } else if (data.preorder_only && data.preorder_id) {
                                    // Single pre-order payment - redirect to pre-order invoice
                                    window.location.href = `/preorder/invoice/${data.preorder_id}`;
                                } else if (data.preorder_only) {
                                    // Multiple pre-order payments - redirect to pre-orders page
                                    window.location.href = '/customer/preorders';
                                } else {
                                    // Fallback - show success message and stay on page
                                    alert(data.message || 'Payment completed successfully!');
                                }
                            } else {
                                // User chose to continue shopping - just reload the page to show empty cart
                                window.location.reload();
                            }
                        });
                    } else {
                        // Fallback if SweetAlert is not available
                        const choice = confirm('Payment successful! Click OK to view invoice or Cancel to continue shopping.');
                        if (choice) {
                            // User chose to view invoice
                            if (data.order_id) {
                                window.location.href = `/invoice/${data.order_id}`;
                            } else {
                                alert('Invoice not available');
                            }
                        } else {
                            // User chose to continue shopping
                            window.location.reload();
                        }
                    }
                } else {
                    // If cash payment fails, we need to cancel the order we just created
                    if (cashPaymentData.pendingOrderId) {
                        try {
                            console.log('üîÑ Cancelling order due to cash payment failure...');
                            await fetch(`/api/orders/${cashPaymentData.pendingOrderId}/cancel`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    reason: 'Cash payment failed',
                                    notes: 'Order cancelled due to payment processing error'
                                })
                            });
                        } catch (cancelError) {
                            console.error('‚ùå Error cancelling order after payment failure:', cancelError);
                        }
                    }
                    
                    alert('Error processing cash payment: ' + data.error);
                }
            } catch (error) {
                console.error('Error confirming cash payment:', error);
                
                // If order creation fails, we need to cancel any order that might have been created
                if (cashPaymentData.pendingOrderId) {
                    try {
                        console.log('üîÑ Cancelling order due to checkout error...');
                        await fetch(`/api/orders/${cashPaymentData.pendingOrderId}/cancel`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                reason: 'Checkout error',
                                notes: 'Order cancelled due to system error during checkout'
                            })
                        });
                    } catch (cancelError) {
                        console.error('‚ùå Error cancelling order after checkout error:', cancelError);
                    }
                }
                
                alert('An error occurred while processing the cash payment.');
            }
        }

        // Helper function to get cart items for checkout
        function getCartItemsForCheckout() {
            // Get cart items from session or localStorage
            if (typeof getCartItems === 'function') {
                return getCartItems();
            }
            
            // Fallback to global cartItems variable
            if (typeof cartItems !== 'undefined' && cartItems.length > 0) {
                return cartItems;
            }
            
            return null;
        }

        // Helper function to get customer info
        function getCustomerInfo() {
            // Check if customer form exists and has data
            if (typeof customerForm !== 'undefined' && customerForm) {
                const formData = new FormData(customerForm);
                const customerInfo = {};
                
                for (let [key, value] of formData.entries()) {
                    customerInfo[key] = value;
                }
                
                // Check if we have the required fields
                if (customerInfo.first_name && customerInfo.last_name && customerInfo.phone) {
                    return customerInfo;
                }
            }
            
            // No customer info available
            return null;
        }

        // Test KHQR Payment Function
        async function testKHQRPayment() {
            console.log('üß™ Testing KHQR payment flow...');

            const { cartItems, customerInfo, totalPrice } = currentPaymentData;

            // Payment method modal removed - proceed directly

            try {
                console.log('üß™ Creating test order via API...');

                // Call test endpoint to create real order
                const response = await fetch('/api/khqr/test-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: totalPrice
                    })
                });

                const result = await response.json();
                console.log('üß™ Test order API response:', result);

                if (result.success) {
                    // Clear cart
                    localStorage.removeItem('cart');

                    // Show success message
                    alert(`üß™ Test Order Created!\n\nOrder ID: ${result.order_id}\nAmount: ${result.currency} ${result.amount}\nReference: ${result.reference_id}`);

                    // Redirect to invoice
                    if (result.invoice_url) {
                        console.log(`üßæ Redirecting to test invoice: ${result.invoice_url}`);
                        window.location.href = result.invoice_url;
                    } else {
                        console.log('‚ö†Ô∏è No invoice URL in response');
                        window.location.href = '/';
                    }
                } else {
                    console.error('‚ùå Test order creation failed:', result.error);
                    alert(`‚ùå Test failed: ${result.error}`);
                }

            } catch (error) {
                console.error('‚ùå Error creating test order:', error);
                alert(`‚ùå Test error: ${error.message}`);
            }
        }

        // Checkout Container Functions
        let currentCheckoutStep = 1;
        let selectedPaymentMethod = 'KHQR_BAKONG';
        let checkoutCustomerInfo = {};
        let selectedAddressId = null; // Track the currently selected address ID
        

        // Edit selected address function
        async function editSelectedAddress() {
            const addressSelector = document.getElementById('address-selector');
            if (!addressSelector || !addressSelector.value) {
                alert('Please select an address to edit first.');
                return;
            }

            const addressId = addressSelector.value;
            console.log('Editing address ID:', addressId);

            try {
                // Fetch the current address details
                const response = await fetch(`/api/customer/addresses/${addressId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch address details');
                }

                const data = await response.json();
                const address = data.address;
                console.log('Address details:', address);

                // Create full atomic address edit form
                const editForm = `
                    <div style="padding: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px; color: #333;">Edit Address - ID ${addressId}</h3>
                        <form id="edit-address-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            
                            <!-- Row 1 -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">House Number:</label>
                                <input type="text" id="edit_house_number" value="${address.house_number || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Street Name:</label>
                                <input type="text" id="edit_street_name" value="${address.street_name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Row 2 -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Street Number:</label>
                                <input type="text" id="edit_street_number" value="${address.street_number || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Village:</label>
                                <input type="text" id="edit_village" value="${address.village || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Row 3 -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Sangkat:</label>
                                <input type="text" id="edit_sangkat" value="${address.sangkat || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Commune:</label>
                                <input type="text" id="edit_commune" value="${address.commune || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Row 4 -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Khan:</label>
                                <input type="text" id="edit_khan" value="${address.khan || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Province:</label>
                                <input type="text" id="edit_province" value="${address.province || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Row 5 -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Postal Code:</label>
                                <input type="text" id="edit_postal_code" value="${address.postal_code || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Country:</label>
                                <input type="text" id="edit_country" value="${address.country || 'Cambodia'}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Row 6 -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Building Name:</label>
                                <input type="text" id="edit_building_name" value="${address.building_name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Floor Number:</label>
                                <input type="text" id="edit_floor_number" value="${address.floor_number || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Row 7 -->
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Unit Number:</label>
                                <input type="text" id="edit_unit_number" value="${address.unit_number || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Landmark:</label>
                                <input type="text" id="edit_landmark" value="${address.landmark || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <!-- Row 8 - Full width -->
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Delivery Notes:</label>
                                <textarea id="edit_delivery_notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${address.delivery_notes || ''}</textarea>
                            </div>
                            
                            <!-- Buttons -->
                            <div style="grid-column: 1 / -1; margin-top: 20px; text-align: center;">
                                <button type="button" onclick="saveEditedAddress(${addressId})" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">Save Changes</button>
                                <button type="button" onclick="closeEditModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                            </div>
                        </form>
                    </div>
                `;

                // Show edit modal using a simple approach
                const modal = document.createElement('div');
                modal.id = 'edit-address-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 700px;
                    max-height: 80vh;
                    overflow-y: auto;
                    position: relative;
                `;
                
                modalContent.innerHTML = editForm;
                modal.appendChild(modalContent);
                document.body.appendChild(modal);

            } catch (error) {
                console.error('Error fetching address:', error);
                alert('Error loading address details: ' + error.message);
            }
        }

        // Save edited address
        async function saveEditedAddress(addressId) {
            // Get all form values
            const addressData = {
                house_number: document.getElementById('edit_house_number').value,
                street_name: document.getElementById('edit_street_name').value,
                street_number: document.getElementById('edit_street_number').value,
                village: document.getElementById('edit_village').value,
                sangkat: document.getElementById('edit_sangkat').value,
                commune: document.getElementById('edit_commune').value,
                khan: document.getElementById('edit_khan').value,
                province: document.getElementById('edit_province').value,
                postal_code: document.getElementById('edit_postal_code').value,
                country: document.getElementById('edit_country').value,
                building_name: document.getElementById('edit_building_name').value,
                floor_number: document.getElementById('edit_floor_number').value,
                unit_number: document.getElementById('edit_unit_number').value,
                landmark: document.getElementById('edit_landmark').value,
                delivery_notes: document.getElementById('edit_delivery_notes').value
            };

            // Validate that at least one field is provided
            const requiredFields = ['street_name', 'province', 'village', 'sangkat'];
            if (!requiredFields.some(field => addressData[field])) {
                alert('Please fill in at least one field (Street Name, Province, Village, or Sangkat).');
                return;
            }

            try {
                const response = await fetch(`/api/customer/addresses/${addressId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(addressData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Close the custom modal
                        const modal = document.getElementById('edit-address-modal');
                        if (modal) {
                            modal.remove();
                        }
                        alert('Address updated successfully!');
                        // Reload addresses
                        loadCustomerAddresses();
                    } else {
                        alert('Error updating address: ' + result.error);
                    }
                } else {
                    const error = await response.json();
                    alert('Error updating address: ' + error.error);
                }
            } catch (error) {
                console.error('Error updating address:', error);
                alert('Error updating address: ' + error.message);
            }
        }

        // Close edit modal
        function closeEditModal() {
            const modal = document.getElementById('edit-address-modal');
            if (modal) {
                modal.remove();
            }
        }



        function openCheckoutContainer() {
            // Security check: Only allow checkout for logged-in users
            if (!loggedInUserInfo || !loggedInUserInfo.id) {
                showLoginRequiredModal();
                return; // Prevent checkout from opening
            }
            
            const modal = document.getElementById('checkout-container');
            modal.style.display = 'block';
            currentCheckoutStep = 1;
            showCheckoutStep(1);
            
            console.log('Opening checkout container...');
            console.log('loggedInUserInfo:', loggedInUserInfo);
            
            // Show pre-fill button if user is logged in
            const prefillButtonContainer = document.getElementById('prefill-button-container');
            if (prefillButtonContainer) {
                if (loggedInUserInfo) {
                    prefillButtonContainer.style.display = 'block';
                    // Load customer addresses for selection
                    loadCustomerAddresses();
                    console.log('Pre-fill button shown');
                } else {
                    prefillButtonContainer.style.display = 'none';
                    console.log('Pre-fill button hidden - no user info');
                }
            }
            
            // Pre-fill customer information if user is logged in
            if (loggedInUserInfo) {
                console.log('Calling prefillCustomerForm...');
                prefillCustomerForm();
            } else {
                console.log('No user info available for pre-fill');
            }
        }

        function closeCheckoutContainer() {
            console.log('Close button clicked!');
            const modal = document.getElementById('checkout-container');
            modal.style.display = 'none';
            resetCheckoutForm();
            console.log('Checkout modal closed and form reset');
        }
        
        // Add event listener for close button
        document.addEventListener('DOMContentLoaded', function() {
            const closeButton = document.querySelector('#checkout-container .close-button');
            if (closeButton) {
                closeButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Close button event listener triggered');
                    closeCheckoutContainer();
                });
            }
        });

        // Load customer addresses for selection
        async function loadCustomerAddresses() {
            try {
                const response = await fetch('/api/customer/addresses');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Addresses response:', data);
                    
                    // Check if data has addresses array
                    const addresses = data.addresses || data;
                    console.log('Addresses array:', addresses);
                    
                    const selector = document.getElementById('address-selector');
                    const prefillContainer = document.getElementById('prefill-button-container');
                    
                    // Show the address selector
                    if (prefillContainer) {
                        prefillContainer.style.display = 'block';
                    }
                    
                    // Completely rebuild the selector
                    const newSelector = document.createElement('select');
                    newSelector.id = 'address-selector';
                    newSelector.className = 'form-control';
                    newSelector.style.cssText = 'font-size: 13px; padding: 8px 12px; width: 300px; display: inline-block; border-radius: 4px; border: 1px solid #ddd;';
                    
                    // Add placeholder option as selected
                    const placeholderOption = document.createElement('option');
                    placeholderOption.value = '';
                    placeholderOption.textContent = 'Select address...';
                    placeholderOption.selected = true;
                    newSelector.appendChild(placeholderOption);
                    
                    // Add address options
                    if (addresses && Array.isArray(addresses)) {
                        let defaultAddress = null;
                        
                        console.log('=== ADDRESS ORDER DEBUG ===');
                        addresses.forEach((address, index) => {
                            console.log(`Address ${index}: ID=${address.id}, Street=${address.street_name}, Province=${address.province}, is_default=${address.is_default}`);
                            
                            const option = document.createElement('option');
                            option.value = address.id;
                            // Create flexible address display
                            let displayText = '';
                            if (address.street_name) {
                                displayText += address.street_name;
                            }
                            if (address.province) {
                                if (displayText) displayText += ', ';
                                displayText += address.province;
                            }
                            if (!displayText) {
                                // Fallback if both are empty
                                displayText = `Address ${address.id}`;
                            }
                            option.textContent = displayText;
                            if (address.is_default) {
                                defaultAddress = address;
                            }
                            newSelector.appendChild(option);
                        });
                        console.log('=== END ADDRESS ORDER DEBUG ===');
                        
                        if (defaultAddress) {
                            console.log(`Default address available: ${defaultAddress.id} - ${defaultAddress.street_name}`);
                        }
                        
                        // Add event listener for manual selection
                        newSelector.addEventListener('change', function() {
                            console.log('=== DROPDOWN CHANGE EVENT ===');
                            console.log('Selected value:', this.value);
                            console.log('Selected text:', this.options[this.selectedIndex].text);
                            console.log('Selected index:', this.selectedIndex);
                            console.log('Global selectedAddressId before:', selectedAddressId);
                            selectAddress();
                            console.log('Global selectedAddressId after:', selectedAddressId);
                        });
                        
                        console.log(`Loaded ${addresses.length} addresses into dropdown`);
                        
                        // Auto-select the first address if available (only if no address is currently selected)
                        console.log('=== ADDRESS SELECTION LOGIC ===');
                        console.log('Addresses available:', addresses.length);
                        console.log('Current selectedAddressId:', selectedAddressId);
                        console.log('Will auto-select first address:', addresses.length > 0 && !selectedAddressId);
                        console.log('Will restore previous selection:', !!selectedAddressId);
                        
                        if (addresses.length > 0) {
                            if (selectedAddressId) {
                                // Try to select the previously selected address
                                newSelector.value = selectedAddressId;
                                console.log('Restored previously selected address:', selectedAddressId);
                                console.log('Restored address text:', newSelector.options[newSelector.selectedIndex].text);
                                // Also update the global variable
                                window.selectedAddressId = selectedAddressId;
                            } else if (defaultAddress) {
                                // Only auto-select if there's a default address
                                newSelector.value = defaultAddress.id;
                                console.log('Auto-selected default address:', defaultAddress.id);
                                console.log('Default address text:', newSelector.options[newSelector.selectedIndex].text);
                                // Trigger address selection
                                selectAddress();
                            } else {
                                // Don't auto-select any address - let user choose
                                console.log('No default address and no previous selection - user must choose manually');
                                // Don't auto-select anything
                            }
                        }
                        console.log('=== END ADDRESS SELECTION LOGIC ===');
                    }
                    
                    // Replace the old selector with the new one
                    selector.parentNode.replaceChild(newSelector, selector);
                    
                    console.log('New selector value:', newSelector.value);
                    console.log('New selector selectedIndex:', newSelector.selectedIndex);
                }
            } catch (error) {
                console.error('Error loading addresses:', error);
            }
        }

        // Handle address selection
        async function selectAddress() {
            console.log('selectAddress() called');
            const selector = document.getElementById('address-selector');
            if (!selector) {
                console.error('Address selector not found!');
                return;
            }
            
            const addressId = selector.value;
            console.log('Selected address ID:', addressId);
            console.log('All options:', Array.from(selector.options).map(opt => ({value: opt.value, text: opt.text})));
            
            // Store the selected address ID globally
            selectedAddressId = addressId;
            window.selectedAddressId = addressId; // Also store in window object
            console.log('Stored selectedAddressId globally:', selectedAddressId);
            console.log('Stored selectedAddressId in window:', window.selectedAddressId);
            
            // Also update the global checkoutCustomerInfo with the address_id
            if (addressId) {
                checkoutCustomerInfo = {
                    ...checkoutCustomerInfo,
                    address_id: addressId,
                    name: loggedInUserInfo ? loggedInUserInfo.name : checkoutCustomerInfo.name || '',
                    email: loggedInUserInfo ? loggedInUserInfo.email : checkoutCustomerInfo.email || '',
                    phone: loggedInUserInfo ? loggedInUserInfo.phone : checkoutCustomerInfo.phone || ''
                };
                console.log('Updated global checkoutCustomerInfo with address_id:', checkoutCustomerInfo);
                
                // Fetch the full address details and auto-fill atomic fields
                try {
                    console.log('Fetching address details for ID:', addressId);
                    const response = await fetch(`/api/customer/addresses/${addressId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.address) {
                            console.log('Address details fetched:', data.address);
                            
                            // Auto-fill all atomic address fields
                            prefillAddressFields(data.address);
                            
                            // Show success message
                            showCustomNotification('Address selected and atomic fields auto-filled!', 'success');
                            
                            // Add visual indicator to the address section
                            const addressSection = document.querySelector('.checkout-section');
                            if (addressSection) {
                                addressSection.style.border = '2px solid #28a745';
                                addressSection.style.backgroundColor = '#f8fff9';
                                setTimeout(() => {
                                    addressSection.style.border = '';
                                    addressSection.style.backgroundColor = '';
                                }, 3000);
                            }
                        } else {
                            console.error('Failed to fetch address details:', data);
                        }
                    } else {
                        console.error('Error fetching address details:', response.status);
                    }
                } catch (error) {
                    console.error('Error fetching address details:', error);
                }
            }
            
            if (addressId) {
                try {
                    console.log('Loading address ID:', addressId);
                    const response = await fetch(`/api/customer/addresses/${addressId}`);
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Address response:', result);
                        
                        if (result.success && result.address) {
                            prefillAddressFields(result.address);
                            console.log('Address loaded and prefilled:', result.address);
                            console.log('Address ID stored globally:', selectedAddressId);
                            
                            // Show notification
                            const notification = document.getElementById('prefill-notification');
                            if (notification) {
                                notification.style.display = 'block';
                            }
                        } else {
                            console.error('Error loading address:', result.error);
                        }
                    } else {
                        console.error('Failed to load address:', response.status);
                    }
                } catch (error) {
                    console.error('Error loading address:', error);
                }
            } else {
                console.log('No address ID selected, clearing form');
                // Clear the form when no address is selected
                clearAddressFields();
            }
        }
        
        // Clear address fields
        function clearAddressFields() {
            const fields = [
                'house_number', 'street_name', 'village', 'sangkat', 
                'commune', 'khan', 'province', 'postal_code',
                'building_name', 'landmark', 'floor_number', 'unit_number', 'delivery_notes'
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = '';
                }
            });
        }

        // Address Modal Functions
        function openAddAddressModal() {
            console.log('Opening add address modal');
            const modal = document.getElementById('add-address-modal');
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeAddAddressModal() {
            console.log('Closing add address modal');
            const modal = document.getElementById('add-address-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                // Clear the form
                document.getElementById('add-address-form').reset();
            }
        }

        async function saveNewAddress() {
            console.log('Saving new address');
            
            // Get form data
            const formData = {
                house_number: document.getElementById('modal_house_number').value,
                street_name: document.getElementById('modal_street_name').value,
                village: document.getElementById('modal_village').value,
                sangkat: document.getElementById('modal_sangkat').value,
                commune: document.getElementById('modal_commune').value,
                khan: document.getElementById('modal_khan').value,
                province: document.getElementById('modal_province').value,
                postal_code: document.getElementById('modal_postal_code').value,
                country: 'Cambodia',
                building_name: document.getElementById('modal_building_name').value,
                landmark: document.getElementById('modal_landmark').value,
                floor_number: document.getElementById('modal_floor_number').value,
                unit_number: document.getElementById('modal_unit_number').value,
                delivery_notes: document.getElementById('modal_delivery_notes').value,
                is_default: false
            };

            // Validate required fields - at least one address component should be filled
            if (!formData.street_name && !formData.province && !formData.village && !formData.sangkat) {
                showCustomNotification('Please fill in at least one address component (Street Address, Province, Village, or Sangkat).', 'error');
                return;
            }

            try {
                const response = await fetch('/api/customer/addresses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Address saved successfully:', result);
                    
                    // Close modal
                    closeAddAddressModal();
                    
                    // Reload address list
                    loadCustomerAddresses();
                    
                    // Prefill the hidden form fields with the new address
                    prefillAddressFields(formData);
                    
                    // Update the dropdown to show the new address
                    const selector = document.getElementById('address-selector');
                    if (result.address && result.address.id) {
                        selector.value = result.address.id;
                        // Also update the global selectedAddressId
                        selectedAddressId = result.address.id;
                        console.log('Set selectedAddressId to new address:', selectedAddressId);
                    }
                    
                    // Show success notification
                    showCustomNotification('Address saved successfully!', 'success');
                } else {
                    const error = await response.json();
                    console.error('Error saving address:', error);
                    showCustomNotification('Error saving address: ' + (error.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving address:', error);
                showCustomNotification('Error saving address: ' + error.message, 'error');
            }
        }

        // Save current address from checkout form
        async function saveCurrentAddress() {
            try {
                // Check if user is logged in first
                const userResponse = await fetch('/api/user/info');
                const userData = await userResponse.json();
                if (!userData.success || !userData.user) {
                    throw new Error('Please log in to save addresses');
                }
                
                console.log('User is logged in:', userData.user);
                
                // Helper function to safely get field value
                const getFieldValue = (fieldId) => {
                    const element = document.getElementById(fieldId);
                    return element ? element.value : '';
                };

                // Collect address data from form with null checks
                const addressData = {
                    address_type: 'home',
                    house_number: getFieldValue('house_number'),
                    street_name: getFieldValue('street_name'),
                    street_number: getFieldValue('street_number'),
                    village: getFieldValue('village'),
                    sangkat: getFieldValue('sangkat'),
                    commune: getFieldValue('commune'),
                    khan: getFieldValue('khan'),
                    province: getFieldValue('province'),
                    postal_code: getFieldValue('postal_code'),
                    country: getFieldValue('country') || 'Cambodia',
                    building_name: getFieldValue('building_name'),
                    floor_number: getFieldValue('floor_number'),
                    unit_number: getFieldValue('unit_number'),
                    landmark: getFieldValue('landmark'),
                    delivery_notes: getFieldValue('delivery_notes'),
                    is_default: false // Don't set as default automatically
                };

                const response = await fetch('/api/customer/addresses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(addressData)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response received:', text);
                    throw new Error(`Server returned ${response.status}: ${text.substring(0, 100)}...`);
                }

                if (response.ok) {
                    const result = await response.json();
                    console.log('Address saved successfully:', result);
                    
                    // Show success notification
                    showCustomNotification('Address saved successfully!', 'success');
                    
                    // Reload address list and select the new address
                    await loadCustomerAddresses();
                    
                    // Select the newly saved address in the dropdown
                    if (result.address_id) {
                        const selector = document.getElementById('address-selector');
                        if (selector) {
                            selector.value = result.address_id;
                            // Also update the global selectedAddressId
                            selectedAddressId = result.address_id;
                            console.log('New address selected in dropdown:', result.address_id);
                        }
                    }
                } else {
                    const error = await response.json();
                    console.error('Error saving address:', error);
                    showCustomNotification('Error saving address: ' + (error.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving address:', error);
                showCustomNotification('Error saving address: ' + error.message, 'error');
            }
        }

        function showCheckoutStep(step) {
            // Hide all steps
            document.querySelectorAll('.checkout-step').forEach(s => s.classList.remove('active'));
            
            // Show current step
            document.getElementById(`checkout-step-${step}`).classList.add('active');
            
            // Update progress indicators
            updateProgressIndicators(step);
            
            // Update progress step classes
            updateProgressStepClasses(step);
            
            // Update progress bar
            const progressFill = document.querySelector('.progress-fill');
            if (progressFill) {
                if (step === 1) {
                    progressFill.style.width = '0%';
                } else if (step === 2) {
                    progressFill.style.width = '50%';
                } else if (step === 3) {
                    progressFill.style.width = '100%';
                }
            }
        }

        function updateProgressIndicators(step) {
            const progressSteps = document.querySelectorAll('.progress-step');
            progressSteps.forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
        }

        function updateProgressStepClasses(step) {
            try {
                // Get all progress steps from the current active step
                const currentStepElement = document.querySelector(`#checkout-step-${step}`);
                if (!currentStepElement) {
                    console.warn(`Step ${step} element not found`);
                    return;
                }
                
                const progressSteps = currentStepElement.querySelectorAll('.progress-step');
                if (progressSteps.length === 0) {
                    console.warn(`No progress steps found in step ${step}`);
                    return;
                }
                
                // Remove all classes from all progress steps
                progressSteps.forEach(stepEl => {
                    stepEl.classList.remove('active', 'completed');
                });
                
                // Add appropriate classes based on current step
                if (step === 1) {
                    // Step 1: Customer Info
                    if (progressSteps[0]) progressSteps[0].classList.add('active');
                } else if (step === 2) {
                    // Step 2: Confirmation
                    if (progressSteps[0]) progressSteps[0].classList.add('completed');
                    if (progressSteps[1]) progressSteps[1].classList.add('active');
                }
                
                console.log(`Progress step classes updated for step ${step}`);
            } catch (error) {
                console.error('Error updating progress step classes:', error);
            }
        }

        function nextCheckoutStep() {
            if (currentCheckoutStep === 1) {
                console.log('=== CHECKOUT STEP 1 VALIDATION ===');
                console.log('Global selectedAddressId:', selectedAddressId);
                
                // Validate customer form only (address validation moved to Step 2)
                if (!validateCustomerForm()) {
                    console.log('Customer form validation failed');
                    return;
                }
                
                // Store customer info (address will be handled in Step 2)
                console.log('=== CUSTOMER INFO STORAGE ===');
                console.log('Storing customer info for Step 2');
                
                checkoutCustomerInfo = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    // Address fields will be populated in Step 2 when address is selected
                    country: 'Cambodia' // Default country
                };
                
                currentCheckoutStep = 2;
                showCheckoutStep(2);
                
                // Load customer addresses for Step 2
                loadCustomerAddresses();
            } else if (currentCheckoutStep === 2) {
                console.log('=== CHECKOUT STEP 2 VALIDATION ===');
                
                // Validate address form
                if (!validateAddressForm()) {
                    console.log('Address form validation failed');
                    return;
                }
                
                // Store address info
                console.log('=== ADDRESS INFO STORAGE ===');
                console.log('Storing address info for Step 3');
                
                // Update checkoutCustomerInfo with address details
                checkoutCustomerInfo = {
                    ...checkoutCustomerInfo,
                    address_id: selectedAddressId || null,
                    street_name: document.getElementById('street_name').value,
                    province: document.getElementById('province').value,
                    house_number: document.getElementById('house_number').value,
                    village: document.getElementById('village').value,
                    sangkat: document.getElementById('sangkat').value,
                    khan: document.getElementById('khan').value,
                    commune: document.getElementById('commune').value,
                    postal_code: document.getElementById('postal_code').value,
                    building_name: document.getElementById('building_name').value,
                    landmark: document.getElementById('landmark').value,
                    floor_number: document.getElementById('floor_number').value,
                    unit_number: document.getElementById('unit_number').value,
                    delivery_notes: document.getElementById('delivery_notes').value,
                    address_type: 'home'
                };
                
                currentCheckoutStep = 3;
                showCheckoutStep(3);
                
                // Populate address summary and order summary
                populateAddressSummary();
                populateOrderSummary();
            }
        }

        function validateAddressForm() {
            const addressSelector = document.getElementById('address-selector');
            const selectedAddressId = addressSelector ? addressSelector.value : null;
            
            // Check if user selected an address from dropdown
            if (selectedAddressId) {
                console.log('Address validation passed for address ID:', selectedAddressId);
                return true;
            }
            
            // If no dropdown selection, validate manual address entry
            const streetName = document.getElementById('street_name') ? document.getElementById('street_name').value.trim() : '';
            const province = document.getElementById('province') ? document.getElementById('province').value.trim() : '';
            const houseNumber = document.getElementById('house_number') ? document.getElementById('house_number').value.trim() : '';
            const village = document.getElementById('village') ? document.getElementById('village').value.trim() : '';
            const sangkat = document.getElementById('sangkat') ? document.getElementById('sangkat').value.trim() : '';
            
            // Check if at least one address component is filled manually
            if (!streetName && !province && !houseNumber && !village && !sangkat) {
                showCustomNotification('Please either select an address from the dropdown or enter address details manually (at least Street Name, Province, House Number, Village, or Sangkat).', 'error');
                return false;
            }
            
            // If user entered manual address, validate required fields
            if (!streetName) {
                showCustomNotification('Street Name is required when entering address manually.', 'error');
                if (document.getElementById('street_name')) {
                    document.getElementById('street_name').focus();
                }
                return false;
            }
            
            console.log('Address validation passed for manual entry - Street:', streetName, 'Province:', province);
            return true;
        }

        function prevCheckoutStep() {
            if (currentCheckoutStep === 2) {
                currentCheckoutStep = 1;
                showCheckoutStep(1);
            } else if (currentCheckoutStep === 3) {
                currentCheckoutStep = 2;
                showCheckoutStep(2);
            }
        }

        function previousCheckoutStep() {
            if (currentCheckoutStep === 2) {
                // From Address, go back to Customer Info (step 1)
                currentCheckoutStep = 1;
                showCheckoutStep(1);
            } else if (currentCheckoutStep === 3) {
                // From Confirmation, go back to Address (step 2)
                currentCheckoutStep = 2;
                showCheckoutStep(2);
            }
            // If already on step 1, do nothing (can't go back further)
        }

        function showCustomNotification(message, type = 'error') {
            // Remove any existing notifications
            const existingNotification = document.querySelector('.custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `custom-notification custom-notification-${type}`;
            notification.innerHTML = `
                <div class="custom-notification-content">
                    <i class="custom-notification-icon">${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</i>
                    <span class="custom-notification-message">${message}</span>
                    <button class="custom-notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function validateCustomerForm() {
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            
            console.log('Validation check:', { name, email, phone });
            
            if (!name || !email || !phone) {
                showCustomNotification('Please fill in all required fields.', 'error');
                return false;
            }
            
            if (!isValidEmail(email)) {
                showCustomNotification('Please enter a valid email address.', 'error');
                return false;
            }
            
            return true;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Payment method selection functions removed - cart proceeds directly with KHQR

        // Payment method selection functions removed - cart proceeds directly with KHQR

        function proceedToConfirmation() {
            if (!selectedPaymentMethod) {
                showCustomNotification('Please select a payment method.', 'error');
                return;
            }
            
            currentCheckoutStep = 3;
            showCheckoutStep(3);
            populateOrderSummary();
        }

        function populateOrderSummary() {
            const orderItemsDiv = document.getElementById('checkout-order-items');
            const totalSpan = document.getElementById('checkout-total');
            
            let orderItemsHTML = '';
            let total = 0;
            
            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                // Get product image URL with fallback
                const productImageUrl = item.photo ? `/static/uploads/products/${item.photo}` : '/static/icons/product/laptop.jpg';
                const fallbackImage = '/static/icons/product/laptop.jpg';
                
                orderItemsHTML += `
                    <div style="display: flex; align-items: center; margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="margin-right: 15px; flex-shrink: 0;">
                            <img src="${productImageUrl}" alt="${item.name}" 
                                 onerror="this.src='${fallbackImage}'"
                                 style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb;">
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${item.name}</div>
                            <div style="color: #6b7280; font-size: 14px;">Qty: ${item.quantity} √ó $${item.price.toFixed(2)}</div>
                        </div>
                        <div style="font-weight: 600; color: #1f2937; font-size: 16px;">$${itemTotal.toFixed(2)}</div>
                    </div>
                `;
            });
            
            orderItemsDiv.innerHTML = orderItemsHTML;
            totalSpan.textContent = total.toFixed(2);
        }
        
        function populateAddressSummary() {
            const addressSummaryDiv = document.getElementById('address-summary-display');
            
            if (!addressSummaryDiv) return;
            
            const addressFields = [
                'house_number', 'street_name', 'village', 'sangkat', 
                'commune', 'khan', 'province', 'postal_code',
                'building_name', 'landmark', 'floor_number', 'unit_number', 'delivery_notes'
            ];
            
            let addressHTML = '<div style="font-size: 14px; line-height: 1.6;">';
            
            
            // Add address components
            addressHTML += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">';
            
            addressFields.forEach(field => {
                const element = document.getElementById(field);
                const value = element ? element.value : '';
                const label = field.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                if (value) {
                    addressHTML += `<div><strong>${label}:</strong> ${value}</div>`;
                }
            });
            
            addressHTML += '</div>';
            
            // Add delivery notes if present
            const deliveryNotes = document.getElementById('delivery_notes');
            if (deliveryNotes && deliveryNotes.value) {
                addressHTML += '<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">';
                addressHTML += `<strong>Delivery Notes:</strong> ${deliveryNotes.value}`;
                addressHTML += '</div>';
            }
            
            addressHTML += '</div>';
            
            addressSummaryDiv.innerHTML = addressHTML;
        }

        async function confirmOrder() {
            console.log('=== CONFIRM ORDER CALLED ===');
            console.log('checkoutCustomerInfo:', checkoutCustomerInfo);
            console.log('Address ID in checkoutCustomerInfo:', checkoutCustomerInfo.address_id);
            
            // Validate address selection in Step 2
            if (!validateAddressForm()) {
                console.log('Address validation failed in Step 2');
                return;
            }
            
            // Process checkout and redirect to invoice
            closeCheckoutContainer();
            await processCheckout('PENDING');
        }


        function prefillCustomerForm() {
            console.log('prefillCustomerForm called with loggedInUserInfo:', loggedInUserInfo);
            
            if (loggedInUserInfo) {
                // Pre-fill the customer form with logged-in user information
                const nameField = document.getElementById('name');
                const emailField = document.getElementById('email');
                const phoneField = document.getElementById('phone');
                
                console.log('Form fields found:', { nameField, emailField, phoneField });
                
                if (nameField) nameField.value = loggedInUserInfo.name || '';
                if (emailField) emailField.value = loggedInUserInfo.email || '';
                if (phoneField) phoneField.value = loggedInUserInfo.phone || '';
                
                // Address loading is handled by loadCustomerAddresses() which is called separately
                
                console.log('Form fields updated with values:', {
                    name: nameField?.value,
                    email: emailField?.value,
                    phone: phoneField?.value
                });
                
                // Show the pre-fill notification
                const notification = document.getElementById('prefill-notification');
                if (notification) {
                    notification.style.display = 'block';
                    console.log('Pre-fill notification shown');
                } else {
                    console.log('Pre-fill notification not found');
                }
                
                console.log('Customer form pre-filled with user info:', loggedInUserInfo);
            } else {
                console.log('No loggedInUserInfo available for pre-fill');
            }
        }

        function prefillAddressFields(addressData) {
            console.log('prefillAddressFields called with:', addressData);
            
            // Address type is now hardcoded to 'home' in the backend
            
            // Pre-fill atomic address fields (now editable input fields)
            const fields = [
                'house_number', 'street_name', 'village', 'sangkat', 
                'commune', 'khan', 'province', 'postal_code',
                'building_name', 'landmark', 'floor_number', 'unit_number', 'delivery_notes'
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                console.log(`Field ${field}:`, element, 'Value:', addressData[field]);
                if (element && addressData[field]) {
                    element.value = addressData[field];
                    console.log(`Set ${field} to:`, addressData[field]);
                } else if (element) {
                    // Clear field if no value
                    element.value = '';
                    console.log(`Cleared ${field}`);
                }
            });
            
            // Log the final values to verify
            console.log('Final field values:');
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    console.log(`${field}: ${element.value}`);
                }
            });
            
            // Show a visual indication that fields have been filled
            console.log('‚úÖ All atomic address fields have been auto-filled');
        }
        
        function updateAddressDisplay(addressData) {
            // Update the display fields in Step 2
            const displayFields = [
                'display-house-number', 'display-street-name', 'display-village', 'display-sangkat',
                'display-commune', 'display-khan', 'display-province', 'display-postal-code',
                'display-building-name', 'display-landmark', 'display-floor-number', 'display-unit-number',
                'display-delivery-notes'
            ];
            
            const fieldMapping = {
                'display-house-number': 'house_number',
                'display-street-name': 'street_name',
                'display-village': 'village',
                'display-sangkat': 'sangkat',
                'display-commune': 'commune',
                'display-khan': 'khan',
                'display-province': 'province',
                'display-postal-code': 'postal_code',
                'display-building-name': 'building_name',
                'display-landmark': 'landmark',
                'display-floor-number': 'floor_number',
                'display-unit-number': 'unit_number',
                'display-delivery-notes': 'delivery_notes'
            };
            
            displayFields.forEach(displayField => {
                const element = document.getElementById(displayField);
                const dataField = fieldMapping[displayField];
                if (element && addressData[dataField]) {
                    element.textContent = addressData[dataField];
                } else if (element) {
                    element.textContent = '-';
                }
            });
            
            // Show the atomic address display
            const atomicDisplay = document.getElementById('atomic-address-display');
            if (atomicDisplay) {
                atomicDisplay.style.display = 'block';
            }
        }

        async function fetchDefaultAddress() {
            try {
                console.log('Fetching default address...');
                const response = await fetch('/api/customer/addresses/default');
                const result = await response.json();
                
                console.log('Default address response:', result);
                
                if (result.success && result.address) {
                    prefillAddressFields(result.address);
                    console.log('Default address loaded and prefilled:', result.address);
                    
                    // Show success notification
                    const notification = document.getElementById('prefill-notification');
                    if (notification) {
                        notification.querySelector('.prefill-message').innerHTML = 
                            '<i class="fas fa-user-check" style="color: #28a745; margin-right: 8px;"></i>' +
                            'Your information has been pre-filled from your account';
                        notification.style.display = 'block';
                    }
                } else {
                    console.log('No default address found or error:', result);
                    // Show a subtle notification that address fields are empty
                    const notification = document.getElementById('prefill-notification');
                    if (notification) {
                        notification.querySelector('.prefill-message').innerHTML = 
                            '<i class="fas fa-info-circle" style="color: #17a2b8; margin-right: 8px;"></i>' +
                            'Basic info pre-filled. Please complete address details.';
                        notification.style.display = 'block';
                    }
                }
            } catch (error) {
                console.log('Error fetching default address:', error);
            }
        }

        function toggleAddressDetails() {
            const detailsSection = document.getElementById('address-details');
            const toggleButton = document.getElementById('toggle-address-details');
            const icon = toggleButton.querySelector('i');
            
            if (detailsSection.style.display === 'none') {
                detailsSection.style.display = 'block';
                toggleButton.innerHTML = '<i class="fas fa-minus"></i> Hide details';
                toggleButton.classList.remove('btn-outline-secondary');
                toggleButton.classList.add('btn-outline-primary');
            } else {
                detailsSection.style.display = 'none';
                toggleButton.innerHTML = '<i class="fas fa-plus"></i> Add more details';
                toggleButton.classList.remove('btn-outline-primary');
                toggleButton.classList.add('btn-outline-secondary');
            }
        }

        function resetCheckoutForm() {
            // Reset the form
            const form = document.getElementById('customer-form');
            if (form) {
                form.reset();
            }
            
            // Reset all form fields manually to ensure they're cleared
            const formFields = [
                'customer_name', 'customer_email', 'customer_phone',
                'street_name', 'province', 'house_number', 'village', 
                'sangkat', 'commune', 'khan', 'postal_code',
                'building_name', 'landmark', 'floor_number', 
                'unit_number', 'delivery_notes'
            ];
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
            
            // Reset step and variables
            currentCheckoutStep = 1;
            selectedPaymentMethod = 'KHQR_BAKONG';
            checkoutCustomerInfo = {};
            showCheckoutStep(1);
            
            // Hide the pre-fill notification
            const notification = document.getElementById('prefill-notification');
            if (notification) {
                notification.style.display = 'none';
            }
            
            // Hide the pre-fill button
            const prefillButtonContainer = document.getElementById('prefill-button-container');
            if (prefillButtonContainer) {
                prefillButtonContainer.style.display = 'none';
            }
            
            // Hide address details section
            const addressDetails = document.getElementById('address-details');
            if (addressDetails) {
                addressDetails.style.display = 'none';
            }
            
            console.log('Checkout form reset completed');
        }





        // Update the buy button to use the new checkout container
        document.getElementById('buy-button').onclick = function() {
            if (cartItems.length > 0) {
                // Check if user is logged in before opening checkout
                if (loggedInUserInfo && loggedInUserInfo.id) {
                    openCheckoutContainer();
                } else {
                    // Show login required modal
                    showLoginRequiredModal();
                }
            }
        };

        // Login Required Modal Functions
        function showLoginRequiredModal() {
            const modal = document.getElementById('login-required-modal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeLoginModal() {
            const modal = document.getElementById('login-required-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        function redirectToLogin() {
            // Store current page URL to redirect back after login
            const currentUrl = window.location.href;
            localStorage.setItem('redirectAfterLogin', currentUrl);
            
            // Also store in session for OTP users
            fetch('/api/store-redirect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ redirect_url: currentUrl })
            }).catch(error => {
                console.log('Could not store redirect URL in session:', error);
            });
            
            // Redirect to login page
            window.location.href = '/login';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const loginModal = document.getElementById('login-required-modal');
            if (event.target === loginModal) {
                closeLoginModal();
            }
        }

        // Make functions globally available
        window.cancelCashPayment = cancelCashPayment;
        window.showLoginRequiredModal = showLoginRequiredModal;
        window.closeLoginModal = closeLoginModal;
        window.redirectToLogin = redirectToLogin;
        window.confirmCashPayment = confirmCashPayment;
        window.testKHQRPayment = testKHQRPayment;
        window.testAddressSelection = testAddressSelection;
        window.testCashPaymentFlow = testCashPaymentFlow;
        window.debugAddressSelection = debugAddressSelection;
        window.editSelectedAddress = editSelectedAddress;
        window.saveEditedAddress = saveEditedAddress;
        window.closeEditModal = closeEditModal;
        window.openCheckoutContainer = openCheckoutContainer;
        window.closeCheckoutContainer = closeCheckoutContainer;
        window.nextCheckoutStep = nextCheckoutStep;
        window.previousCheckoutStep = previousCheckoutStep;
        window.proceedToConfirmation = proceedToConfirmation;
        window.confirmOrder = confirmOrder;
        window.prefillCustomerForm = prefillCustomerForm;
        window.showCustomNotification = showCustomNotification;
        window.selectAddress = selectAddress;
        window.openAddAddressModal = openAddAddressModal;
        window.closeAddAddressModal = closeAddAddressModal;
        window.saveNewAddress = saveNewAddress;
        window.saveCurrentAddress = saveCurrentAddress;
        
        // Enhanced save address function with visual feedback
        async function saveCurrentAddressWithFeedback() {
            const button = document.getElementById('save-current-address-btn');
            const icon = document.getElementById('save-icon');
            const text = document.getElementById('save-text');
            
            if (!button || !icon || !text) {
                console.error('Save address button elements not found');
                return;
            }
            
            // Disable button and show loading state
            button.disabled = true;
            button.style.opacity = '0.7';
            icon.className = 'fas fa-spinner fa-spin';
            text.textContent = 'Saving...';
            
            try {
                await saveCurrentAddress();
                
                // Show success state briefly
                icon.className = 'fas fa-check';
                text.textContent = 'Saved!';
                button.style.backgroundColor = '#28a745';
                
                // Reset after 2 seconds
                setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    icon.className = 'fas fa-save';
                    text.textContent = 'Save Address';
                    button.style.backgroundColor = '#28a745';
                }, 2000);
                
            } catch (error) {
                console.error('Error saving address:', error);
                
                // Show error state
                icon.className = 'fas fa-exclamation-triangle';
                text.textContent = 'Error';
                button.style.backgroundColor = '#dc3545';
                
                // Reset after 3 seconds
                setTimeout(() => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    icon.className = 'fas fa-save';
                    text.textContent = 'Save Address';
                    button.style.backgroundColor = '#28a745';
                }, 3000);
            }
        }
        
        window.saveCurrentAddressWithFeedback = saveCurrentAddressWithFeedback;

        // Payment Verification Modal
        const verifyPaymentBtn = document.getElementById('verify-payment-btn');
        const paymentVerificationModal = document.getElementById('payment-verification-modal');
        const closeVerificationModal = document.getElementById('close-verification-modal');
        
        // Find Order Modal
        const findOrderBtn = document.getElementById('find-order-btn');
        const findOrderModal = document.getElementById('find-order-modal');
        const closeFindOrderModal = document.getElementById('close-find-order-modal');
        const findOrderForm = document.getElementById('find-order-form');
        const searchResults = document.getElementById('search-results');
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('payment-screenshot');
        const filePreview = document.getElementById('file-preview');
        const fileName = document.getElementById('file-name');
        const removeFileBtn = document.getElementById('remove-file');
        const form = document.getElementById('payment-verification-form');
        const submitBtn = document.getElementById('submit-btn');
        const resultDiv = document.getElementById('verification-result');

        // Show payment verification modal
        verifyPaymentBtn.addEventListener('click', () => {
            paymentVerificationModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });

        // Show find order modal
        findOrderBtn.addEventListener('click', () => {
            findOrderModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });

        // Close find order modal
        closeFindOrderModal.addEventListener('click', () => {
            findOrderModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            findOrderForm.reset();
            searchResults.style.display = 'none';
        });

        // Close find order modal when clicking outside
        findOrderModal.addEventListener('click', (e) => {
            if (e.target === findOrderModal) {
                findOrderModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                findOrderForm.reset();
                searchResults.style.display = 'none';
            }
        });

        // Close payment verification modal
        closeVerificationModal.addEventListener('click', () => {
            paymentVerificationModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            form.reset();
            filePreview.style.display = 'none';
            resultDiv.style.display = 'none';
        });

        // Close modal when clicking outside
        paymentVerificationModal.addEventListener('click', (e) => {
            if (e.target === paymentVerificationModal) {
                paymentVerificationModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                form.reset();
                filePreview.style.display = 'none';
                resultDiv.style.display = 'none';
            }
        });

        // File upload handling
        fileUploadArea.addEventListener('click', () => fileInput.click());
        
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.style.background = '#e8f5e8';
            fileUploadArea.style.borderColor = '#17a2b8';
        });
        
        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.style.background = '#f8f9fa';
            fileUploadArea.style.borderColor = '#17a2b8';
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.background = '#f8f9fa';
            fileUploadArea.style.borderColor = '#17a2b8';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                showFilePreview(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                showFilePreview(e.target.files[0]);
            }
        });

        removeFileBtn.addEventListener('click', () => {
            fileInput.value = '';
            filePreview.style.display = 'none';
        });

        function showFilePreview(file) {
            fileName.textContent = file.name;
            filePreview.style.display = 'block';
            
            // Auto-extract order ID and transaction ID from the uploaded file
            extractOrderInfoFromFile(file);
        }

        function extractOrderInfoFromFile(file) {
            // Show loading state
            const orderIdInput = document.getElementById('order-id');
            const transactionIdInput = document.getElementById('transaction-id');
            
            // Add loading indicators
            orderIdInput.placeholder = 'Extracting Order ID...';
            transactionIdInput.placeholder = 'Extracting Transaction ID...';
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('file', file);
            
            // Send file to server for extraction
            fetch('/api/payment/extract-order-info', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Auto-fill the extracted information
                    if (data.order_id) {
                        orderIdInput.value = data.order_id;
                        orderIdInput.style.borderColor = '#28a745';
                        orderIdInput.placeholder = 'Order ID detected!';
                    }
                    
                    if (data.transaction_id) {
                        transactionIdInput.value = data.transaction_id;
                        transactionIdInput.style.borderColor = '#28a745';
                        transactionIdInput.placeholder = 'Transaction ID detected!';
                    }
                    
                    // Show success message
                    let message = `‚úÖ Smart Detection Complete!\n\nOrder ID: ${data.order_id || 'Not found'}`;
                    if (data.transaction_id) {
                        message += `\nTransaction ID: ${data.transaction_id}`;
                    } else {
                        message += `\nTransaction ID: Not found (QR codes don't contain this)`;
                    }
                    showCustomNotification(message, 'success');
                } else {
                    // Reset placeholders if extraction failed
                    orderIdInput.placeholder = 'Auto-detection failed - enter manually';
                    transactionIdInput.placeholder = 'Auto-detection failed - enter manually';
                    orderIdInput.style.borderColor = '#ffc107';
                    transactionIdInput.style.borderColor = '#ffc107';
                    
                    showCustomNotification(
                        '‚ö†Ô∏è Could not auto-detect order information. No worries! Our staff will review your upload and help you complete the payment verification.',
                        'warning'
                    );
                }
            })
            .catch(error => {
                console.error('Extraction error:', error);
                orderIdInput.placeholder = 'Auto-detection failed - enter manually';
                transactionIdInput.placeholder = 'Auto-detection failed - enter manually';
                orderIdInput.style.borderColor = '#dc3545';
                transactionIdInput.style.borderColor = '#dc3545';
            });
        }

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const orderId = formData.get('order_id');
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/api/payment/verify-upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = `<h4><i class="fas fa-check-circle" style="color: #17a2b8;"></i> Payment Verified Successfully!</h4><p><strong>Order #${orderId}</strong> has been verified!</p>`;
                    
                    if (result.order_status === 'COMPLETED') {
                        message += `<p>üéâ <strong>Order Completed!</strong> Your payment was automatically verified and the order is now complete. Your items are being prepared!</p>`;
                    } else if (result.order_status === 'PENDING (QR Payment Verified)') {
                        message += `<p>üì± <strong>Payment Proof Uploaded!</strong> Your payment proof has been uploaded. Our staff will review it and complete the verification soon.</p>`;
                    } else {
                        message += `<p>‚è≥ <strong>Payment Proof Uploaded!</strong> Your payment proof has been uploaded. Our staff will review it and help resolve any issues.</p>`;
                    }
                    
                    message += `<p>You will receive a confirmation email once your order is processed.</p>`;
                    
                    showResult('success', message);
                    form.reset();
                    filePreview.style.display = 'none';
                } else {
                    showResult('error', `
                        <h4><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Verification Failed</h4>
                        <p>${result.error}</p>
                        <p>Please check your Order ID and try again, or contact support if the problem persists.</p>
                    `);
                }
            } catch (error) {
                showResult('error', `
                    <h4><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Upload Error</h4>
                    <p>There was an error uploading your payment verification. Please try again.</p>
                `);
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-upload"></i> Verify Payment';
                submitBtn.disabled = false;
            }
        });

        function showResult(type, message) {
            resultDiv.innerHTML = message;
            resultDiv.style.display = 'block';
            resultDiv.className = `alert alert-${type}`;
            resultDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            resultDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
            resultDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            resultDiv.style.padding = '20px';
            resultDiv.style.borderRadius = '5px';
            resultDiv.style.marginTop = '20px';
            
            // Scroll to result
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Find order form submission
        findOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('search-email').value.trim();
            const phone = document.getElementById('search-phone').value.trim();
            
            if (!email && !phone) {
                showSearchResult('error', 'Please provide either email or phone number to search.');
                return;
            }
            
            // Show loading state
            const searchBtn = document.getElementById('search-orders-btn');
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
            searchBtn.disabled = true;
            
            try {
                const response = await fetch('/api/orders/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, phone })
                });
                
                const result = await response.json();
                
                if (result.success && result.orders.length > 0) {
                    showOrderResults(result.orders);
                } else {
                    showSearchResult('error', 'No orders found. Please check your email or phone number and try again.');
                }
            } catch (error) {
                showSearchResult('error', 'Error searching for orders. Please try again.');
            } finally {
                searchBtn.innerHTML = '<i class="fas fa-search"></i> Search Orders';
                searchBtn.disabled = false;
            }
        });

        function showOrderResults(orders) {
            let html = '<h4 style="color: #28a745; margin-bottom: 15px;"><i class="fas fa-check-circle"></i> Found Orders</h4>';
            
            orders.forEach(order => {
                const statusColor = order.status === 'PENDING' ? '#ffc107' : 
                                  order.status === 'COMPLETED' ? '#28a745' : '#dc3545';
                
                html += `
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer;" 
                         onclick="selectOrder(${order.id})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Order #${order.id}</strong>
                                <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 10px; font-size: 12px;">
                                    ${order.status}
                                </span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: #333;">$${order.total_amount}</div>
                                <div style="font-size: 12px; color: #666;">${order.order_date}</div>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 14px; color: #666;">
                            Payment Method: ${order.payment_method}
                            ${order.transaction_id ? `<br>Transaction ID: ${order.transaction_id}` : ''}
                        </div>
                    </div>
                `;
            });
            
            searchResults.innerHTML = html;
            searchResults.style.display = 'block';
        }

        function showSearchResult(type, message) {
            searchResults.innerHTML = `
                <div style="background: ${type === 'error' ? '#f8d7da' : '#d4edda'}; 
                            border: 1px solid ${type === 'error' ? '#f5c6cb' : '#c3e6cb'}; 
                            color: ${type === 'error' ? '#721c24' : '#155724'}; 
                            padding: 15px; border-radius: 5px;">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i>
                    ${message}
                </div>
            `;
            searchResults.style.display = 'block';
        }

        // Select order function
        window.selectOrder = function(orderId) {
            document.getElementById('order-id').value = orderId;
            findOrderModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            findOrderForm.reset();
            searchResults.style.display = 'none';
            
            // Show success message
            showCustomNotification(`Order #${orderId} selected! You can now upload your payment screenshot.`, 'success');
        };

    </script>
    
    <!-- Add Address Modal -->
    <div id="add-address-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìç Add New Address</h2>
                <span class="close-button" onclick="closeAddAddressModal()" style="font-size: 24px; cursor: pointer;">&times;</span>
            </div>
            
            <form id="add-address-form">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="modal_house_number">House Number</label>
                        <input type="text" id="modal_house_number" name="house_number" placeholder="#123, St. 123" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="modal_street_name">Street Name</label>
                    <input type="text" id="modal_street_name" name="street_name" placeholder="Street 271, Main Road, st137" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="modal_village">Village</label>
                        <input type="text" id="modal_village" name="village" placeholder="Village name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label for="modal_sangkat">Sangkat</label>
                        <input type="text" id="modal_sangkat" name="sangkat" placeholder="Sangkat name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="modal_khan">Khan</label>
                        <input type="text" id="modal_khan" name="khan" placeholder="Khan name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label for="modal_commune">Commune (Optional)</label>
                        <input type="text" id="modal_commune" name="commune" placeholder="Commune name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="modal_province">Province</label>
                        <input type="text" id="modal_province" name="province" placeholder="Phnom Penh" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label for="modal_postal_code">Postal Code</label>
                        <input type="text" id="modal_postal_code" name="postal_code" placeholder="12345" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="modal_building_name">Building Name (Optional)</label>
                        <input type="text" id="modal_building_name" name="building_name" placeholder="Building name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label for="modal_landmark">Landmark (Optional)</label>
                        <input type="text" id="modal_landmark" name="landmark" placeholder="Near Central Market" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="modal_floor_number">Floor (Optional)</label>
                        <input type="text" id="modal_floor_number" name="floor_number" placeholder="Floor 3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label for="modal_unit_number">Unit (Optional)</label>
                        <input type="text" id="modal_unit_number" name="unit_number" placeholder="Unit 301" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="modal_delivery_notes">Delivery Notes (Optional)</label>
                    <textarea id="modal_delivery_notes" name="delivery_notes" placeholder="Special delivery instructions" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; min-height: 80px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddAddressModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
</html>