{% extends "base.html" %}

{% block title %}Sales Reports{% endblock %}

{% block content %}
<div class="staff-container">
    <h1><i class="fas fa-chart-bar"></i> Sales Reports</h1>

    <div class="staff-widgets">
        <!-- Date Range Filter Widget -->
        <div class="widget date-range-widget">
            <div class="widget-header">
                <div class="header-content">
                    <h2><i class="fas fa-calendar-range"></i> Date Range Filter</h2>
                </div>
                <div class="header-actions">
                    <button type="button" class="btn btn-sm btn-export-pdf" id="exportDateRangePDF" title="Export to PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-export-csv" id="exportDateRangeCSV" title="Export to CSV">
                        <i class="fas fa-file-csv"></i>
                    </button>
                </div>
            </div>
            <div class="widget-content">
                <!-- Date Inputs -->
                <div class="date-inputs">
                    <div class="date-input-group">
                        <label for="startDate">From Date:</label>
                        <input type="date" id="startDate" class="form-control" />
                    </div>
                    <div class="date-input-group">
                        <label for="endDate">To Date:</label>
                        <input type="date" id="endDate" class="form-control" />
                    </div>
                </div>
                
                <!-- Day List Table -->
                <div class="day-list-container">
                    <div class="day-list-header">
                        <h4><i class="fas fa-table"></i> Days in Range</h4>
                        <p class="day-list-subtitle">Click "View" to see detailed data for each day</p>
                    </div>
                    <div class="day-list-wrapper">
                        <table class="day-list-table">
                            <thead>
                                <tr>
                                    <th class="day-column">DAY</th>
                                    <th class="date-column">DATE</th>
                                    <th class="revenue-column">DAILY REVENUE</th>
                                    <th class="orders-column">ORDERS</th>
                                    <th class="actions-column">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="dayList">
                                <!-- Days will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- This Year Revenue Widget -->
        <div class="widget yearly-revenue-widget">
            <div class="widget-header">
                <div class="header-content">
                    <h2><i class="fas fa-calendar-year"></i> This Year Revenue</h2>
                    <p class="widget-subtitle">Monthly revenue breakdown with detailed order information</p>
                </div>
                <div class="header-actions">
                    <button type="button" class="btn btn-sm btn-export-pdf" id="exportYearlyRevenuePDF">
                        <i class="fas fa-file-pdf"></i> Export to PDF
                    </button>
                </div>
            </div>
            <div class="widget-content">
                <!-- Yearly Revenue Summary Cards - REMOVED -->

                <!-- Yearly Revenue Table -->
                <div class="revenue-table-container">
                    <div class="table-header">
                        <h4><i class="fas fa-table"></i> Monthly Revenue Breakdown</h4>
                        <div class="period-info">
                            <div class="year-selector">
                                <button id="yearlyRevenueYearBtn" class="btn btn-outline-primary btn-sm" onclick="toggleYearSelector()">
                                    <i class="fas fa-calendar"></i> <span id="yearlyRevenueYear">2025</span> <i class="fas fa-chevron-down"></i>
                                </button>
                                <div id="yearSelectorDropdown" class="year-dropdown" style="display: none;">
                                    <div class="year-option" onclick="selectYear(2025)">2025</div>
                                    <div class="year-option" onclick="selectYear(2024)">2024</div>
                                    <div class="year-option" onclick="selectYear(2023)">2023</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover revenue-table">
                            <thead>
                                <tr>
                                    <th class="date-column">Month</th>
                                    <th class="orders-column">Orders</th>
                                    <th class="revenue-column">Monthly Revenue</th>
                                    <th class="trend-column">Trend</th>
                                    <th class="actions-column">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="yearlyRevenueTable">
                                <tr><td colspan="5" class="loading-message">Loading yearly data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <p id="yearlyRevenueMessage" class="no-data-message" style="display: none;">No yearly revenue data available.</p>
                </div>
            </div>
        </div>

        <!-- This Month Revenue Widget -->
        <div class="widget monthly-revenue-widget">
            <div class="widget-header">
                <div class="header-content">
                    <h2><i class="fas fa-calendar-alt"></i> This Month Revenue</h2>
                    <p class="widget-subtitle">Click any date to see detailed order information</p>
                </div>
                <div class="header-actions">
                    <button type="button" class="btn btn-sm btn-export-pdf" id="exportMonthlyRevenuePDF">
                        <i class="fas fa-file-pdf"></i> Export to PDF
                    </button>
                </div>
            </div>
            <div class="widget-content">
                <!-- Revenue Summary Cards -->
                <div class="revenue-summary-cards">
                    <div class="revenue-summary-card total-revenue">
                        <div class="card-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="monthlyTotalRevenue">$0</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="revenue-summary-card total-orders">
                        <div class="card-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="monthlyTotalOrders">0</h3>
                            <p>Total Orders</p>
                        </div>
                    </div>
                    <div class="revenue-summary-card avg-daily">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="monthlyAvgDaily">$0</h3>
                            <p>Avg. Daily Revenue</p>
                        </div>
                    </div>
                    <div class="revenue-summary-card best-day">
                        <div class="card-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="monthlyBestDay">-</h3>
                            <p>Best Day</p>
                        </div>
                    </div>
                </div>

                <!-- Revenue Table with Better Styling -->
                <div class="revenue-table-container">
                    <div class="table-header">
                        <h4><i class="fas fa-table"></i> Daily Revenue Breakdown</h4>
                        <div class="period-info">
                            <span class="period-badge">
                                <i class="fas fa-calendar"></i> Aug 5-12, 2025
                            </span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover revenue-table">
                            <thead>
                                <tr>
                                    <th class="date-column">Date</th>
                                    <th class="orders-column">Orders</th>
                                    <th class="revenue-column">Daily Revenue</th>
                                    <th class="trend-column">Trend</th>
                                    <th class="actions-column">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyRevenueTable">
                                <tr><td colspan="5" class="loading-message">Loading revenue data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <p id="monthlyRevenueMessage" class="no-data-message" style="display: none;">No revenue data available for this period.</p>
                </div>


            </div>
        </div>

        <!-- Top Selling Products Widget -->
        <div class="widget top-selling-products-widget">
            <div class="widget-header">
                <div class="header-content">
                    <h2><i class="fas fa-chart-line"></i> Top Selling Products</h2>
                    <p class="widget-subtitle">Best performing products by revenue and quantity</p>
                </div>
                <div class="header-actions">
                    <button type="button" class="btn btn-sm export-pdf" id="exportTopSellingProductsPDF">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button type="button" class="btn btn-sm btn-outline" id="toggleTopProductsView">
                        <i class="fas fa-chart-bar"></i> Chart View
                    </button>
                </div>
            </div>
            <div class="widget-content">
                <!-- Summary Cards -->
                <div class="summary-cards">
                    <div class="summary-card total-revenue">
                        <div class="card-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="totalRevenue">$0</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="summary-card total-products">
                        <div class="card-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="totalProducts">0</h3>
                            <p>Products Sold</p>
                        </div>
                    </div>
                    <div class="summary-card avg-price">
                        <div class="card-icon">
                            <i class="fas fa-tag"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="avgPrice">$0</h3>
                            <p>Avg. Price</p>
                        </div>
                    </div>
                </div>

                <!-- Chart View (Hidden by default) -->
                <div class="chart-container" id="topProductsChartContainer" style="display: none;">
                    <canvas id="topProductsChart"></canvas>
                </div>

                <!-- Table View -->
                <div class="table-container" id="topProductsTableContainer">
                    <div class="table-header">
                        <div class="table-filters">
                            <select id="topProductsSortBy" class="form-control form-control-sm">
                                <option value="revenue">Sort by Revenue</option>
                                <option value="quantity">Sort by Quantity</option>
                                <option value="name">Sort by Name</option>
                            </select>
                            <input type="text" id="topProductsSearch" class="form-control form-control-sm" placeholder="Search products...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover enhanced-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="rank">#</th>
                                    <th class="sortable" data-sort="name">Product Name</th>
                                    <th class="sortable" data-sort="quantity">Quantity Sold</th>
                                    <th class="sortable" data-sort="revenue">Total Revenue</th>
                                    <th class="sortable" data-sort="avgPrice">Avg. Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="topSellingProductsTable">
                                <tr><td colspan="6" class="loading-row">Loading top selling products...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <p id="topSellingProductsMessage" class="no-data-message" style="display: none;">No top selling products data available.</p>
            </div>
        </div>

        <!-- Top Selling Products by Category Widget -->
        <div class="widget top-selling-products-by-category-widget">
            <div class="widget-header">
                <div class="header-content">
                    <h2><i class="fas fa-chart-pie"></i> Top Selling Products by Category</h2>
                    <p class="widget-subtitle">Category performance analysis by revenue and sales volume</p>
                </div>
                <div class="header-actions">
                    <button type="button" class="btn btn-sm export-pdf" id="exportTopSellingProductsByCategoryPDF">
                        <i class="fas fa-file-pdf"></i> Export to PDF
                    </button>
                </div>
            </div>
            <div class="widget-content">
                <!-- Table View -->
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover enhanced-table">
                            <thead>
                                <tr>
                                    <th>Category Name</th>
                                    <th>Total Products Sold</th>
                                    <th>Total Revenue</th>
                                    <th>Performance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="topSellingProductsByCategoryTable">
                                <tr><td colspan="5">Loading top selling products by category...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <p id="topSellingProductsByCategoryMessage" class="no-data-message" style="display: none;">No top selling products by category data available.</p>
            </div>
        </div>

        <!-- Customer Discount History Widget -->
        <div class="widget">
            <div class="widget-header">
                <h2><i class="fas fa-users"></i> Customer Discount History</h2>
                <button type="button" class="btn btn-sm export-pdf" id="exportCustomerHistoryPDF">Export to PDF</button>
            </div>
            <div class="widget-content">
                <!-- Customer Search -->
                <div class="customer-search-section">
                    <div class="search-input-group">
                        <input type="text" id="customer-search-input" class="form-control" placeholder="Search customer by name, email, or phone...">
                        <button type="button" class="btn btn-primary" id="search-customer-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button type="button" class="btn btn-secondary" id="show-recent-customers-btn">
                            <i class="fas fa-clock"></i> Recent Activity
                        </button>
                    </div>
                </div>

                <!-- Customer History Results -->
                <div class="customer-history-results" id="customer-history-results" style="display: none;">
                    <div class="customer-info-card" id="customer-info-card">
                        <!-- Customer details will be populated here -->
                    </div>

                    <div class="discount-history-table">
                        <h4><i class="fas fa-history"></i> Discount History</h4>
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #aaa; font-weight: 400;">
                            <thead>
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #888; background-color: #f5f5f5;">Date</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #888; background-color: #f5f5f5;">Product</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #888; background-color: #f5f5f5;">Original Price</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #888; background-color: #f5f5f5;">Discount %</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #888; background-color: #f5f5f5;">Final Price</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #888; background-color: #f5f5f5;">Savings</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #888; background-color: #f5f5f5;">Staff Member</th>
                                </tr>
                            </thead>
                            <tbody id="discount-history-table-body">
                                <!-- History will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="customer-insights">
                        <div class="insight-cards">
                            <div class="insight-card">
                                <div class="insight-icon"><i class="fas fa-percentage"></i></div>
                                <div class="insight-content">
                                    <div class="insight-label">Most Common Discount</div>
                                    <div class="insight-value" id="common-discount">-</div>
                                </div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-icon"><i class="fas fa-shopping-cart"></i></div>
                                <div class="insight-content">
                                    <div class="insight-label">Total Purchases</div>
                                    <div class="insight-value" id="total-purchases">-</div>
                                </div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-icon"><i class="fas fa-dollar-sign"></i></div>
                                <div class="insight-content">
                                    <div class="insight-label">Total Savings</div>
                                    <div class="insight-value" id="total-savings">-</div>
                                </div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-icon"><i class="fas fa-calendar"></i></div>
                                <div class="insight-content">
                                    <div class="insight-label">Last Visit</div>
                                    <div class="insight-value" id="last-visit">-</div>
                                </div>
                            </div>
                        </div>

                        <div class="suggested-pricing">
                            <h5><i class="fas fa-lightbulb"></i> Suggested Pricing</h5>
                            <div class="pricing-suggestion" id="pricing-suggestion">
                                <!-- Suggestions will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Customer Activity -->
                <div class="recent-customer-activity" id="recent-customer-activity" style="display: none;">
                    <h4><i class="fas fa-clock"></i> Recent Customer Activity</h4>
                    <div class="recent-customers-list" id="recent-customers-list">
                        <!-- Recent customers will be populated here -->
                    </div>
                </div>

                <!-- No Results Message -->
                <div class="no-results-message" id="no-customer-results" style="display: none;">
                    <i class="fas fa-search"></i>
                    <p>No customer found. Try searching by name, email, or phone number.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productDetailsModalLabel">
                    <i class="fas fa-info-circle"></i> Product Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="product-details-content">
                    <!-- Product details will be populated here -->
                </div>
                
                <!-- Order List Section -->
                <div class="order-list-section" id="orderListSection" style="display: none;">
                    <h6><i class="fas fa-list"></i> Order List</h6>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination-controls">
                        <div class="pagination-info">
                            <span class="pagination-text">Orders per page:</span>
                            <select class="pagination-settings" id="productOrdersPerPage">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div class="pagination-buttons">
                            <button class="btn btn-sm btn-outline-secondary" onclick="changeProductPage('prev')">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="page-numbers" id="productPageNumbers">
                                <!-- Page numbers will be populated here -->
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="changeProductPage('next')">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Orders Table -->
                    <div class="table-responsive">
                        <table class="table table-hover orders-table" id="productOrdersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Profit</th>
                                </tr>
                            </thead>
                            <tbody id="productOrdersTableBody">
                                <!-- Orders will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="exportProductDetails">
                    <i class="fas fa-file-pdf"></i> Export to PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Day Detail Modal -->
<div class="modal fade" id="dayDetailModal" tabindex="-1" aria-labelledby="dayDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayDetailModalLabel">
                    <i class="fas fa-calendar-day"></i> Day Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="day-details-content">
                    <!-- Day details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="exportDayDetails">
                    <i class="fas fa-file-export"></i> Export Day Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Day Details Modal -->
<div class="modal fade" id="dayDetailsModal" tabindex="-1" aria-labelledby="dayDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayDetailsModalLabel">
                    <i class="fas fa-calendar-day"></i> Day Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="day-details-content">
                    <!-- Day details will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="exportDayDetails">
                    <i class="fas fa-file-export"></i> Export Day Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Message Container for Notifications -->
<div id="message-container"></div>
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/staff_reports.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/staff_notifications.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Chart.js for enhanced charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF library for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="{{ url_for('static', filename='js/staff_messages.js') }}"></script>
<script src="{{ url_for('static', filename='js/date_range_widget.js') }}"></script>
<script src="{{ url_for('static', filename='js/yearly_revenue.js') }}"></script>
<script src="{{ url_for('static', filename='js/monthly_revenue.js') }}"></script>
<script src="{{ url_for('static', filename='js/top_selling_products.js') }}"></script>
<script src="{{ url_for('static', filename='js/top_selling_products_by_category.js') }}"></script>
<script src="{{ url_for('static', filename='js/customer_history.js') }}"></script>
{% endblock %}

