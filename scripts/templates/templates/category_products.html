<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% if brand %}{{ brand.upper() }} Products{% elif category %}{% if category.name.lower() == 'laptops' or category.name.lower() == 'laptop' or category.name.lower() == 'laptop_gaming' %}Laptops{% elif category.name.lower() == 'desktops' or category.name.lower() == 'desktop' %}Desktops{% elif category.name.lower() == 'accessories' %}Accessories{% else %}{{ category.name.title() }}{% endif %}{% else %}Products in Category{% endif %}</title>
    <link rel="stylesheet" href="/static/css/index.css" />
    <link rel="stylesheet" href="/static/css/style.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        /* Discount Styling - Match Homepage */
        .discount-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }

        .original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9em;
            margin-right: 8px;
        }

        .sale-price {
            color: #e74c3c;
            font-size: 1.2em;
            font-weight: bold;
        }

        .savings-text {
            color: #27ae60;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 3px;
        }

        .price-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        /* Force Add to Cart button to stay green and clickable */
        .simple-add-to-cart {
            background-color: #28a745 !important;
            color: #fff !important;
            border: none !important;
            cursor: pointer !important;
        }

        .simple-add-to-cart:hover {
            background-color: #218838 !important;
            color: #fff !important;
        }

        .simple-add-to-cart:focus {
            background-color: #28a745 !important;
            color: #fff !important;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
        }

        /* Username text styling */
        .username-text {
            font-size: 0.95rem !important;
            font-weight: 400;
        }

        /* Notification styles */
        .notification-badge {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 0px 2px;
            font-size: 0.4rem;
            position: relative;
            top: -2px;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 12px;
            height: 12px;
        }

        .notification-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .notification-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .notification-item.unread {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
        }

        .notification-item.order_cancelled {
            border-left: 4px solid #dc3545;
        }

        .notification-item.recent {
            border: 1px solid #28a745;
            background-color: #f8fff9;
        }

        .notification-date {
            color: #666;
            font-size: 12px;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: black;
            text-decoration: none;
        }

        
/* Hide Categories Sidebar on screens smaller than 1024px */
@media (max-width: 1400px) {
  /* Hide sidebar by default */
  .col-lg-2.col-md-3.col-12,
  .category-sidebar {
    display: none;
  }

  /* Show sidebar when toggled */
  .category-sidebar.show {
    display: block;
    position: absolute; /* optional, for overlay effect */
    top: 0;
    left: 0;
    width: 250px; /* adjust width */
    height: 100%;
    background-color: #f8f8f8;
    z-index: 1000;
    padding: 20px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.2);
  }

  /* Sidebar toggle button */
  .sidebar-toggle {
    margin-bottom: 20px;
    padding: 10px 20px;
    background-color: #e67e22;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s, transform 0.3s;
  }

  .sidebar-toggle:hover {
    background-color: #d35400;
    transform: scale(1.05);
  }

  /* Ensure product sections take full width */
  .col-lg-10.col-md-9.col-12 {
    width: 100%;
  }
}

/* Add triangle after the link text */
.dropdown-link::after {
  margin: 5px;
  content: " ▼"; /* note the space before the arrow */
  display: inline-block;
  transition: transform 0.3s;
}

/* Optional: rotate arrow when expanded */
.dropdown-link[aria-expanded="true"]::after {
  transform: rotate(90deg);
}
    </style>
</head>
<body>
 <header>
  <div class="top-bar">
    <div class="top-header">
      <div class="logo-left">
    <a href="{{ url_for('show_dashboard') }}">
        <img src="/static/icons/logo.jpg" alt="Company Logo" class="logo" />
    </a>
</div>

      <div class="site-title">Russeykeo Computer</div>
      <!-- Hamburger button visible only on mobile -->
      <button
        class="nav-toggle"
        aria-label="Toggle navigation menu"
        aria-expanded="false"
      >
        &#9776;
      </button>
    </div>
    <nav>
      <ul>
        <li><a href="{{ url_for('show_dashboard') }}">Home</a></li>

        <li>
          <a href="#"  class="dropdown-link" aria-haspopup="true" aria-expanded="false">Categories</a>
          <ul class="dropdown" id="categories-dropdown">
            <!-- Categories will be loaded dynamically -->
          </ul>
        </li>
        <li>
          <a href="#"  class="dropdown-link" aria-haspopup="true" aria-expanded="false">Products</a>
          <ul class="dropdown">
            <li><a href="/products/brand/dell">Dell</a></li>
            <li><a href="/products/brand/hp">HP</a></li>
            <li><a href="/products/brand/lenovo">Lenovo</a></li>
            <li><a href="/products/brand/asus">Asus</a></li>
            <li><a href="/products/brand/acer">Acer</a></li>
            <li><a href="/products/brand/razer">Razer</a></li>
          </ul>
        </li>
        <li>
          <a href="#"  class="dropdown-link" aria-haspopup="true" aria-expanded="false">About Company</a>
          <ul class="dropdown">
            <li><a href="{{ url_for('about') }}">About Us</a></li>
            <!-- <li><a href="{{ url_for('services') }}">Our Services</a></li>
            <li><a href="{{ url_for('privacy') }}">Privacy Policy</a></li> -->
          </ul>
        </li>
        <li>
            <a href="{{ url_for('cart') }}" id="cart-link" class="cart-link">
              <div class="cart-icon-container">
                <i class="bi bi-cart3" style="font-size: 24px; margin-right: 8px;"></i>
                <span id="cart-badge" class="cart-badge">0</span>
              </div>
              My Cart
            </a>
        </li>
        {% if not session.username %}
        <li><a href="{{ url_for('auth.register') }}">Create Account</a></li>
        {% endif %}
        {% if session.username %}
          {% if session.role == 'customer' %}
          <li>
            <a href="#" onclick="showNotifications()" id="notifications-link">
              Notifications
              <span
                id="notification-badge"
                class="notification-badge"
                style="display: none;"
                >0</span
              >
            </a>
          </li>
          {% elif session.role in ['staff', 'admin', 'super_admin'] %}
          <li>
            <a href="#" onclick="showNotifications()" id="notifications-link">
              Notifications
              <span
                id="notification-badge"
                class="notification-badge"
                style="display: none;"
                >0</span
              >
            </a>
          </li>
          {% endif %}
        {% endif %}
        {% if session.username %}
        <li class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle d-flex align-items-center text-white"
            href="#"
            id="userDropdown"
            role="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <i class="bi bi-person-circle me-2"></i>
            <span class="username-text">{{ session.username }}</span>
          </a>
          <ul
            class="dropdown-menu dropdown-menu-end custom-dropdown"
            aria-labelledby="userDropdown"
          >
            {% if session.role == 'customer' %}
            <li>
              <a class="dropdown-item" href="{{ url_for('customer_preorders') }}">
                <i class="bi bi-list-check me-2"></i>My Pre-Orders
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{{ url_for('customer_account') }}">
                <i class="bi bi-person me-2"></i>My Account
              </a>
            </li>
            {% elif session.role in ['staff', 'admin', 'super_admin'] %}
            <!-- <li>
              <a class="dropdown-item" href="{{ url_for('customer_preorders') }}">
                <i class="bi bi-list-check me-2"></i>My Pre-Orders
              </a>
            </li> -->
            {% endif %}
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}"
                ><i class="bi bi-box-arrow-right me-2"></i>Logout</a
              >
            </li>
          </ul>
        </li>
        {% else %}
        <li class="nav-item">
          <a
            href="/auth/login"
            class="btn btn-outline-light btn-sm d-flex align-items-center"
          >
            <i class="bi bi-person-plus me-2"></i> Login Account
          </a>
        </li>
        {% endif %}
        <li>
          <form
            class="search-container"
            action="/search"
            method="GET"
            onsubmit="return validateSearch()"
          >
            <button
              type="button"
              class="search-icon"
              tabindex="0"
              aria-label="Search products"
              style="background:none; border:none; padding:0; cursor:pointer;"
            >
              <img
                src="/static/icons/search.png"
                alt="Search Icon"
                style="height: 20px"
              />
            </button>
            <input
              type="text"
              name="q"
              class="search-input"
              placeholder="Search..."
              aria-label="Search products"
              required
            />
            <div class="search-suggestions"></div>
          </form>
        </li>
      </ul>
    </nav>
  </div>
</header>


    <div class="content"> 
        <div class="hero-container">
            <div class="hero-section active">
                <img src="/static/icons/product/macbook.png" alt="MacBook Pro with Retina display" class="hero-image">
                <div class="hero-details">
                    <h1>MacBook Pro</h1>
                    <p class="subheading">with Retina display</p>
                    <h2>$1999</h2>
                </div>
            </div>
            <div class="hero-section">
                <img src="/static/icons/product/asus zenbook.png" alt="Asus Zenbook with OLED display" class="hero-image">
                <div class="hero-details">
                    <h1>Asus Zenbook</h1>
                    <p class="subheading">with OLED display</p>
                    <h2>$2200</h2>
                </div>
            </div>
            <div class="hero-section">
                <img src="/static/icons/product/razer blackwidow.png" alt="Razer Blackwidow Chroma Red Switch Keyboard" class="hero-image">
                <div class="hero-details">
                    <h1>Razer Blackwidow Chroma</h1>
                    <p class="subheading">Red Switch Keyboard</p>
                    <h2>$199</h2>
                </div>
            </div>
            <div class="hero-section">
                <img src="/static/icons/product/asus rog swift.png" alt="Asus Rog Swift Nvidia G-Sync Monitor" class="hero-image">
                <div class="hero-details">
                    <h1>Asus Rog Swift</h1>
                    <p class="subheading">Nvidia G-Sync 21:9 aspect ratio Computer Monitor</p>
                    <h2>$399</h2>
                </div>
            </div>
        </div>
        <div class="navigation-dots">
            <span class="dot active" data-index="0"></span>
            <span class="dot" data-index="1"></span>
            <span class="dot" data-index="2"></span>
            <span class="dot" data-index="3"></span>
        </div>
        
        <div class="categories" >
             <div class="categories">
                <div class="category">
                    <img src="/static/icons/msi.png" alt="Accessories Icon" class="category-icon">
                </div>
                <div class="category">
                    <img src="/static/icons/ASUS.png" alt="Laptops Icon" class="category-icon">
                </div>
                <div class="category">
                    <img src="/static/icons/Lanovo.png" alt="Desktops Icon" class="category-icon">
                </div>
                
                 <div class="category">
                    <img src="/static/icons/Acer.png" alt="PC Components Icon" class="category-icon">
                </div>
                 <div class="category">
                    <img src="/static/icons/Dell.png" alt="PC Components Icon" class="category-icon">
                </div>
                <div class="category">
                    <img src="/static/icons/Razer.png" alt="PC Components Icon" class="category-icon">
                </div>
                <div class="category">
                    <img src="/static/icons/HP.png" alt="PC Components Icon" class="category-icon">
                </div>
                
            </div>
        </div>

        
        
  <div class="custom-container" style="margin: 50px;">
    <div class="row g-4">
        <!-- Categories Sidebar -->
        <div class="col-lg-2 col-md-3 col-12" style="margin: 120px 0px 0px 0px;">
            
            <!-- Filters Section -->
            <div class="filters-sidebar" style="background: #f8f9fa; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <div class="filters-header" style="display: flex; align-items: center; margin-bottom: 20px;">
                    <h5 style="margin: 0; font-weight: bold;">Filters</h5>
                    <i class="fas fa-chevron-down ms-2" style="color: #666;"></i>
                </div>
                
                <!-- Sort by -->
                <div class="filter-group" style="margin-bottom: 20px;">
                    <label class="form-label" style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center;">
                        <i class="fas fa-sort-amount-up-down me-2" style="color: #666;"></i>
                        Sort by:
                    </label>
                    <select id="priceSort" class="form-select form-select-sm" style="border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Default</option>
                        <option value="low_to_high">Low to High</option>
                        <option value="high_to_low">High to Low</option>
                    </select>
                </div>

                
                
            </div>
            
            <!-- Category Links -->
            <a href="/products/category/70" class="category-link" style="text-decoration: none; color: inherit;">
                <div class="category" style="margin: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
                    <img src="/static/icons/laptop.png" alt="Laptops Icon" class="category-icon" style="width: 40px; height: 40px;">
                    <h4 style="margin: 10px 0 0 0;">Laptops</h4>
                </div>
            </a>
            <a href="/products/category/2" class="category-link" style="text-decoration: none; color: inherit;">
                <div class="category" style="margin: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
                    <img src="/static/icons/desktop.png" alt="Desktops Icon" class="category-icon" style="width: 40px; height: 40px;">
                    <h4 style="margin: 10px 0 0 0;">Desktops</h4>
                </div>
            </a>
            <a href="/products/category/3" class="category-link" style="text-decoration: none; color: inherit;">
                <div class="category" style="margin: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
                    <img src="/static/icons/keyboard.png" alt="Accessories Icon" class="category-icon" style="width: 40px; height: 40px;">
                    <h4 style="margin: 10px 0 0 0;">Accessories</h4>
                </div>
            </a>
            
        </div>
        <!-- Products -->
        <div class="col-lg-10 col-md-9 col-12">
            <h1>{% if brand %}{{ brand.upper() }}{% elif category %}{% if category.name.lower() == 'laptops' or category.name.lower() == 'laptop' or category.name.lower() == 'laptop_gaming' %}Laptops{% elif category.name.lower() == 'desktops' or category.name.lower() == 'desktop' %}Desktops{% elif category.name.lower() == 'accessories' %}Accessories{% else %}{{ category.name.title() }}{% endif %}{% else %}Products in Category{% endif %}</h1>
        
        <!-- Subcategory Filter for categories with subcategories -->
        {% if category and hierarchy %}
        <div class="subcategory-filter mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <label for="subcategorySelect" class="form-label mb-2">
                        <i class="fas fa-filter"></i> Filter by Subcategory:
                    </label>
                    <div class="d-flex gap-2 flex-wrap">
                        <select id="subcategorySelect" class="form-select" onchange="handleMainCategoryChange(this.value)" style="min-width: 200px;">
                            <option value="">All {{ category.name.title() }}</option>
                            {% for subcat in hierarchy %}
                                {% if subcat.level == 0 %}
                                    {% set main_icon_map = {
                                        'monitors': '🖥️',
                                        'monitor': '🖥️',
                                        'display': '🖥️',
                                        'screen': '🖥️',
                                        'gaming_accessories': '🎮',
                                        'gaming': '🎮',
                                        'gamer': '🎮',
                                        'storage': '💾',
                                        'peripherals': '⌨️',
                                        'peripheral': '⌨️',
                                        'input': '⌨️',
                                        'output': '🖥️',
                                        'networking': '🌐',
                                        'network': '🌐',
                                        'cables': '🔌',
                                        'cable': '🔌',
                                        'adapters': '🔌',
                                        'adapter': '🔌',
                                        'laptop_gaming': '🎮💻',
                                        'laptop_office': '💼💻',
                                        'gaming_laptops': '🎮💻',
                                        'business_laptops': '💼💻',
                                        'student_laptops': '📚💻',
                                        'ultrabooks': '📱💻',
                                        'workstation_laptops': '⚙️💻',
                                        'gaming_desktops': '🎮🖥️',
                                        'business_desktops': '💼🖥️',
                                        'workstation_desktops': '⚙️🖥️',
                                        'all_in_one': '🖥️',
                                        'tower_desktops': '🖥️',
                                        'mini_desktops': '📦🖥️'
                                    } %}
                                    {% set main_icon = main_icon_map.get(subcat.name.lower(), '📦') %}
                                    {% if subcat.name.lower() == 'gaming_accessories' %}
                                        <option value="{{ subcat.id }}">{{ main_icon }} Gaming Accessories</option>
                                    {% else %}
                                        <option value="{{ subcat.id }}">{{ main_icon }} {{ subcat.name.title() }}</option>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </select>
                        
                        <!-- Dynamic Sub-dropdown -->
                        <select id="dynamicSubSelect" class="form-select" onchange="handleDynamicSubChange(this.value)" style="min-width: 150px; display: none;">
                            <option value="">All Subcategories</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="filter-info">
                        <span id="productCount" class="badge bg-primary fs-6">Loading...</span>
                        <span class="text-muted ms-2">products found</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if brand and brand_categories %}
        <div class="subcategory-filter mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <label for="categoryFilter" class="form-label mb-2">
                        <i class="fas fa-filter"></i> Filter by Category:
                    </label>
                    <div class="d-flex gap-2 flex-wrap">
                        <select id="categoryFilter" class="form-select" onchange="handleBrandCategoryChange(this.value)" style="min-width: 200px;">
                            <option value="">All {{ brand.title() }} Products</option>
                            {% for cat in brand_categories %}
                                <option value="{{ cat.name }}">
                                    {{ cat.name.title() }} ({{ cat.product_count }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="filter-info">
                        <span id="productCount" class="badge bg-primary fs-6">Loading...</span>
                        <span class="text-muted ms-2">products found</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if products %}
        <!-- Show Products -->
        <div class="row g-4">
            {% for product in products %}
            <div class="col-lg-3 col-md-12">
                <div class="product-card card h-100" data-category-id="{{ product.category_id }}">
                    <!-- Stock Badge -->
                    {% if product.stock > 10 %}
                        <div class="stock-badge in-stock">In Stock</div>
                    {% elif product.stock > 0 %}
                        <div class="stock-badge low-stock">{{ product.stock }} Left</div>
                    {% else %}
                        <div class="stock-badge out-of-stock">Out of Stock</div>
                    {% endif %}
                    
                    <a href="{{ url_for('view_product_by_slug', product_slug=product.name|slugify) }}">
                        <img src="{% if product.photo %}/static/uploads/products/{{ product.photo }}{% else %}/static/images/placeholder-product.jpg{% endif %}" 
                             class="card-img-top p-3" 
                             alt="{{ product.name }}">
                    </a>
                    <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <!-- Price Display with Discount Logic -->
                        {% if product.original_price and product.price < product.original_price %}
                            {% set savings = product.original_price - product.price %}
                            {% set percentage = ((savings / product.original_price) * 100)|round %}
                            <div class="price-container">
                                <div>
                                    <span class="original-price">${{ "%.2f"|format(product.original_price) }}</span>
                                    <span class="sale-price">${{ "%.2f"|format(product.price) }}</span>
                                </div>
                                <div class="savings-text">You Save: ${{ "%.2f"|format(savings) }}</div>
                            </div>
                            <div class="discount-badge">{{ percentage }}% OFF</div>
                        {% else %}
                        <p class="text-primary h5">${{ "%.2f"|format(product.price) }}</p>
                        {% endif %}
                        <p class="card-text text-muted">{{ product.description|truncate(100) }}</p>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex gap-2 mt-3 align-items-center">
                            <a href="{{ url_for('view_product_by_slug', product_slug=product.name|slugify) }}" class="btn btn-primary view-product-btn">View Product</a>
                            {% if product.stock_quantity <= 0 %}
                                {% if product.allow_preorder %}
                                    <!-- Pre-Order Button -->
                                    <button class="btn cart-btn preorder-btn"
                                            data-product-id="{{ product.id }}"
                                            data-product-name="{{ product.name }}"
                                            data-product-price="{{ product.price }}"
                                            data-expected-restock="{{ product.expected_restock_date or '' }}"
                                            data-product-image="{% if product.photo %}/static/uploads/products/{{ product.photo }}{% else %}/static/images/placeholder-product.jpg{% endif %}"
                                            title="Pre-Order this product"
                                            style="background-color: #ffc107; color: #000; border: none; display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-clock"></i>
                                    </button>
                                {% else %}
                                    <!-- Unavailable Button -->
                                    <button class="btn cart-btn"
                                            disabled
                                            style="background-color: #6c757d; color: #fff; border: none; display: inline-flex; align-items: center; justify-content: center; cursor: not-allowed;">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                {% endif %}
                            {% else %}
                                <!-- Simple Add to Cart Button (No Transformation) -->
                                <button class="btn btn-success simple-add-to-cart"
                                        data-product-id="{{ product.id }}"
                                        title="Add to Cart"
                                        style="width: 80px; height: 36px; font-size: 11px; padding: 0; border-radius: 0;">
                                    <i class="bi bi-cart-plus"></i>
                                </button>
                                <!-- Quantity Selector - Match Homepage Exactly -->
                                <div class="quantity-selector-container d-flex align-items-center" style="gap: 4px; margin-left: 8px;">
                                    <button type="button" class="btn btn-sm quantity-btn" 
                                            data-product-id="{{ product.id }}" data-action="decrease" 
                                            style="background-color: #ffffff; color: #6c757d; border: 1px solid #dee2e6; padding: 0; width: 36px; height: 36px; font-size: 14px; font-weight: 500; border-radius: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-dash" style="font-size: 12px;"></i>
                                    </button>
                                    <span class="quantity-display" style="width: 36px; height: 36px; text-align: center; font-weight: 600; font-size: 14px; color: #495057; background-color: #ffffff; border: 1px solid #dee2e6; padding: 0; border-radius: 2px; margin: 0 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;">1</span>
                                    <button type="button" class="btn btn-sm quantity-btn" 
                                            data-product-id="{{ product.id }}" data-action="increase" 
                                            style="background-color: #ffffff; color: #6c757d; border: 1px solid #dee2e6; padding: 0; width: 36px; height: 36px; font-size: 14px; font-weight: 500; border-radius: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-plus" style="font-size: 12px;"></i>
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>No products found in this category.</p>
        {% endif %}
        </div>
    </div>
</div>

    <footer class="footer1">
        <div class="container1">
            <div class="row1">
                <div class="footer1-col">
                    <h4>Company</h4>
                    <ul>
                        <li><a href="{{ url_for('about') }}">About Us</a></li>
                        <!-- <li><a href="{{ url_for('services') }}">Our Services</a></li>
                        <li><a href="{{ url_for('privacy') }}">Privacy Policy</a></li> -->
                       
                    </ul>
                </div>
                <div class="footer1-col">
                    <h4>Online Shop</h4>
                    <ul>
                        <li><a href="/products/category/70">Laptops</a></li>
                        <li><a href="/products/category/2">Desktops</a></li>
                        <li><a href="/products/category/3">Accessories</a></li>
                    </ul>
                </div>
               <div class="footer1-col">
                 <div class="footer1-col">
                    <h4>Shop Address</h4>
                    <div class="qr-container">
                            <img src="/static/icons/QR1.png" alt="Shop QR Code">
                    </div>
                        <div class="address-text">
                    <a href="https://maps.app.goo.gl/asmvfLTkajoffidN6?g_st=com.google.maps.preview.copy" 
                    target="_blank" 
                    style="text-decoration: none; color: #007BFF;" 
                    onmouseover="this.style.color='#0056b3'" 
                    onmouseout="this.style.color='#007BFF'">
                        No. 829B, entrance to Russey Keo High School, <br>
                        Sangkat Russey Keo, Khan Russey Keo, <br>
                        Phnom Penh.
                    </a>
                </div>
                </div>
                </div>
            </div>
        </div>
    </footer>
    <script src="/static/js/unified-notifications.js"></script>
    <script src="/static/js/view_product_button.js"></script>
    <script src="/static/js/homepage.js"></script>
    <script src="/static/js/homepage_products_v2.js"></script>
    <script src="/static/js/brand_navigation.js"></script>

    <!-- Bootstrap JavaScript for dropdown functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Pass hierarchy data to JavaScript
        const categoryHierarchy = {{ hierarchy | tojson }};
        
        // Initialize cart state when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize global variables
            let cartProductIds = new Set();
            let cartQuantitiesCache = null;
            let cartQuantitiesPromise = null;
            
            // Load cart state from localStorage
            const savedCartIds = localStorage.getItem('cartProductIds');
            if (savedCartIds) {
                try {
                    const cartIds = JSON.parse(savedCartIds);
                    cartProductIds = new Set(cartIds);

                    // Update button states for products already in cart (only for in-stock items)
                    setTimeout(() => {
                    cartIds.forEach(productId => {
                        const button = document.querySelector(`button[data-product-id="${productId}"].add-to-cart-btn`);
                        if (button) {
                                // DISABLED: Don't update button to show current quantity
                                // updateCartButtonDisplay(button, productId);
                                console.log('✅ Add to Cart button left unchanged');
                        }
                    });
                    }, 200);
                } catch (e) {
                    console.error('Error loading cart state:', e);
                    cartProductIds = new Set();
                }
            } else {
                cartProductIds = new Set();
            }

            // DISABLED: Initialize all cart buttons with current quantities (with delay to ensure functions are defined)
            setTimeout(() => {
            const allCartButtons = document.querySelectorAll('.add-to-cart-btn');
            allCartButtons.forEach(button => {
                const productId = parseInt(button.getAttribute('data-product-id'));
                if (productId) {
                        // DISABLED: Don't update button display
                        // updateCartButtonDisplay(button, productId);
                        console.log('✅ Add to Cart button left unchanged');
                    }
                });
            }, 100);

            // Discount Functions - Match Homepage
            function calculateDiscount(product) {
                if (product.original_price && product.price < product.original_price) {
                    const savings = product.original_price - product.price;
                    const percentage = Math.round((savings / product.original_price) * 100);
                    return {
                        hasDiscount: true,
                        percentage: percentage,
                        savings: savings,
                        originalPrice: product.original_price,
                        salePrice: product.price
                    };
                }
                return { hasDiscount: false };
            }

            function formatDiscountPrice(product) {
                const discount = calculateDiscount(product);
                if (discount.hasDiscount) {
                    return {
                        originalPriceHtml: `<span class="original-price">$${parseFloat(discount.originalPrice).toFixed(2)}</span>`,
                        salePriceHtml: `<span class="sale-price">$${parseFloat(discount.salePrice).toFixed(2)}</span>`,
                        savingsHtml: `<div class="savings-text">You Save: $${parseFloat(discount.savings).toFixed(2)}</div>`,
                        discountBadge: `<div class="discount-badge">${discount.percentage}% OFF</div>`
                    };
                }
                return {
                    regularPriceHtml: `<span class="price h5 text-primary">$${parseFloat(product.price).toFixed(2)}</span>`
                };
            }

            // Apply discount display to all product cards
            function applyDiscountDisplay() {
                console.log('🎨 Applying discount display...');
                
                // Get all product cards
                const productCards = document.querySelectorAll('.product-card');
                productCards.forEach(card => {
                    // Get product data from the card
                    const productName = card.querySelector('.card-title').textContent;
                    const priceElement = card.querySelector('.text-primary.h5, .price-container');
                    
                    if (priceElement) {
                        // Try to extract product data from data attributes or other elements
                        const addToCartBtn = card.querySelector('.simple-add-to-cart');
                        if (addToCartBtn) {
                            const productId = addToCartBtn.getAttribute('data-product-id');
                            
                            // Create mock product object with data from the page
                            const product = {
                                id: productId,
                                name: productName,
                                price: parseFloat(priceElement.textContent.replace('$', '')) || 0,
                                original_price: null // We'll need to get this from the server or data attributes
                            };
                            
                            // For now, let's check if there's already discount HTML and preserve it
                            if (priceElement.classList.contains('price-container')) {
                                console.log('✅ Discount already applied to:', productName);
                                return;
                            }
                            
                            // If no discount, keep the regular price display
                            console.log('✅ Regular price display for:', productName);
                        }
                    }
                });
                
                console.log('🎨 Discount display applied successfully!');
            }

            // Apply homepage-style button sizing to match homepage exactly
            function applyHomepageButtonStyles() {
                console.log('🎨 Applying homepage button styles...');
                
                // Style View Product buttons - match homepage exactly
                const viewButtons = document.querySelectorAll('.view-product-btn');
                viewButtons.forEach(button => {
                    button.style.setProperty('width', '80px', 'important');
                    button.style.setProperty('height', '36px', 'important');
                    button.style.setProperty('font-size', '11px', 'important');
                    button.style.setProperty('padding', '0', 'important');
                    button.style.setProperty('min-width', '80px', 'important');
                    button.style.setProperty('min-height', '36px', 'important');
                    button.style.setProperty('display', 'inline-flex', 'important');
                    button.style.setProperty('align-items', 'center', 'important');
                    button.style.setProperty('justify-content', 'center', 'important');
                    button.style.setProperty('border-radius', '0', 'important');
                    console.log('✅ Styled View Product button:', button);
                });

                // Simple Add to Cart buttons are already styled in HTML - no JavaScript styling needed
                console.log('✅ Simple Add to Cart buttons left unstyled (already styled in HTML)');

                // Style Pre-order and Unavailable buttons
                const preorderButtons = document.querySelectorAll('.preorder-btn, .cart-btn');
                preorderButtons.forEach(button => {
                    button.style.setProperty('width', '80px', 'important');
                    button.style.setProperty('height', '36px', 'important');
                    button.style.setProperty('font-size', '11px', 'important');
                    button.style.setProperty('padding', '0', 'important');
                    button.style.setProperty('min-width', '80px', 'important');
                    button.style.setProperty('min-height', '36px', 'important');
                    button.style.setProperty('display', 'inline-flex', 'important');
                    button.style.setProperty('align-items', 'center', 'important');
                    button.style.setProperty('justify-content', 'center', 'important');
                    button.style.setProperty('border-radius', '0', 'important');
                    console.log('✅ Styled Pre-order/Unavailable button:', button);
                });

                // Don't style quantity selector - let it keep its original appearance
                console.log('✅ Quantity selector left unstyled to preserve original appearance');

                console.log('🎨 Homepage button styles applied successfully!');
            }

            // Apply styles multiple times to ensure they stick
            setTimeout(applyHomepageButtonStyles, 100);
            setTimeout(applyHomepageButtonStyles, 500);
            setTimeout(applyHomepageButtonStyles, 1000);

            // Fix Add to Cart button to stay green and clickable like homepage discounts
            function fixAddToCartButtons() {
                console.log('🎨 Fixing Add to Cart buttons to stay green and clickable...');
                
                const addToCartButtons = document.querySelectorAll('.simple-add-to-cart');
                addToCartButtons.forEach(button => {
                    // Force green styling and make sure it's clickable
                    button.style.setProperty('background-color', '#28a745', 'important');
                    button.style.setProperty('color', '#fff', 'important');
                    button.style.setProperty('border', 'none', 'important');
                    button.style.setProperty('opacity', '1', 'important');
                    button.style.setProperty('cursor', 'pointer', 'important');
                    button.disabled = false;
                    button.title = 'Add to cart';
                    
                    // Make sure the icon is correct
                    if (!button.innerHTML.includes('bi-cart-plus')) {
                        button.innerHTML = '<i class="bi bi-cart-plus"></i>';
                    }
                    
                    console.log('✅ Fixed Add to Cart button:', button);
                });
                
                console.log('🎨 Add to Cart buttons fixed successfully!');
            }

            // Apply the fix multiple times to ensure it sticks
            setTimeout(fixAddToCartButtons, 100);
            setTimeout(fixAddToCartButtons, 500);
            setTimeout(fixAddToCartButtons, 1000);

            // AJAX function to refresh all quantity displays with actual cart quantities
            function refreshCategoryQuantityDisplays() {
                console.log('🔄 AJAX: Refreshing category quantity displays...');
                
                // Direct AJAX call to get cart data
                fetch('/api/cart/items')
                    .then(response => response.json())
                    .then(data => {
                        console.log('🔄 AJAX: Cart API response:', data);
                        
                        if (data.success && data.cart_items) {
                            // Create a map of product_id -> quantity
                            const cartQuantities = {};
                            data.cart_items.forEach(item => {
                                cartQuantities[item.id] = item.quantity;
                            });
                            console.log('🔄 AJAX: Cart quantities map:', cartQuantities);
                            
                            // Update all quantity selectors
                            const quantitySelectors = document.querySelectorAll('.quantity-selector-container');
                            console.log('🔄 AJAX: Found quantity selectors:', quantitySelectors.length);
                            
                            quantitySelectors.forEach(selector => {
                                const quantityBtn = selector.querySelector('.quantity-btn');
                                if (quantityBtn) {
                                    const productId = parseInt(quantityBtn.getAttribute('data-product-id'));
                                    const quantity = cartQuantities[productId] || 0;
                                    
                                    console.log(`🔄 AJAX: Product ${productId} quantity: ${quantity}`);
                                    
                                    // Update quantity display - ensure minimum of 1
                                    const quantityDisplay = selector.querySelector('.quantity-display');
                                    if (quantityDisplay) {
                                        const displayQuantity = Math.max(1, quantity);
                                        quantityDisplay.textContent = displayQuantity;
                                        console.log(`🔄 AJAX: Updated quantity display for product ${productId} to ${displayQuantity} (was ${quantity})`);
                                    }
                                    
                                    // Update cart button if quantity > 0
                                    if (quantity > 0) {
                                        const cartButton = selector.closest('.d-flex').querySelector('.simple-add-to-cart');
                                        if (cartButton) {
                                            cartButton.innerHTML = `
                                                <i class="bi bi-cart-check"></i>
                                                <span class="ms-1">(${quantity})</span>
                                            `;
                                            cartButton.title = `${quantity} in cart - Click to add more`;
                                            console.log(`🔄 AJAX: Updated cart button for product ${productId} to show quantity ${quantity}`);
                                        }
                                    }
                                }
                            });
                        } else {
                            console.log('🔄 AJAX: No cart items found');
                        }
                    })
                    .catch(error => {
                        console.error('🔄 AJAX: Error fetching cart data:', error);
                    });
            }

            // Auto-refresh quantity displays when page loads
            setTimeout(() => {
                refreshCategoryQuantityDisplays();
            }, 1000);

            // Test cart API to see if it's working
            function testCartAPI() {
                console.log('🧪 Testing cart API...');
                fetch('/api/cart/items')
                    .then(response => response.json())
                    .then(data => {
                        console.log('🧪 Cart API response:', data);
                        if (data.success && data.cart_items) {
                            console.log('🧪 Cart items found:', data.cart_items.length);
                            data.cart_items.forEach(item => {
                                console.log('🧪 Cart item:', item);
                            });
                        } else {
                            console.log('🧪 No cart items or API error');
                        }
                    })
                    .catch(error => {
                        console.error('🧪 Cart API error:', error);
                    });
            }

            // Test cart API after page loads
            setTimeout(() => {
                testCartAPI();
            }, 2000);

            // Function to show "Added" state but keep clickable
            function showAddedState(buttonElement) {
                // Show "Added" state but keep button clickable for multiple quantities
                buttonElement.style.backgroundColor = '#28a745'; // Keep green background
                buttonElement.style.color = '#fff'; // White text
                buttonElement.style.border = 'none';
                buttonElement.innerHTML = `
                    <i class="bi bi-cart-plus"></i>
                `;
                buttonElement.disabled = false; // Keep button clickable
                buttonElement.title = 'Add more to cart';
            }

            // Function to get all cart quantities (optimized - single API call)
            async function getAllCartQuantities() {
                try {
                // Return cached data if available
                if (cartQuantitiesCache) {
                    return cartQuantitiesCache;
                }
                
                // Return existing promise if one is in progress
                if (cartQuantitiesPromise) {
                    return cartQuantitiesPromise;
                }
                
                // Create new promise for cart data
                cartQuantitiesPromise = fetch('/api/cart/items')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.cart_items) {
                            // Create a map of product_id -> quantity
                            const quantities = {};
                            data.cart_items.forEach(item => {
                                quantities[item.product_id] = item.quantity;
                            });
                            cartQuantitiesCache = quantities;
                            return quantities;
                        }
                        cartQuantitiesCache = {};
                        return {};
                    })
                    .catch(error => {
                        console.error('Error getting cart quantities:', error);
                        cartQuantitiesCache = {};
                        return {};
                    });
                
                return cartQuantitiesPromise;
                } catch (error) {
                    console.error('Error in getAllCartQuantities:', error);
                    return {};
                }
            }

            // Function to get cart quantity for a specific product (optimized)
            function getCartQuantityForProduct(productId) {
                return getAllCartQuantities().then(quantities => {
                    return quantities[productId] || 0;
                });
            }

            // Function to invalidate cart cache (call after adding/removing items)
            function invalidateCartCache() {
                cartQuantitiesCache = null;
                cartQuantitiesPromise = null;
            }

            // Function to update cart button display with current quantity
            function updateCartButtonDisplay(buttonElement, productId) {
                // Keep Add to Cart button as simple "Add to Cart" - don't transform it
                if (!buttonElement || !productId) {
                    console.warn('updateCartButtonDisplay called with invalid parameters');
                    return;
                }
                
                // Always keep the button as "Add to Cart" - don't show quantity
                buttonElement.innerHTML = `<i class="bi bi-cart-plus"></i>`;
                        buttonElement.title = 'Add to cart';
                console.log('✅ Add to Cart button kept as simple button (no transformation)');
            }

            // Function to update cart quantity (category page)
            async function updateCartQuantityCategory(productId, quantity) {
                console.log(`🛒 AJAX: Updating category cart quantity for product ${productId} to ${quantity}`);
                
                try {
                    let response;
                    let data;
                    
                    if (quantity <= 0) {
                        // Use remove endpoint when quantity is 0 or less
                        console.log(`🛒 AJAX: Removing category product ${productId} from cart (quantity: ${quantity})`);
                        response = await fetch('/api/cart/remove', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                product_id: productId
                            })
                        });
                    } else {
                        // Use update endpoint for positive quantities
                        response = await fetch('/api/cart/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                product_id: productId,
                                quantity: quantity
                            })
                        });
                    }

                    data = await response.json();
                    console.log('🛒 AJAX: Category update cart response:', data);

                    if (data.success) {
                        // Update cart state
                        if (typeof cartProductIds !== 'undefined') {
                            if (quantity > 0) {
                                cartProductIds.add(productId);
                            } else {
                                cartProductIds.delete(productId);
                            }
                            localStorage.setItem('cartProductIds', JSON.stringify(Array.from(cartProductIds)));
                        }
                        
                        // Update cart badge immediately - show unique products count
                        const cartBadge = document.getElementById('cart-badge');
                        if (cartBadge) {
                            const uniqueProducts = cartProductIds ? cartProductIds.size : 0;
                            if (uniqueProducts > 0) {
                                cartBadge.textContent = uniqueProducts;
                                cartBadge.classList.add('show');
                                localStorage.setItem('cart_count', uniqueProducts.toString());
                                console.log(`🛒 Updated category cart badge to ${uniqueProducts} unique products`);
                            } else {
                                cartBadge.classList.remove('show');
                                localStorage.setItem('cart_count', '0');
                                console.log(`🛒 Hiding category cart badge - no products`);
                            }
                        }
                        
                        // If quantity is 0, also remove from cartProductIds to ensure clean state
                        if (quantity <= 0 && cartProductIds && cartProductIds.has(productId)) {
                            cartProductIds.delete(productId);
                            localStorage.setItem('cartProductIds', JSON.stringify(Array.from(cartProductIds)));
                            console.log(`🛒 Removed product ${productId} from cartProductIds (quantity: ${quantity})`);
                        }
                        
                        console.log(`🛒 AJAX: Successfully updated category cart quantity for product ${productId} to ${quantity}`);
                        
                        // Don't refresh immediately - the display is already correct
                        // Only refresh if there's a mismatch
                        
                        return true;
                    } else {
                        console.error('🛒 AJAX: Failed to update category cart quantity:', data.error);
                        return false;
                    }
                } catch (error) {
                    console.error('🛒 AJAX: Network error updating category cart quantity:', error);
                    return false;
                }
            }

            // Function to add item to cart with specific quantity
            async function addToCartWithQuantity(productId, quantity, buttonElement) {
                try {
                    const response = await fetch('/api/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            product_id: productId,
                            quantity: quantity
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Add product to cart tracking set
                        cartProductIds.add(productId);

                        // Save updated cart state to localStorage
                        localStorage.setItem('cartProductIds', JSON.stringify(Array.from(cartProductIds)));

                        // Invalidate cart cache so fresh data is fetched
                        invalidateCartCache();

                        // Update cart badge immediately with the returned count
                        if (data.cart_total_items) {
                            const cartBadge = document.getElementById('cart-badge');
                            if (cartBadge) {
                                cartBadge.textContent = data.cart_total_items;
                                cartBadge.classList.add('show');
                                // Update localStorage for future use
                                localStorage.setItem('cart_count', data.cart_total_items.toString());
                                localStorage.setItem('cart_updated', Date.now().toString());
                            }
                        }

                        // DISABLED: Update the cart button to show new quantity immediately
                        // updateCartButtonDisplay(buttonElement, productId);
                        console.log('✅ Add to Cart button left unchanged after adding to cart');
                        
                        showNotification(`Added ${quantity} item(s) to cart successfully!`, 'success', false);
                    } else {
                        showNotification('Error: ' + data.error, 'error', false);
                        // Reset button on error
                        buttonElement.innerHTML = '<i class="bi bi-cart-plus"></i>';
                        buttonElement.style.backgroundColor = '#007bff';
                    }
                } catch (error) {
                    console.error('Error adding to cart:', error);
                    showNotification('An error occurred while adding to cart.', 'error', false);
                    // Reset button on error
                    buttonElement.innerHTML = '<i class="bi bi-cart-plus"></i>';
                    buttonElement.style.backgroundColor = '#007bff';
                }
            }

            // Function to add item to cart (legacy function for compatibility)
            async function addToCart(productId, buttonElement) {
                try {
                    const response = await fetch('/api/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            product_id: productId,
                            quantity: 1
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Add product to cart tracking set
                        cartProductIds.add(productId);

                        // Save updated cart state to localStorage
                        localStorage.setItem('cartProductIds', JSON.stringify(Array.from(cartProductIds)));

                        // Invalidate cart cache so fresh data is fetched
                        invalidateCartCache();

                        // Update cart badge immediately with the returned count
                        if (data.cart_total_items) {
                            const cartBadge = document.getElementById('cart-badge');
                            if (cartBadge) {
                                cartBadge.textContent = data.cart_total_items;
                                cartBadge.classList.add('show');
                                // Update localStorage for future use
                                localStorage.setItem('cart_count', data.cart_total_items.toString());
                                localStorage.setItem('cart_updated', Date.now().toString());
                            }
                        }

                        // DISABLED: Update the cart button to show new quantity immediately
                        // updateCartButtonDisplay(buttonElement, productId);
                        console.log('✅ Add to Cart button left unchanged after adding to cart');
                        
                        showNotification('Item added to cart successfully!', 'success', false);
                    } else {
                        showNotification('Error: ' + data.error, 'error', false);
                        // Reset button on error
                        buttonElement.innerHTML = '<i class="bi bi-cart-plus"></i>';
                        buttonElement.style.backgroundColor = '#28a745';
                    }
                } catch (error) {
                    console.error('Error adding to cart:', error);
                    showNotification('An error occurred while adding to cart.', 'error', false);
                    // Reset button on error
                    buttonElement.innerHTML = '<i class="bi bi-cart-plus"></i>';
                    buttonElement.style.backgroundColor = '#28a745';
                }
            }

            // Add event listeners for add-to-cart, pre-order, and quantity selector buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.simple-add-to-cart')) {
                    const button = e.target.closest('.simple-add-to-cart');
                    const productId = parseInt(button.getAttribute('data-product-id'));

                    // Get quantity from quantity selector
                    const quantitySelector = button.closest('.d-flex').querySelector('.quantity-selector-container');
                    const quantityDisplay = quantitySelector ? quantitySelector.querySelector('.quantity-display') : null;
                    const currentQuantity = quantityDisplay ? parseInt(quantityDisplay.textContent) || 1 : 1;

                    // Add immediate visual feedback
                    addClickFeedback(button);

                    // Add the current quantity to cart
                    addToCartWithQuantity(productId, currentQuantity, button);
                } else if (e.target.closest('.preorder-btn')) {
                    const button = e.target.closest('.preorder-btn');
                    addClickFeedback(button);

                    // Use state manager for stateful pre-order handling
                    if (window.preorderStateManager) {
                        const productId = button.getAttribute('data-product-id');
                        const productData = {
                            id: parseInt(productId),
                            name: button.getAttribute('data-product-name'),
                            price: parseFloat(button.getAttribute('data-product-price')),
                            expected_restock_date: button.getAttribute('data-expected-restock')
                        };
                        window.preorderStateManager.handlePreorderButtonClick(button, productId, productData);
                    } else {
                        // Fallback to original modal
                        openPreOrderModal(button);
                    }
                } else if (e.target.closest('.quantity-btn')) {
                    // Handle quantity selector buttons
                    const quantityBtn = e.target.closest('.quantity-btn');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const action = quantityBtn.getAttribute('data-action');
                    const productId = parseInt(quantityBtn.getAttribute('data-product-id'));
                    
                    if (productId) {
                        // Find the quantity display
                        const quantityContainer = quantityBtn.closest('.quantity-selector-container');
                        const quantityDisplay = quantityContainer.querySelector('.quantity-display');
                        const currentQuantity = quantityDisplay ? parseInt(quantityDisplay.textContent) : 1;
                        
                        let newQuantity;
                        if (action === 'increase') {
                            newQuantity = currentQuantity + 1;
                        } else if (action === 'decrease') {
                            newQuantity = Math.max(1, currentQuantity - 1);
                        }
                        
                        // Update the quantity display
                        if (quantityDisplay) {
                            quantityDisplay.textContent = newQuantity;
                            console.log(`🔍 Updated quantity display to ${newQuantity} (currentQuantity: ${currentQuantity})`);
                            
                            // NEVER update cart from quantity selector - only "Add to Cart" button should add to cart
                            console.log(`🛒 Quantity selector changed to ${newQuantity} - NOT updating cart (display only)`);
                            // Don't update cart - quantity selector is just for display
                        }
                    }
                }
            });
        });

        // Global variable to store current product data for pre-order
        let currentProductData = null;

        // Function to open pre-order modal
        function openPreOrderModal(buttonElement) {
            const productId = buttonElement.getAttribute('data-product-id');
            const productName = buttonElement.getAttribute('data-product-name');
            const productPrice = parseFloat(buttonElement.getAttribute('data-product-price'));
            const expectedRestock = buttonElement.getAttribute('data-expected-restock');
            const productImage = buttonElement.getAttribute('data-product-image');

            // Store current product data
            currentProductData = {
                id: parseInt(productId),
                name: productName,
                price: productPrice,
                expected_restock_date: expectedRestock
            };

            // Update modal content
            document.getElementById('preorder-product-name').textContent = productName;
            document.getElementById('preorder-product-price').textContent = `$${productPrice.toFixed(2)}`;

            // Set product image
            const productImageElement = document.getElementById('preorder-product-image');
            if (productImage && productImage !== 'None' && productImage !== '') {
                productImageElement.src = productImage;
                productImageElement.alt = productName;
            } else {
                productImageElement.src = '/static/images/placeholder-product.jpg';
                productImageElement.alt = 'Product Image';
            }

            const restockText = expectedRestock && expectedRestock !== 'None' ?
                expectedRestock :
                'To be announced';
            document.getElementById('preorder-expected-restock').textContent = restockText;

            // Update deposit amounts
            updateDepositAmounts();

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('preorderModal'));
            modal.show();
        }

        // Function to update deposit amounts based on product price
        function updateDepositAmounts() {
            if (!currentProductData) return;

            const quantity = 1; // Fixed quantity of 1 for pre-orders
            const totalPrice = currentProductData.price * quantity;

            document.getElementById('deposit25-amount').textContent = (totalPrice * 0.25).toFixed(2);
            document.getElementById('deposit50-amount').textContent = (totalPrice * 0.50).toFixed(2);
            document.getElementById('deposit100-amount').textContent = totalPrice.toFixed(2);
        }

        // Function to add click feedback (visual feedback when button is clicked)
        function addClickFeedback(buttonElement) {
            const originalTransform = buttonElement.style.transform;
            buttonElement.style.transform = 'scale(0.95)';
            setTimeout(() => {
                buttonElement.style.transform = originalTransform;
            }, 150);
        }

        // Handle pre-order confirmation
        document.addEventListener('DOMContentLoaded', function() {
            const confirmButton = document.getElementById('confirm-preorder');
            if (confirmButton) {
                confirmButton.addEventListener('click', submitPreOrder);
            }
        });

        // Function to submit pre-order
        async function submitPreOrder() {
            try {
                const quantity = 1; // Fixed quantity of 1 for pre-orders
                const depositPercentage = parseInt(document.querySelector('input[name="depositOption"]:checked').value);
                const notes = document.getElementById('preorder-notes').value;

                // Calculate the actual deposit amount to be paid
                const totalPrice = currentProductData.price * quantity;
                const depositAmount = (totalPrice * depositPercentage) / 100;

                const response = await fetch('/api/preorders/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_id: currentProductData.id,
                        quantity: quantity,
                        deposit_percentage: depositPercentage,
                        payment_method: null, // Payment will be handled in cart
                        notes: notes
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('preorderModal'));
                    modal.hide();

                    // Update pre-order state
                    if (window.preorderStateManager) {
                        window.preorderStateManager.setPreorderState(currentProductData.id, {
                            has_preorder: true,
                            preorder_id: data.pre_order_id,
                            status: 'pending'
                        });

                        // Update button state immediately
                        const preorderBtn = document.querySelector(`[data-product-id="${currentProductData.id}"].preorder-btn`);
                        if (preorderBtn) {
                            window.preorderStateManager.updateButtonState(preorderBtn, currentProductData.id);
                        }
                    }

                    // Dispatch event for other components
                    document.dispatchEvent(new CustomEvent('preorderCreated', {
                        detail: {
                            productId: currentProductData.id,
                            preorderId: data.pre_order_id,
                            status: 'pending'
                        }
                    }));

                    // Pass the deposit amount (not full price) to cart for payment
                    const priceForCart = depositAmount / quantity; // Price per item for cart display
                    addPreOrderToCartAndRedirect(data.pre_order_id, currentProductData.id, currentProductData.name, quantity, priceForCart);
                } else {
                    showNotification('Error placing pre-order: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('An error occurred while placing the pre-order.', 'error');
            }
        }

        // Function to add pre-order to cart and show success
        async function addPreOrderToCartAndRedirect(preOrderId, productId, productName, quantity, price) {
            console.log(`🛒 Adding pre-order #${preOrderId} to cart...`);

            try {
                const requestData = {
                    preorder_id: preOrderId,
                    product_id: productId,
                    quantity: quantity,
                    price: price
                };

                console.log('🛒 Sending request to add preorder to cart:', requestData);

                const response = await fetch('/api/cart/add-preorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('📡 Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('📦 Cart addition result:', result);

                    if (result.success) {
                        // Success - show success message with cart options
                        showNotification('Pre-order added to cart successfully!', 'success');
                        return;
                    }
                }

                // If we get here, something went wrong - still show success for pre-order creation
                console.warn('Cart addition failed, but pre-order was created');
                showNotification('Pre-order created successfully!', 'success');

            } catch (error) {
                console.error('❌ Error adding pre-order to cart:', error);
                showNotification('Pre-order created successfully!', 'success');
            }
        }
    </script>

    <!-- Include Pre-Order State Manager -->
    <script src="/static/js/preorder_state_manager.js"></script>

    <script>
        // Fix for My Pre-Orders navigation
        document.addEventListener('DOMContentLoaded', function() {
            const preOrdersLinks = document.querySelectorAll('a[href*="customer_preorders"]');
            preOrdersLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    console.log('Pre-orders link clicked from category page');
                    // Ensure navigation works
                    if (!e.defaultPrevented) {
                        window.location.href = this.href;
                    }
                });
            });

            // Smart pre-order state loading (efficient, cached)
            function loadCategoryPreorderStates() {
                if (typeof smartLoadPreorderStates === 'function') {
                    console.log('🔄 Category: Loading pre-order states (smart mode)');
                    smartLoadPreorderStates();
                } else if (window.preorderStateManager && window.preorderStateManager.isLoggedIn) {
                    console.log('🔄 Category: Using fallback state loading method');
                    // Fallback method - load states directly
                    const buttons = document.querySelectorAll('.preorder-btn[data-product-id]');
                    if (buttons.length > 0) {
                        const productIds = Array.from(buttons).map(btn => btn.getAttribute('data-product-id'));
                        console.log('🔄 Category: Loading states for products:', productIds);

                        window.preorderStateManager.loadStatesFromServer(productIds).then(() => {
                            buttons.forEach(button => {
                                const productId = button.getAttribute('data-product-id');
                                const state = window.preorderStateManager.getPreorderState(productId);
                                if (state.has_preorder) {
                                    console.log(`✅ Category: Product ${productId} has pre-order, showing green`);
                                    window.preorderStateManager.updateButtonState(button, productId);
                                }
                            });
                        });
                    }
                } else {
                    console.log('⚠️ Category: State manager not ready, retrying...');
                    setTimeout(loadCategoryPreorderStates, 500);
                }
            }

            // Start loading with a small delay to ensure everything is ready
            setTimeout(loadCategoryPreorderStates, 300);
        });
    </script>

    <!-- Notification Modal -->
    <div id="notificationModal" class="notification-modal">
        <div class="notification-content">
            <span class="close-modal" onclick="closeNotifications()">&times;</span>
            <h2>Notifications</h2>
            <div id="notificationsList">
                <p>Loading notifications...</p>
            </div>
            <div style="margin-top: 20px;">
                <button onclick="markAllAsRead()" class="btn btn-primary">Mark All as Read</button>
                <button onclick="clearAllNotifications()" class="btn btn-warning">Clear All</button>
                <button onclick="closeNotifications()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Pre-Order Modal -->
    <div class="modal fade" id="preorderModal" tabindex="-1" aria-labelledby="preorderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="preorderModalLabel">
                        <i class="bi bi-clock"></i> Place Pre-Order - Initial Deposit
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <img id="preorder-product-image" src="" alt="Product Image" class="img-fluid rounded" style="max-height: 200px; object-fit: contain;">
                        </div>
                        <div class="col-md-8">
                            <h4 id="preorder-product-name"></h4>
                            <p><strong>Price:</strong> <span class="text-primary h5" id="preorder-product-price"></span></p>
                            <p><strong>Expected Availability:</strong> <span class="text-muted" id="preorder-expected-restock"></span></p>
                        </div>
                    </div>

                    <hr>

                    <!-- Initial Deposit Options -->
                    <div class="mb-4">
                        <h6><i class="bi bi-credit-card"></i> Initial Deposit Options</h6>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Choose your initial deposit amount. Payment will be processed through the cart.
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="depositOption" id="deposit25" value="25" checked>
                            <label class="form-check-label" for="deposit25">
                                <strong>25% Initial Deposit</strong> - $<span id="deposit25-amount">0.00</span><br>
                                <small class="text-muted">Pay 25% now, remaining 75% when available</small>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="depositOption" id="deposit50" value="50">
                            <label class="form-check-label" for="deposit50">
                                <strong>50% Initial Deposit</strong> - $<span id="deposit50-amount">0.00</span><br>
                                <small class="text-muted">Pay 50% now, remaining 50% when available</small>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="depositOption" id="deposit100" value="100">
                            <label class="form-check-label" for="deposit100">
                                <strong>Full Payment</strong> - $<span id="deposit100-amount">0.00</span><br>
                                <small class="text-muted">Pay full amount now, no additional payment needed</small>
                            </label>
                        </div>
                    </div>

                    <!-- Special Requests -->
                    <div class="mb-4">
                        <label for="preorder-notes" class="form-label"><strong>Special Requests (Optional)</strong></label>
                        <textarea class="form-control" id="preorder-notes" rows="3" placeholder="Any special requests or notes..."></textarea>
                    </div>

                    <!-- Pre-order Terms -->
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Pre-order Terms:</strong>
                        <ul class="mb-0 mt-2">
                            <li>You will be notified when the product becomes available</li>
                            <li>Deposits are refundable if you cancel before the product arrives</li>
                            <li>You have 7 days to complete your purchase once notified</li>
                            <li>Prices may be subject to change at time of availability</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirm-preorder">
                        <i class="bi bi-clock"></i> Confirm Pre-Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Notification system
        let notifications = [];

        // Load notifications when page loads (for logged-in customers)
    </script>

    {% if session.username and session.role == 'customer' %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications();
            // Check for new notifications every 30 seconds
            setInterval(loadNotifications, 30000);
        });
    </script>
    {% endif %}

    <script>
        function loadNotifications() {
            return fetch('/api/customer/notifications')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        notifications = data.notifications;
                        updateNotificationBadge();

                        // Show custom notification for new unread notifications (only once per session)
                        const unreadNotifications = notifications.filter(n => !n.is_read);
                        if (unreadNotifications.length > 0) {
                            const newNotifications = unreadNotifications.filter(n => {
                                return !sessionStorage.getItem(`notification_shown_${n.id}`);
                            });

                            if (newNotifications.length > 0) {
                                // Mark as shown in session storage
                                newNotifications.forEach(n => {
                                    sessionStorage.setItem(`notification_shown_${n.id}`, 'true');
                                });

                                // Show custom notification popup (no browser permission needed)
                                const latestNotification = newNotifications[0];
                                setTimeout(() => {
                                    showCustomNotificationPopup(latestNotification.message);
                                }, 1000);
                            }
                        }
                    }
                    return data; // Return the data for chaining
                })
                .catch(error => {
                    console.error('Error loading notifications:', error);
                    throw error; // Re-throw for proper error handling
                });
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            const unreadCount = notifications.filter(n => !n.is_read).length;

            // Show badge only for unread notifications
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-flex';
                badge.style.backgroundColor = '#dc3545'; // Red for unread
                // Set balanced size styles
                badge.style.fontSize = '0.75rem';
                badge.style.minWidth = '20px';
                badge.style.height = '20px';
                badge.style.padding = '2px 6px';
                badge.style.marginLeft = '5px';
            } else {
                // Hide badge completely when all notifications are read
                badge.style.display = 'none';
            }
        }

        function showNotifications() {
            const modal = document.getElementById('notificationModal');
            const list = document.getElementById('notificationsList');

            if (notifications.length === 0) {
                list.innerHTML = '<p>No notifications</p>';
            } else {
                let html = '';
                const now = new Date();
                const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

                notifications.forEach(notification => {
                    const readClass = notification.is_read ? '' : 'unread';
                    const typeClass = notification.type || '';
                    const notificationDate = new Date(notification.created_date);
                    const isRecent = notificationDate > oneDayAgo;
                    const recentClass = isRecent ? 'recent' : '';

                    html += `
                        <div class="notification-item ${readClass} ${typeClass} ${recentClass}" data-id="${notification.id}">
                            <div>${notification.message} ${isRecent && notification.is_read ? '<span style="color: #28a745; font-size: 12px;">(Recent)</span>' : ''}</div>
                            <div class="notification-date">${notificationDate.toLocaleString()}</div>
                            ${!notification.is_read ? '<button onclick="markAsRead(' + notification.id + ')" class="btn btn-sm btn-outline-primary" style="margin-top: 5px;">Mark as Read</button>' : ''}
                        </div>
                    `;
                });
                list.innerHTML = html;
            }

            modal.style.display = 'block';
        }

        function closeNotifications() {
            document.getElementById('notificationModal').style.display = 'none';
        }

        function markAsRead(notificationId) {
            // Disable the button immediately to prevent double clicks
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Marking...';

            fetch(`/api/customer/notifications/${notificationId}/read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Only refresh the notifications data and modal once
                    loadNotifications().then(() => {
                        showNotifications(); // Refresh modal display after data is loaded
                    });
                }
            })
            .catch(error => {
                console.error('Error marking notification as read:', error);
                // Re-enable button on error
                button.disabled = false;
                button.textContent = 'Mark as Read';
            });
        }

        function markAllAsRead() {
            // Disable the button to prevent double clicks
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Marking All...';

            fetch('/api/customer/notifications/mark-all-read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Only refresh once with proper chaining
                    loadNotifications().then(() => {
                        showNotifications(); // Refresh modal display after data is loaded
                    });
                }
            })
            .catch(error => {
                console.error('Error marking all notifications as read:', error);
                // Re-enable button on error
                button.disabled = false;
                button.textContent = 'Mark All as Read';
            });
        }

        async function clearAllNotifications() {
            // Show custom confirmation modal
            const confirmed = await showClearNotificationsConfirmation();
            if (!confirmed) {
                return;
            }

            // Disable the button to prevent double clicks
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Clearing All...';

            fetch('/api/customer/notifications/clear-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh notifications and update badge
                    loadNotifications().then(() => {
                        showNotifications(); // Refresh modal display after data is loaded
                    });
                } else {
                    window.unifiedNotifications.error('Error clearing notifications: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error clearing all notifications:', error);
                window.unifiedNotifications.error('An error occurred while clearing notifications.');
            })
            .finally(() => {
                // Re-enable button
                button.disabled = false;
                button.textContent = 'Clear All';
            });
        }

        function showClearNotificationsConfirmation() {
            return new Promise((resolve) => {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.className = 'clear-notifications-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    backdrop-filter: blur(2px);
                `;

                // Create modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    max-width: 400px;
                    width: 90%;
                    transform: scale(0.9);
                    transition: transform 0.2s ease-out;
                `;

                modal.innerHTML = `
                    <div style="padding: 24px 24px 16px 24px; text-align: center;">
                        <div style="color: #f59e0b; font-size: 48px; margin-bottom: 16px;">🗑️</div>
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #111827;">Clear All Notifications</h3>
                        <p style="margin: 0; color: #6b7280; font-size: 14px;">Are you sure you want to clear all notifications? This action cannot be undone.</p>
                    </div>
                    <div style="padding: 16px 24px 24px 24px; display: flex; gap: 12px; justify-content: center;">
                        <button class="cancel-btn" style="
                            background: #f3f4f6;
                            color: #374151;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            font-weight: 500;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background-color 0.2s;
                            min-width: 80px;
                        ">Cancel</button>
                        <button class="confirm-btn" style="
                            background: #f59e0b;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            font-weight: 500;
                            cursor: pointer;
                            font-size: 14px;
                            transition: background-color 0.2s;
                            min-width: 80px;
                        ">Clear All</button>
                    </div>
                `;

                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                // Animate in
                requestAnimationFrame(() => {
                    modal.style.transform = 'scale(1)';
                });

                // Add hover effects
                const cancelBtn = modal.querySelector('.cancel-btn');
                const confirmBtn = modal.querySelector('.confirm-btn');

                cancelBtn.addEventListener('mouseenter', () => {
                    cancelBtn.style.backgroundColor = '#e5e7eb';
                });
                cancelBtn.addEventListener('mouseleave', () => {
                    cancelBtn.style.backgroundColor = '#f3f4f6';
                });

                confirmBtn.addEventListener('mouseenter', () => {
                    confirmBtn.style.backgroundColor = '#d97706';
                });
                confirmBtn.addEventListener('mouseleave', () => {
                    confirmBtn.style.backgroundColor = '#f59e0b';
                });

                // Handle button clicks
                const cleanup = () => {
                    modal.style.transform = 'scale(0.9)';
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(overlay);
                    }, 200);
                };

                cancelBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(false);
                });

                confirmBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(true);
                });

                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        cleanup();
                        resolve(false);
                    }
                });

                // Close on escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        resolve(false);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
        }

        function showCustomNotificationPopup(message) {
            // Create custom notification popup (no browser permission needed)
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #007bff, #0056b3);
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 350px;
                animation: slideInRight 0.3s ease-out;
            `;

            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 8px;">New Notification</div>
                        <div style="font-size: 14px; line-height: 1.4;">${message}</div>
                        <div style="margin-top: 12px;">
                            <button onclick="showNotifications(); this.parentElement.parentElement.parentElement.remove();" style="background: white; color: #007bff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 8px;">View All</button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove();" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Dismiss</button>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove();" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 0; margin-left: 10px;">&times;</button>
                </div>
            `;

            document.body.appendChild(popup);

            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.remove();
                }
            }, 8000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('notificationModal');
            if (event.target == modal) {
                closeNotifications();
            }
        }

        // Apply consistent card layout and button positioning (matching homepage)
        function applyCardLayoutFixes() {
            requestAnimationFrame(() => {
                const cards = document.querySelectorAll('.product-card.card');
                cards.forEach(card => {
                    card.style.minHeight = '400px';
                    const cardBody = card.querySelector('.card-body');
                    if (cardBody) {
                        cardBody.style.display = 'flex';
                        cardBody.style.flexDirection = 'column';
                        cardBody.style.height = '100%';
                    }
                    const buttonContainer = card.querySelector('.d-flex');
                    if (buttonContainer) {
                        buttonContainer.style.marginTop = 'auto';
                    }
                });

                setTimeout(() => {
                    // Force layout recalculation
                    document.body.offsetHeight;
                }, 50);
            });
        }

        // Apply layout fixes when page loads
        document.addEventListener('DOMContentLoaded', applyCardLayoutFixes);

        // Apply layout fixes after any dynamic content changes
        window.addEventListener('load', applyCardLayoutFixes);

        // Cart badge functionality
        function updateCartBadge() {
            console.log('🛒 updateCartBadge called');
            const cartBadge = document.getElementById('cart-badge');
            console.log('🛒 Cart badge element found:', cartBadge);
            if (!cartBadge) {
                console.log('❌ Cart badge element not found!');
                return;
            }

            // First check localStorage for immediate updates
            const localCartCount = localStorage.getItem('cart_count');
            console.log('🛒 Local cart count:', localCartCount);
            
            if (localCartCount) {
                const count = parseInt(localCartCount);
                console.log('🛒 Parsed count:', count);
                if (count > 0) {
                    cartBadge.textContent = count;
                    cartBadge.classList.add('show');
                    console.log('🛒 Showing badge with count:', count);
                    return; // Use local data if available
                } else {
                    cartBadge.classList.remove('show');
                    console.log('🛒 Hiding badge - count is 0');
                }
            }

            // Fallback to API call
            fetch('/api/cart/count')
                .then(response => response.json())
                .then(data => {
                    console.log('🛒 API cart count response:', data);
                    if (data.success && data.total_items > 0) {
                        cartBadge.textContent = data.total_items;
                        cartBadge.classList.add('show');
                        console.log('🛒 Showing badge from API with count:', data.total_items);
                    } else {
                        cartBadge.classList.remove('show');
                        console.log('🛒 Hiding badge from API - no items');
                    }
                })
                .catch(error => {
                    console.error('Error updating cart badge:', error);
                    cartBadge.classList.remove('show');
                });
        }

        // Clear any stale cart data on page load
        function clearStaleCartData() {
            console.log('🛒 Category: Clearing stale cart data');
            localStorage.removeItem('cart_count');
            localStorage.removeItem('cartProductIds');
            localStorage.removeItem('cart_updated');
            
            // Also hide the cart badge immediately
            const cartBadge = document.getElementById('cart-badge');
            if (cartBadge) {
                cartBadge.classList.remove('show');
                cartBadge.textContent = '0';
                console.log('🛒 Category: Cart badge cleared and hidden');
            }
        }

        // Update cart badge when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🛒 DOM loaded - clearing stale data, NOT updating cart badge');
            clearStaleCartData();
            // Don't call updateCartBadge() - let user actions control the badge
        });

        // Clear cart badge immediately on page load (before any other scripts)
        (function() {
            console.log('🛒 Category: Immediate cart badge clear');
            const cartBadge = document.getElementById('cart-badge');
            if (cartBadge) {
                cartBadge.classList.remove('show');
                cartBadge.textContent = '0';
                console.log('🛒 Category: Cart badge immediately cleared');
            }
            localStorage.removeItem('cart_count');
            localStorage.removeItem('cartProductIds');
            localStorage.removeItem('cart_updated');
        })();

        // Also update immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            // DOM is still loading, wait for DOMContentLoaded
        } else {
            // DOM is already loaded, don't update cart badge automatically
            console.log('🛒 DOM already loaded - NOT updating cart badge automatically');
        }

        // Listen for cart updates from other pages
        window.addEventListener('storage', function(e) {
            if (e.key === 'cart_updated') {
                console.log('🛒 Cart update detected from localStorage');
                updateCartBadge();
            }
        });

        // Update cart badge when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('🛒 Page visible - updating cart badge');
                updateCartBadge();
            }
        });

        // Handle main category change and show/hide sub-dropdowns
        function handleMainCategoryChange(categoryId) {
            const dynamicSubSelect = document.getElementById('dynamicSubSelect');
            
            // Hide sub-dropdown first
            dynamicSubSelect.style.display = 'none';
            dynamicSubSelect.value = '';
            
            if (categoryId === '') {
                // "All Accessories" selected - show all products
                filterByCategoryId('');
                return;
            }
            
            // Find children of the selected category
            const children = categoryHierarchy.filter(cat => cat.parent_id == categoryId);
            
            if (children.length > 0) {
                // Category has children - show sub-dropdown
                populateDynamicSubDropdown(children, categoryId);
                dynamicSubSelect.style.display = 'inline-block';
                
                // Show all products from parent + children
                const childIds = children.map(child => child.id.toString());
                filterByMultipleCategoryIds([categoryId, ...childIds]);
            } else {
                // Category has no children - just show products from this category
                filterByCategoryId(categoryId);
            }
        }

        // Populate the dynamic sub-dropdown with children
        function populateDynamicSubDropdown(children, parentId) {
            const dynamicSubSelect = document.getElementById('dynamicSubSelect');
            
            // Clear existing options except the first one
            dynamicSubSelect.innerHTML = '<option value="">All Subcategories</option>';
            
            // Add children options
            children.forEach(child => {
                const option = document.createElement('option');
                option.value = child.id;
                option.textContent = getCategoryIcon(child.name) + ' ' + child.name.charAt(0).toUpperCase() + child.name.slice(1);
                dynamicSubSelect.appendChild(option);
            });
        }

        // Handle dynamic sub-dropdown changes
        function handleDynamicSubChange(categoryId) {
            const mainSelect = document.getElementById('subcategorySelect');
            const parentId = mainSelect.value;
            
            if (categoryId === '') {
                // "All Subcategories" selected - show parent + all children
                const children = categoryHierarchy.filter(cat => cat.parent_id == parentId);
                const childIds = children.map(child => child.id.toString());
                filterByMultipleCategoryIds([parentId, ...childIds]);
            } else {
                // Specific subcategory selected
                filterByCategoryId(categoryId);
            }
        }

        // Get icon for category name
        function getCategoryIcon(categoryName) {
            const iconMap = {
                // Storage icons
                'ssds': '💾', 'ssd': '💾', 'solid state': '💾', 'nvme': '💾', 'm.2': '💾',
                'hdds': '💿', 'hdd': '💿', 'hard drive': '💿', 'mechanical drive': '💿',
                'ram': '🧠', 'memory': '🧠', 'ddr4': '🧠', 'ddr5': '🧠',
                'usb': '💾', 'flash': '💾', 'sd card': '💾', 'microsd': '💾',
                
                // Peripheral icons
                'keyboards': '⌨️', 'keyboard': '⌨️',
                'mice': '🖱️', 'mouse': '🖱️',
                'webcams': '📹', 'webcam': '📹', 'camera': '📹',
                'audio': '🎧', 'headphones': '🎧', 'headset': '🎧',
                'speakers': '🔊', 'speaker': '🔊',
                'microphones': '🎤', 'microphone': '🎤', 'mic': '🎤',
                'networks': '🌐', 'network': '🌐',
                'wifi': '📶', 'router': '📶',
                'cables': '🔌', 'cable': '🔌',
                'adapters': '🔌', 'adapter': '🔌',
                'chargers': '🔋', 'charger': '🔋',
                'batteries': '🔋', 'battery': '🔋',
                
                // Monitor icons
                'monitors': '🖥️', 'monitor': '🖥️', 'display': '🖥️', 'screen': '🖥️',
                'gaming': '🎮', 'gamer': '🎮',
                
                // Laptop icons
                'laptops': '💻', 'laptop': '💻', 'notebook': '💻',
                'gaming_laptops': '🎮💻', 'gaming laptop': '🎮💻',
                'business_laptops': '💼💻', 'business laptop': '💼💻',
                'student_laptops': '📚💻', 'student laptop': '📚💻',
                'ultrabooks': '📱💻', 'ultrabook': '📱💻',
                'workstation_laptops': '⚙️💻', 'workstation laptop': '⚙️💻',
                'laptop_gaming': '🎮💻', 'laptop_office': '💼💻'
            };
            
            return iconMap[categoryName.toLowerCase()] || '📦';
        }

        // Filter by exact category ID (database-based filtering)
        function filterByCategoryId(categoryId) {
            const productCards = document.querySelectorAll('.product-card');
            let visibleCount = 0;
            
            productCards.forEach(card => {
                const productCategoryId = card.getAttribute('data-category-id');
                let shouldShow = true;
                
                // If a category is selected, filter by exact category ID match
                if (categoryId) {
                    shouldShow = productCategoryId === categoryId;
                }
                
                if (shouldShow) {
                    card.closest('.col-lg-3').style.display = 'block';
                    visibleCount++;
                } else {
                    card.closest('.col-lg-3').style.display = 'none';
                }
            });
            
            // Update product count
            const productCountBadge = document.getElementById('productCount');
            if (productCountBadge) {
                productCountBadge.textContent = visibleCount;
            }
        }

        // Filter by multiple category IDs (for parent + children categories)
        function filterByMultipleCategoryIds(categoryIds) {
            const productCards = document.querySelectorAll('.product-card');
            let visibleCount = 0;
            
            productCards.forEach(card => {
                const productCategoryId = card.getAttribute('data-category-id');
                let shouldShow = false;
                
                // Check if product's category ID is in the allowed list
                if (categoryIds && categoryIds.length > 0) {
                    shouldShow = categoryIds.includes(productCategoryId);
                } else {
                    // If no categories specified, show all
                    shouldShow = true;
                }
                
                if (shouldShow) {
                    card.closest('.col-lg-3').style.display = 'block';
                    visibleCount++;
                } else {
                    card.closest('.col-lg-3').style.display = 'none';
                }
            });
            
            // Update product count
            const productCountBadge = document.getElementById('productCount');
            if (productCountBadge) {
                productCountBadge.textContent = visibleCount;
            }
        }

        // Subcategory filtering function
        function filterBySubcategory(subcategoryName) {
            const productCards = document.querySelectorAll('.product-card');
            let visibleCount = 0;
            
            productCards.forEach(card => {
                const productName = card.querySelector('.card-title').textContent.toLowerCase();
                const productDescription = card.querySelector('.card-text').textContent.toLowerCase();
                const productText = productName + ' ' + productDescription;
                
                let shouldShow = false;
                
                if (!subcategoryName) {
                    // Show all products
                    shouldShow = true;
                } else {
                    // Filter based on subcategory
                    switch(subcategoryName) {
                        case 'monitors':
                            // Only monitors - be very specific
                            shouldShow = (productText.includes('monitor') || productText.includes('display') || productText.includes('screen')) 
                                        && !productText.includes('keyboard') && !productText.includes('mouse') && !productText.includes('ssd') && !productText.includes('hdd') && !productText.includes('ram');
                            break;
                        case 'gaming_accessories':
                            // Gaming accessories but exclude monitors
                            shouldShow = (productText.includes('gaming') || productText.includes('gamer') || productText.includes('rgb') || productText.includes('mechanical')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen');
                            break;
                        case 'storage':
                            // Only storage products - be very specific
                            shouldShow = (productText.includes('ssd') || productText.includes('hdd') || productText.includes('storage') || productText.includes('drive') || productText.includes('nvme') || productText.includes('ram') || productText.includes('memory')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen') && !productText.includes('keyboard') && !productText.includes('mouse');
                            break;
                        case 'peripherals':
                            // Only peripherals - be very specific
                            shouldShow = (productText.includes('keyboard') || productText.includes('mouse') || productText.includes('webcam') || productText.includes('headset') || productText.includes('microphone')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen') && !productText.includes('ssd') && !productText.includes('hdd') && !productText.includes('ram');
                            break;
                        case 'cables_adapters':
                            // Only cables and adapters - be very specific
                            shouldShow = (productText.includes('cable') || productText.includes('adapter') || productText.includes('charger') || productText.includes('usb') || productText.includes('hdmi') || productText.includes('vga')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen') && !productText.includes('keyboard') && !productText.includes('mouse');
                            break;
                        // New sub-subcategories - be very specific
                        case 'ssds':
                            shouldShow = (productText.includes('ssd') || productText.includes('solid state') || productText.includes('nvme') || productText.includes('m.2')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen');
                            break;
                        case 'hdds':
                            shouldShow = (productText.includes('hdd') || productText.includes('hard drive') || productText.includes('mechanical drive')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen');
                            break;
                        case 'ram':
                            shouldShow = (productText.includes('ram') || productText.includes('memory') || productText.includes('ddr4') || productText.includes('ddr5')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen');
                            break;
                        case 'keyboards':
                            shouldShow = (productText.includes('keyboard') || productText.includes('mechanical') || productText.includes('switch')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen');
                            break;
                        case 'mice':
                            shouldShow = (productText.includes('mouse') || productText.includes('gaming mouse') || productText.includes('wireless mouse')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen');
                            break;
                        case 'webcams':
                            shouldShow = (productText.includes('webcam') || productText.includes('camera') || productText.includes('web cam')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen');
                            break;
                        case 'audio':
                            // Audio products but exclude monitors with speakers
                            shouldShow = (productText.includes('headset') || productText.includes('headphone') || productText.includes('microphone') || productText.includes('audio')) 
                                        && !productText.includes('monitor') && !productText.includes('display') && !productText.includes('screen');
                            break;
                    }
                }
                
                if (shouldShow) {
                    card.closest('.col-lg-3').style.display = 'block';
                    visibleCount++;
                } else {
                    card.closest('.col-lg-3').style.display = 'none';
                }
            });
            
            // Update product count
            const productCountBadge = document.getElementById('productCount');
            if (productCountBadge) {
                productCountBadge.textContent = visibleCount;
            }
        }

        // Initialize product count on page load
        document.addEventListener('DOMContentLoaded', function() {
            const productCountBadge = document.getElementById('productCount');
            if (productCountBadge) {
                const totalProducts = document.querySelectorAll('.product-card').length;
                productCountBadge.textContent = totalProducts;
            }
        });

        // Sort and Category Filtering
        document.addEventListener('DOMContentLoaded', function() {
            const priceSort = document.getElementById('priceSort');
            const categoryFilter = document.getElementById('categoryFilter');

            if (!priceSort) {
                console.log('Sort element not found');
                return;
            }

            // Function to apply filters automatically
            function applyFilters() {
                const sortValue = priceSort.value;
                const categoryValue = categoryFilter ? categoryFilter.value : '';
                
                // Update URL with parameters
                const url = new URL(window.location);
                
                if (sortValue) {
                    url.searchParams.set('sort', sortValue);
                } else {
                    url.searchParams.delete('sort');
                }
                
                if (categoryValue) {
                    url.searchParams.set('category', categoryValue);
                } else {
                    url.searchParams.delete('category');
                }
                
                // Check if we're on a brand page (has brand_categories)
                const isBrandPage = document.querySelector('#categoryFilter') !== null;
                
                if (isBrandPage) {
                    // Use AJAX for brand pages
                    fetch(url.toString())
                        .then(response => response.text())
                        .then(html => {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = html;
                            
                            const newProductsSection = tempDiv.querySelector('.row.g-4');
                            
                            if (newProductsSection) {
                                const currentProductsSection = document.querySelector('.row.g-4');
                                if (currentProductsSection) {
                                    currentProductsSection.innerHTML = newProductsSection.innerHTML;
                                }
                                
                                // Update product count - get the actual count from the products
                                const productCards = document.querySelectorAll('.product-card');
                                const actualCount = productCards.length;
                                
                                const currentProductCount = document.querySelector('#productCount');
                                if (currentProductCount) {
                                    currentProductCount.textContent = actualCount;
                                }
                                
                                window.history.pushState({}, '', url.toString());
                                console.log(`Brand filters applied via AJAX: ${actualCount} products found`);
                            } else {
                                window.location.href = url.toString();
                            }
                        })
                        .catch(error => {
                            console.error('AJAX error:', error);
                            window.location.href = url.toString();
                        });
                } else {
                    // Use client-side filtering for category pages
                    const productContainers = document.querySelectorAll('.col-lg-3');
                    
                    if (productContainers.length > 0) {
                        window.history.pushState({}, '', url.toString());
                        filterAndSortProducts(sortValue, categoryValue);
                    } else {
                        console.log('No products found, using server-side filtering');
                        window.location.href = url.toString();
                    }
                }
            }

            // Function to filter and sort products on client side
            function filterAndSortProducts(sortValue, categoryValue) {
                // Get the column containers (col-lg-3) which contain the product cards
                const productContainers = document.querySelectorAll('.col-lg-3');
                console.log('Found product containers:', productContainers.length);
                
                let visibleProducts = [];

                // Filter and collect products
                productContainers.forEach(container => {
                    const productCard = container.querySelector('.product-card');
                    if (!productCard) return;
                    
                    // Check category filter
                    let showProduct = true;
                    if (categoryValue) {
                        const productName = productCard.querySelector('.card-title')?.textContent.toLowerCase() || '';
                        const productDescription = productCard.querySelector('.card-text')?.textContent.toLowerCase() || '';
                        const productText = productName + ' ' + productDescription;
                        
                        // Check if product matches category
                        const categoryKeywords = {
                            'laptops': ['laptop', 'notebook', 'gaming laptop'],
                            'desktops': ['desktop', 'pc', 'tower', 'computer'],
                            'monitors': ['monitor', 'display', 'screen'],
                            'keyboards': ['keyboard', 'mechanical keyboard'],
                            'mice': ['mouse', 'gaming mouse', 'wireless mouse'],
                            'headsets': ['headset', 'headphone', 'gaming headset'],
                            'accessories': ['accessory', 'cable', 'adapter', 'stand']
                        };
                        
                        const keywords = categoryKeywords[categoryValue] || [];
                        showProduct = keywords.some(keyword => productText.includes(keyword));
                    }
                    
                    if (showProduct) {
                        // Find price element - try multiple selectors
                        let priceElement = productCard.querySelector('.text-primary.h5');
                        if (!priceElement) {
                            priceElement = productCard.querySelector('[class*="price"]');
                        }
                        if (!priceElement) {
                            priceElement = productCard.querySelector('h5');
                        }
                        if (!priceElement) {
                            priceElement = productCard.querySelector('h4');
                        }
                        
                        let price = 0;
                        if (priceElement) {
                            const priceText = priceElement.textContent.replace(/[$,]/g, '');
                            price = parseFloat(priceText) || 0;
                        }
                        
                        container.style.display = 'block';
                        visibleProducts.push({ container, price });
                    } else {
                        container.style.display = 'none';
                    }
                });

                // Sort if needed
                if (sortValue === 'low_to_high') {
                    visibleProducts.sort((a, b) => a.price - b.price);
                } else if (sortValue === 'high_to_low') {
                    visibleProducts.sort((a, b) => b.price - a.price);
                }

                // Reorder products in DOM
                const productsContainer = document.querySelector('.col-lg-10 .row');
                if (productsContainer && (sortValue === 'low_to_high' || sortValue === 'high_to_low')) {
                    visibleProducts.forEach(({ container }) => {
                        productsContainer.appendChild(container);
                    });
                }

                // Update product count
                const productCountBadge = document.getElementById('productCount');
                if (productCountBadge) {
                    productCountBadge.textContent = visibleProducts.length;
                }

                console.log('Products filtered and sorted:', visibleProducts.length);
            }

            // Auto-apply filters when dropdowns change
            priceSort.addEventListener('change', function() {
                applyFilters();
            });

            if (categoryFilter) {
                categoryFilter.addEventListener('change', function() {
                    applyFilters();
                });
            }

            // Load filters from URL
            loadFiltersFromURL();
        });

        function loadFiltersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const sortValue = urlParams.get('sort');
            const categoryValue = urlParams.get('category');
            
            if (sortValue) {
                document.getElementById('priceSort').value = sortValue;
            }
            
            if (categoryValue) {
                const categoryFilter = document.getElementById('categoryFilter');
                if (categoryFilter) {
                    categoryFilter.value = categoryValue;
                }
            }
        }

        // Handle brand category changes with AJAX
        function handleBrandCategoryChange(categoryName) {
            const url = new URL(window.location);
            
            if (categoryName) {
                url.searchParams.set('category', categoryName);
            } else {
                url.searchParams.delete('category');
            }
            
            // Use AJAX to load filtered products
            fetch(url.toString())
                .then(response => response.text())
                .then(html => {
                    // Create a temporary DOM element to parse the response
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Extract the products section
                    const newProductsSection = tempDiv.querySelector('.row.g-4');
                    const newProductCount = tempDiv.querySelector('#productCount');
                    
                    if (newProductsSection) {
                        // Replace the products section
                        const currentProductsSection = document.querySelector('.row.g-4');
                        if (currentProductsSection) {
                            currentProductsSection.innerHTML = newProductsSection.innerHTML;
                        }
                        
                        // Update product count - get the actual count from the products
                        const productCards = document.querySelectorAll('.product-card');
                        const actualCount = productCards.length;
                        
                        const currentProductCount = document.querySelector('#productCount');
                        if (currentProductCount) {
                            currentProductCount.textContent = actualCount;
                        }
                        
                        // Update URL without reloading
                        window.history.pushState({}, '', url.toString());
                        
                        console.log(`Products filtered via AJAX: ${actualCount} products found`);
                    } else {
                        // Fallback to page reload if AJAX fails
                        window.location.href = url.toString();
                    }
                })
                .catch(error => {
                    console.error('AJAX error:', error);
                    // Fallback to page reload
                    window.location.href = url.toString();
                });
        }


    

document.addEventListener('DOMContentLoaded', () => {
  const navToggle = document.querySelector('.nav-toggle');
  const nav = document.querySelector('nav');
  const searchContainer = document.querySelector('.search-container');
  const searchIcon = document.querySelector('.search-icon');
  const searchInput = document.querySelector('.search-input');

  // Toggle nav menu on hamburger click
  navToggle.addEventListener('click', () => {
    const expanded = nav.classList.toggle('nav-open');
    navToggle.setAttribute('aria-expanded', expanded);
  });

  // Toggle search input on search icon click
  searchIcon.addEventListener('click', () => {
    searchContainer.classList.toggle('active');
    if (searchContainer.classList.contains('active')) {
      searchInput.focus();
    } else {
      searchInput.value = '';
    }
  });

  // Close nav or search if clicked outside
  document.addEventListener('click', (e) => {
    if (
      !nav.contains(e.target) &&
      !navToggle.contains(e.target)
    ) {
      nav.classList.remove('nav-open');
      navToggle.setAttribute('aria-expanded', false);
    }
    if (
      !searchContainer.contains(e.target)
    ) {
      searchContainer.classList.remove('active');
      searchInput.value = '';
    }
  });
});
    </script>

    <style>
        /* Custom dropdown styling to match navigation bar */
        .custom-dropdown {
            background-color: #333 !important;
            border: 1px solid #555 !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
        }

        .custom-dropdown .dropdown-item {
            color: white !important;
            transition: all 0.3s ease;
            border-radius: 5px;
            margin: 2px 5px;
        }

        .custom-dropdown .dropdown-item:hover {
            background-color: #555 !important;
            color: white !important;
            transform: translateX(5px);
        }

        .custom-dropdown .dropdown-item.text-danger {
            color: #ff6b6b !important;
        }

        .custom-dropdown .dropdown-item.text-danger:hover {
            background-color: #721c24 !important;
            color: white !important;
        }

        .custom-dropdown .dropdown-divider {
            border-color: #555 !important;
            margin: 0.5rem 0;
        }

        /* Subcategory Card Styles */
        .subcategory-card {
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .subcategory-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #007bff;
        }

        .subcategory-icon {
            transition: transform 0.3s ease;
        }

        .subcategory-card:hover .subcategory-icon {
            transform: scale(1.1);
        }

        .product-count-badge {
            margin-top: 15px;
        }

        .product-count-badge .badge {
            font-size: 0.9rem;
            padding: 8px 12px;
        }

        /* Sidebar Filter Styles */
        .filters-sidebar {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .filters-sidebar .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        /* Dual Range Slider Styles */
        .dual-range-container {
            position: relative;
        }

        .price-range-slider {
            position: relative;
            margin: 20px 0;
        }

        .slider-track {
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            position: relative;
        }

        .slider-range {
            height: 100%;
            background: #ff6b35;
            border-radius: 3px;
            position: absolute;
            left: 0%;
            width: 100%;
        }

        .range-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
            pointer-events: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            pointer-events: all;
            border: 2px solid #ff6b35;
        }

        .range-input::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #ff6b35;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            pointer-events: all;
        }

        .range-input::-webkit-slider-track {
            background: transparent;
        }

        .range-input::-moz-range-track {
            background: transparent;
        }

        .price-label-min,
        .price-label-max {
            position: absolute;
            top: -40px;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .price-label-min {
            left: 0%;
            transform: translateX(-50%);
        }

        .price-label-max {
            left: 100%;
            transform: translateX(-50%);
        }

        .price-inputs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .price-input-group {
            flex: 1;
        }

        .price-input-group .input-group {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .price-input-group .input-group-text {
            background: #f8f9fa;
            border: none;
            color: #666;
            font-weight: 600;
        }

        .price-input-group .form-control {
            border: none;
            text-align: center;
            font-weight: 600;
        }

        .price-input-group .form-control:focus {
            box-shadow: none;
            border-color: #007bff;
        }

        .filter-actions .btn {
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filters-sidebar {
                margin-bottom: 20px;
            }
            
            .price-inputs {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Subcategory Filter Styles */
        .subcategory-filter {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }

        .subcategory-filter .form-select {
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 10px 15px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .subcategory-filter .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .filter-info {
            text-align: right;
        }

        .filter-info .badge {
            font-size: 1rem;
            padding: 8px 16px;
        }

        /* Dropdown container styling */
        nav ul li .dropdown {
            text-align: left;
        }

        /* Main dropdown styling */
        nav ul li .dropdown li a {
            display: block;
            padding: 12px 20px 12px 25px;
            color: white;
            font-size: 16px;
            transition: background-color 0.3s;
            text-decoration: none;
            text-align: left;
        }

        nav ul li .dropdown li a:hover, nav ul li .dropdown li a:focus {
            background-color: #444;
            color: #fff;
        }

        /* Multi-level dropdown styling */
        .dropdown li {
            position: relative;
        }

        .dropdown .sub-dropdown {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background-color: #333;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            min-width: 200px;
            padding: 15px 0;
            animation: slideRight 0.3s ease-in-out;
        }

        .dropdown li:hover .sub-dropdown {
            display: block;
        }

        .dropdown .sub-dropdown li a {
            padding: 10px 20px 10px 25px;
            font-size: 14px;
            color: #ccc;
            text-align: left;
        }

        .dropdown .sub-dropdown li a:hover {
            background-color: #444;
            color: #fff;
        }

        @keyframes slideRight {
            0% { opacity: 0; transform: translateX(-10px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        .dropdown li.has-submenu > a::after {
            content: " ▼";
            float: right;
            font-size: 12px;
            color: #666;
        }
        

    </style>

    <script>
        // Load categories dynamically for navigation
        document.addEventListener('DOMContentLoaded', function() {
            loadNavigationCategories();
        });

        async function loadNavigationCategories() {
            try {
                const response = await fetch('/api/navigation/categories');
                const data = await response.json();
                
                if (data.success && data.categories) {
                    populateCategoriesDropdown(data.categories);
                }
            } catch (error) {
                console.error('Error loading navigation categories:', error);
            }
        }

        function populateCategoriesDropdown(categories) {
            const dropdown = document.getElementById('categories-dropdown');
            if (!dropdown) return;

            dropdown.innerHTML = '';

            categories.forEach(category => {
                const li = document.createElement('li');
                
                if (category.children && category.children.length > 0) {
                    // Category with subcategories
                    li.className = 'has-submenu';
                    li.innerHTML = `
                        <a href="/products/category/${category.id}">${category.name}</a>
                        <ul class="sub-dropdown">
                            ${category.children.map(child => 
                                `<li><a href="/products/category/${child.id}">${child.name}</a></li>`
                            ).join('')}
                        </ul>
                    `;
                } else {
                    // Category without subcategories
                    li.innerHTML = `<a href="/products/category/${category.id}">${category.name}</a>`;
                }
                
                dropdown.appendChild(li);
            });

        }

        // Customer Account Modal Functions
        function showCustomerAccountModal() {
            const modal = document.getElementById('customerAccountModal');
            if (modal) {
                modal.style.display = 'block';
                loadCustomerData();
            }
        }

        function closeCustomerAccountModal() {
            const modal = document.getElementById('customerAccountModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function loadCustomerData() {
            try {
                const response = await fetch('/api/customer/profile');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('editUsername').value = data.customer.username || '';
                        document.getElementById('editEmail').value = data.customer.email || '';
                        document.getElementById('editPhone').value = data.customer.phone || '';
                    }
                }
            } catch (error) {
                console.error('Error loading customer data:', error);
            }
        }

        async function updateCustomerProfile() {
            const formData = {
                username: document.getElementById('editUsername').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value
            };

            try {
                const response = await fetch('/api/customer/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('Profile updated successfully!');
                    closeCustomerAccountModal();
                } else {
                    alert('Error updating profile: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        }
    </script>

    <!-- Customer Account Modification Modal -->
    <div id="customerAccountModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-user-edit"></i> Modify Your Account</h2>
          <span class="close" onclick="closeCustomerAccountModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="customerAccountForm">
            <div class="form-group">
              <label for="editUsername">Username *</label>
              <input type="text" id="editUsername" name="username" required>
            </div>
            <div class="form-group">
              <label for="editEmail">Email *</label>
              <input type="email" id="editEmail" name="email" required>
            </div>
            <div class="form-group">
              <label for="editPhone">Phone Number</label>
              <input type="tel" id="editPhone" name="phone" placeholder="Optional">
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeCustomerAccountModal()">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="updateCustomerProfile()">Update Profile</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <style>
      /* Customer Account Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        background: #333;
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }

      .close:hover {
        color: #fff;
      }

      .modal-body {
        padding: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
        box-sizing: border-box;
      }

      .form-group input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }

      .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e1e5e9;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-1px);
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background-color: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
              }

      /* Stock Badge Styles */
      .product-card .stock-badge {
          position: absolute;
          top: 10px;
          left: 10px;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 0.75rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          z-index: 5;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .product-card .stock-badge.in-stock {
          background: linear-gradient(135deg, #28a745, #20c997);
          color: white;
      }

      .product-card .stock-badge.low-stock {
          background: linear-gradient(135deg, #ffc107, #fd7e14);
          color: white;
      }

      .product-card .stock-badge.out-of-stock {
          background: linear-gradient(135deg, #dc3545, #c82333);
          color: white;
      }
    </style>


</body>
</html>
